!function(){const e=require("gulp"),s=require("del"),r=require("gulp-load-plugins")(),t=require("path"),a=require("fs-extra"),i=require("strip-json-comments"),n=require("gulp-strip-comments"),p=require("single-line-log").stdout,{program:c}=require("commander");c.option("--scope <type>","运行目录",process.cwd()),c.parse(process.argv);const o=c.scope,u=require(t.resolve(o,"./projectToSubPackageConfig"));process.on("unhandledRejection",(e,s)=>{});let l="dev";"production"===process.env.NODE_ENV&&(l="build");const f="dist/"+l+"/mp-weixin",w="dist/"+l+"/mp-weixin-pack",g=t.resolve(o,f),m=t.resolve(o,w,u.subPackagePath),h=t.resolve(o,w);let d;function x(e){p(e),clearTimeout(d),d=setTimeout(()=>{p("解耦构建，正在监听中......(此过程如果出现权限问题，请使用管理员权限运行)")},300)}async function k(e){return new Promise(async s=>{setTimeout(async()=>{s(await e())},100)})}function y(e){return Array(e).fill("../").join("")}function v(e){return e.split(/[\\/]/).length-1}function b(){return r.replace(/__uniRequireWx\(([a-zA-Z.\/"'@\d]+)\)/g,(function(e,s,r,t){let a=v(this.file.relative);return console.log(`\n编译${e}--\x3erequire(${s.replace(/@wxResource\//g,y(a))})`),`require(${s.replace(/@wxResource\//g,y(a))})`}),{skipBinary:!1})}function _(e){return x("处理app.json......"),r.replace(/[\s\S]+/,(function(s){let r,n,p,c={};({pagesJson(){try{r=JSON.parse(i(s))}catch(e){r={}}},baseAppJson(){try{n=JSON.parse(s)}catch(e){n={}}},mainAppJson(){try{p=JSON.parse(s)}catch(e){p={}}}})[e]();try{r||(r=JSON.parse(i(a.readFileSync(t.resolve(o,"src/pages.json"),"utf8"))))}catch(e){r={}}try{n||(n=JSON.parse(a.readFileSync(t.resolve(o,f+"/app.json"),"utf8")))}catch(e){n={}}try{p||(p=JSON.parse(a.readFileSync(t.resolve(o,u.mainWeixinMpPath+"/app.json"),"utf8")))}catch(e){p={}}function l(e){return u.subPackagePath+"/"+e}if(p.subPackages){let e=p.subPackages.find(e=>e.root===u.subPackagePath);if(e){let s=[...r.wxResource&&r.wxResource.pages||[],...n.pages||[]];return n.subPackages&&n.subPackages.forEach(e=>{s=[...s,...(e.pages||[]).map(s=>e.root+"/"+s)]}),r.wxResource&&r.wxResource.subPackages&&r.wxResource.subPackages.forEach(e=>{s=[...s,...(e.pages||[]).map(s=>e.root+"/"+s)]}),e.pages=s,delete n.pages,delete n.subPackages,JSON.stringify({...n,...p},null,2)}}n.pages&&n.pages.forEach((e,s)=>{n.pages[s]=l(e)}),n.subPackages&&n.subPackages.forEach(e=>{e.root=l(e.root)}),r.wxResource&&(r.wxResource.pages&&r.wxResource.pages.forEach((e,s)=>{r.wxResource.pages[s]=l(e)}),r.wxResource.subPackages&&r.wxResource.subPackages.forEach(e=>{e.root=l(e.root)})),n.tabBar&&n.tabBar.list&&n.tabBar.list.forEach(({pagePath:e,iconPath:s,selectedIconPath:r,...t},a)=>{n.tabBar.list[a]={pagePath:e?l(e):"",iconPath:s?l(s):"",selectedIconPath:r?l(r):"",...t}}),c={...n,...p},c.pages=Array.from(new Set([...r.indexPage?[l(r.indexPage)]:[],...p.pages||[],...n.pages||[],...r.wxResource&&r.wxResource.pages||[]]));let w=[],g={};function m(e){e.forEach(e=>{g[e.root]?g[e.root]=Array.from(new Set([...g[e.root],...e.pages])):g[e.root]=e.pages})}m(r.wxResource&&r.wxResource.subPackages||[]),m(n.subPackages||[]),m(p.subPackages||[]);for(let e in g)w.push({root:e,pages:g[e]});if(c.subPackages=[...w],n.usingComponents){for(let e in n.usingComponents)n.usingComponents[e]="/"+u.subPackagePath+n.usingComponents[e];c.usingComponents={...c.usingComponents||{},...n.usingComponents}}return JSON.stringify(c,null,2)}),{skipBinary:!1})}e.task("clean:base",(async function e(r){try{await s([g+"/**/*"],{force:!0})}catch(s){return void await k(async()=>{await e(r)})}r()})),e.task("clean:subModePath",(async function e(r){try{await s([m+"/**/*"],{force:!0})}catch(s){return void await k(async()=>{await e(r)})}r()})),e.task("clean:previewDist",(async function e(r){try{await s([h+"/**/*"],{force:!0})}catch(s){return void await k(async()=>{await e(r)})}r()})),e.task("watch:pagesJson",(function(){return e.src("src/pages.json",{allowEmpty:!0,cwd:o}).pipe(r.if("dev"===l,r.watch("src/pages.json",{cwd:o},(function(e){x("处理"+e.relative+"......")})))).pipe(_("pagesJson")).pipe(r.rename("app.json")).pipe(e.dest(w,{cwd:o}))})),e.task("watch:baseAppJson",(function(){return e.src(f+"/app.json",{allowEmpty:!0,cwd:o}).pipe(r.if("dev"===l,r.watch(f+"/app.json",{cwd:o},(function(e){x("处理"+e.relative+"......")})))).pipe(_("baseAppJson")).pipe(e.dest(w,{cwd:o}))})),e.task("watch:mainAppJson",(function(){let s=u.mainWeixinMpPath;return e.src(s+"/app.json",{allowEmpty:!0,cwd:o}).pipe(r.if("dev"===l,r.watch(s+"/app.json",{cwd:o},(function(e){x("处理"+e.relative+"......")})))).pipe(_("mainAppJson")).pipe(e.dest(w,{cwd:o}))})),e.task("watch:mainWeixinMp",(function(){let a=u.mainWeixinMpPath,i=a+"/"+u.subPackagePath,n=r.filter([a+"/app.js"],{restore:!0});return e.src([a+"/**/*","!"+a+"/app.json","!"+a+"/**/*.json___jb_tmp___","!"+a+"/**/*.wxml___jb_tmp___","!"+a+"/**/*.wxss___jb_tmp___","!"+a+"/**/*.js___jb_tmp___","!"+i+"/**/*"],{base:t.resolve(o,a),allowEmpty:!0,cwd:o}).pipe(r.if("dev"===l,r.watch([a+"/**/*","!/"+a+"/app.json","!/"+i+"/**/*"],{cwd:o},(function(e){x("处理"+e.relative+"......")})))).pipe(r.filter((async function(e){if("unlink"===e.event){try{await s([e.path.replace(t.resolve(o,a),t.resolve(o,w))],{force:!0})}catch(e){}return!1}return!0}))).pipe(n).pipe(r.replace(/^/,(function(e){return`require('${`./${u.subPackagePath}/`}app.js');\n`}),{skipBinary:!1})).pipe(n.restore).pipe(e.dest(w,{cwd:o}))})),e.task("subMode:createUniSubPackage",(async function(i){await a.mkdirs(g);let p=r.filter([f+"/common/vendor.js",f+"/common/main.js",f+"/common/runtime.js",f+"/pages/**/*.js"],{restore:!0}),c=r.filter([f+"/common/vendor.js"],{restore:!0}),w=r.filter([f+"/**/*.js","!"+f+"/app.js","!"+f+"/common/vendor.js","!"+f+"/common/main.js","!"+f+"/common/runtime.js"],{restore:!0}),h=r.filter([f+"/**/*.wxss","!"+f+"/app.wxss","!"+f+"/common/main.wxss"],{restore:!0}),d=r.filter([f+"/**/*.json"],{restore:!0});return e.src([f+"/**","!"+f+"/*.*",f+"/app.js",f+"/app.wxss"],{allowEmpty:!0,cwd:o}).pipe(r.if("dev"===l,r.watch([f+"/**/*","!/"+f+"/*.json"],{cwd:o},(function(e){x("处理"+e.relative+"......")})))).pipe(r.filter((async function(e){if("unlink"===e.event){try{await s([e.path.replace(g,t.resolve(o,m))],{force:!0})}catch(e){}return!1}return!0}))).pipe(c).pipe(r.replace(/^/,`if(!wx.__uniapp2wxpack)wx.__uniapp2wxpack={};let packObject=wx.__uniapp2wxpack.${u.subPackagePath}={};let App=function(packInit){packObject.__packInit=packInit};`,{skipBinary:!1})).pipe(c.restore).pipe(p).pipe(n()).pipe(b()).pipe(p.restore).pipe(w).pipe(r.replace(/^/,(function(e){if(a.existsSync(t.resolve(o,"src",this.file.relative)))return e;return`require('${y(v(this.file.relative))}app.js');\n`}),{skipBinary:!1})).pipe(w.restore).pipe(d).pipe(r.replace(/[\s\S]*/,(function(e){if(!a.existsSync(t.resolve(o,"src",this.file.relative.replace(/json$/,"vue")))&&!a.existsSync(t.resolve(o,"src",this.file.relative.replace(/json$/,"nvue"))))return e;let s=JSON.parse(this.file.contents.toString());for(let e in s.usingComponents)0===s.usingComponents[e].indexOf("/")&&(s.usingComponents[e]=y(v(this.file.relative))+s.usingComponents[e].replace(/^\//,""));return JSON.stringify(s)}),{skipBinary:!1})).pipe(d.restore).pipe(h).pipe(n.text()).pipe(r.replace(/(}|^|\s|;)__uniWxss\s*{([^{}]+)}/g,(function(e,s,r){let t="",a=v(this.file.relative);return(r+";").replace(/\s*import\s*:\s*(('[^\s']*')|("[^\s']*"))/g,(function(e,s){t+=`@import ${s.replace(/@wxResource\//g,y(a))};\n`})),s+t}),{skipBinary:!1})).pipe(r.replace(/^[\s\S]*$/,(function(e){let s=v(this.file.relative);return`@import ${'"@wxResource/app.wxss";'.replace(/@wxResource\//g,y(s))}`+`\n${e}`}),{skipBinary:!1})).pipe(h.restore).pipe(e.dest(m,{cwd:o}))})),e.task("subMode:copyWxResource",(function(){let a=r.filter(["src/wxresource/**/*.js"],{restore:!0}),i=r.filter(["src/wxresource/**/*.wxss"],{restore:!0});return e.src(["src/wxresource/**","src/wxresource"],{allowEmpty:!0,cwd:o}).pipe(r.if("dev"===l,r.watch(["src/wxresource/**","src/wxresource","!/src/wxresource/**/*.*___jb_tmp___"],{cwd:o},(function(e){x("处理"+e.relative+"......")})))).pipe(a).pipe(r.replace(/^/,(function(e){return`require('${y(v(this.file.relative))}app.js');\n`}),{skipBinary:!1})).pipe(n()).pipe(b()).pipe(a.restore).pipe(i).pipe(n.text()).pipe(r.replace(/(}|^|\s|;)__uniWxss\s*{([^{}]+)}/g,(function(e,s,r){let t="",a=v(this.file.relative);return(r+";").replace(/\s*import\s*:\s*(('[^\s']*')|("[^\s']*"))/g,(function(e,s){t+=`@import ${s.replace(/@wxResource\//g,y(a))};\n`})),s+t}),{skipBinary:!1})).pipe(r.replace(/^[\s\S]*$/,(function(e){let s=v(this.file.relative);return`@import ${'"@wxResource/app.wxss";'.replace(/@wxResource\//g,y(s))}`+`\n${e}`}),{skipBinary:!1})).pipe(i.restore).pipe(r.filter((async function(e){if("unlink"===e.event){try{await s([e.path.replace(t.resolve(o,"src/wxresource"),t.resolve(o,m))],{force:!0})}catch(e){}return!1}return!0}))).pipe(e.dest(m,{cwd:o}))})),e.task("mpWxSubMode",e.series((function(e){console.log("对uni-app进行解耦构建，解除uni-app对原生小程序方法的改写，此过程如果出现权限问题，请使用管理员权限运行"),e()}),"clean:previewDist",(async function e(s){try{await a.outputFile(m+"/pack.config.js",`module.exports={packPath:'/${u.subPackagePath}'}`)}catch(r){return void await k(async()=>{await e(s)})}s()}),function(){let s=["subMode:createUniSubPackage","subMode:copyWxResource","watch:baseAppJson","watch:pagesJson","watch:mainAppJson","watch:mainWeixinMp"];return"build"===l?e.series.apply(this,s):e.parallel.apply(this,s)}(),(function(e){e(),"build"===l&&process.exit()}))),e.task("startToPackServe",e.series((async function(e){await a.exists(g)||await a.mkdirs(g),e()}),"clean:base",(function(s){e.watch(f+"/app.json",{events:["all"],cwd:o},(function(){s()}))}),"mpWxSubMode"))}();