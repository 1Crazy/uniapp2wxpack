"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t=e(require("del")),n=e(require("gulp")),r=e(require("path")),a=e(require("commander")),s=e(require("single-line-log")),i=e(require("gulp-load-plugins")),o=e(require("htmlparser2")),p=e(require("parse5")),c=e(require("preprocess")),u=e(require("fs-extra")),l=e(require("strip-json-comments")),g=e(require("gulp-strip-comments"));const{program:f}=a;f.option("--scope <type>","运行目录",process.cwd()).option("--plugin","插件模式").option("--type <type>","解耦包类型(哪种小程序)","weixin"),f.parse(process.argv);const h={weixin:{html:"wxml",css:"wxss",globalObject:"wx",mainMpPath:"mainWeixinMpPath",directivePrefix:"wx:"},baidu:{html:"swan",css:"css",globalObject:"swan",mainMpPath:"mainBaiduMpPath",directivePrefix:"s-"},toutiao:{html:"ttml",css:"ttss",globalObject:"tt",mainMpPath:"mainToutiaoMpPath",directivePrefix:"tt:"}},d=h[f.type];if(!d)throw Error("小程序类型错");process.env.PACK_TYPE=f.type;const m=f.scope,P=function(){return require.apply(null,arguments)}(r.resolve(m,"./projectToSubPackageConfig")),b=P.wxResourcePath||`src/${d.globalObject}resource`,v=P.wxResourceAlias||"@wxResource",w=RegExp(v+"\\/","g"),y=P.uniRequireApiName||"__uniRequireWx",j=RegExp(y+"\\(([a-zA-Z.\\/\"'@\\d]+)\\)","g"),k=P.uniImportWxssApiName||"__uniWxss",x=RegExp(`(}|^|\\s|;)${k}\\s*{([^{}]+)}`,"g");let N="dev";"production"===process.env.NODE_ENV&&(N="build");const $="dist/"+N+"/mp-"+f.type;let S="dist/"+N+`/mp-${f.type}-pack`;f.plugin&&(S="dist/"+N+`/mp-${f.type}-pack-plugin`);var _={currentNamespace:d,program:f,cwd:m,projectToSubPackageConfig:P,wxResourcePath:b,wxResourceAlias:v,regExpWxResources:w,uniRequireApiName:y,regExpUniRequire:j,uniImportWxssApiName:k,regExpUniImportWxss:x,configWxResourceKey:P.configWxResourceKey||"wxResource",env:N,base:$,target:S,basePath:r.resolve(m,$),subModePath:r.resolve(m,S,P.subPackagePath),targetPath:r.resolve(m,S),packIsSubpackage:{mode:!1},mpTypeNamespace:h};let E;const O=s.stdout;var A={tryAgain:async function(e){return new Promise(async t=>{setTimeout(async()=>{t(await e())},100)})},getLevelPath:function(e){return Array(e).fill("../").join("")},getLevel:function(e){return e.split(/[\\/]/).length-1},writeLastLine:function(e){O(e),clearTimeout(E),E=setTimeout(()=>{O("解耦构建，正在监听中......(此过程如果出现权限问题，请使用管理员权限运行)")},300)},deepFind:function e(t,n,r,a){n&&(n(t,r,a),t.childNodes&&t.childNodes.forEach((t,r,a)=>{e(t,n,r,a)}))}};const{basePath:C}=_,{tryAgain:R}=A;n.task("clean:base",(async function e(n){try{await t([C+"/**/*"],{force:!0})}catch(t){return void await R(async()=>{await e(n)})}n()}));const{subModePath:T}=_,{tryAgain:L}=A;n.task("clean:subModePath",(async function e(n){try{await t([T+"/**/*"],{force:!0})}catch(t){return void await L(async()=>{await e(n)})}n()}));const{targetPath:M}=_,{tryAgain:q}=A;n.task("clean:previewDist",(async function e(n){try{await t([M+"/**/*"],{force:!0})}catch(t){return void await q(async()=>{await e(n)})}n()}));const{deepFind:J}=A,W=/^(wxs|sjs)$/i;var B=class{constructor(e){var t,n;this.topNode={childNodes:[]},this.currentNode=this.topNode,this.documentFragment=p.parseFragment(e),this.init(e),n=this.documentFragment,J(t=this.topNode,e=>{e.nodeName&&e.nodeName.match(W)&&(e.nodeName="#text",e.childNodes=[],e.value="")}),J(n,e=>{if(e.nodeName&&e.nodeName.match(W)){const{nodeName:n,attrs:r,childNodes:a}=e,s={};r.forEach(e=>{s[e.name]=e.value});const i={nodeName:n,attrs:s,parentNode:t};null!=a[0]&&"#text"===a[0].nodeName&&(i.childNodes=[{nodeName:"#text",value:a[0].value,parentNode:i}]),t.childNodes.unshift(i)}})}init(e){const t=new o.Parser({onopentag:(e,t)=>{this.appendElement({nodeName:e,attrs:t,childNodes:[]})},ontext:e=>{this.appendText({nodeName:"#text",value:e})},onclosetag:e=>{this.closeElement()}},{decodeEntities:!1,xmlMode:!0});t.write(e),t.end()}appendElement(e){e.parentNode=this.currentNode,this.currentNode.childNodes.push(e),this.currentNode=e}appendText(e){e.parentNode=this.currentNode,this.currentNode.childNodes.push(e)}closeElement(){this.currentNode=this.currentNode.parentNode||this.currentNode}render(e=this.topNode.childNodes,t=""){return e.reduce((e,t)=>{if(t.removed)return e;if("#text"===t.nodeName)return e+=this.writeText(t);const{nodeName:n,attrs:r,childNodes:a=[]}=t;return e+=this.writeOpenTag(n,r),e+=this.render(a),e+=this.writeCloseTag(n)},t)}writeOpenTag(e,t){return`<${e}${(t=Object.keys(t).map(e=>`${e}="${t[e]}"`)).length>0?" "+t.join(" "):""}>`}writeText(e){return e.value}writeCloseTag(e){return`</${e}>`}};const{currentNamespace:F,mpTypeNamespace:I}=_,{deepFind:U}=A,K=Object.keys(I).map(e=>I[e].directivePrefix),D=Object.keys(I).map(e=>I[e].html),Y=RegExp(`^(${K.join("|")})`),H=RegExp(`\\.(${D.join("|")})$`,"i");var z=function(e,t){if(t.relative.match(H)){const t=new B(e);return U(t.topNode,e=>{if(e.nodeName&&"#text"!==e.nodeName){if("toutiao"===process.env.PACK_TYPE&&"wxs"===e.nodeName)return e.nodeName="#text",void(e.value="");"toutiao"===process.env.PACK_TYPE&&e.attrs.class&&!e.attrs.class.match(/(^\s|(\s$))/)&&(e.attrs.class+=" "),"toutiao"===process.env.PACK_TYPE&&e.attrs.catchTap&&!e.attrs.bindTap&&(e.attrs.bindTap=e.attrs.catchTap,delete e.attrs.catchTap),e.nodeName.match(/^(include|import|wxs)$/)&&e.attrs.src&&(e.attrs.src=e.attrs.src.replace(H,"."+F.html)),Object.keys(e.attrs).forEach(t=>{if(t.match(Y)){const n=t.replace(Y,F.directivePrefix);e.attrs[n]=e.attrs[t],n!==t&&delete e.attrs[t]}})}}),t.render()}return e};const{currentNamespace:V,mpTypeNamespace:Z}=_,G=Object.keys(Z).map(e=>Z[e].css),Q=RegExp(`\\.(${G.join("|")})$`,"i");var X=function(e,t){return t.relative.match(Q)&&(e=e.replace(/@import\s+['"](\S+)['"]/g,(function(e,t){return`@import '${t.replace(Q,"."+V.css)}'`}))),e};var ee=function(e,{relative:t}){return"toutiao"===process.env.PACK_TYPE&&t.match(/^\/app.js$/i)?"\nif (!Promise.prototype.finally) {\n    Promise.prototype.finally = function (callback) {\n        let P = this.constructor;\n        return this.then(\n            value  => P.resolve(callback()).then(() => value),\n            reason => P.resolve(callback()).then(() => { throw reason })\n        );\n    };\n}\n;\n"+e:e};const{preprocess:te}=c;var ne=function(e,{relative:t}){if(t.match(/.js$/i))try{return te(e,process.env,{type:"js"})}catch(t){return console.log("js条件编译出错"),console.log(t),e}return e};const{currentNamespace:re}=_,{preprocess:ae}=c;var se=function(e,{relative:t}){if(t.match(RegExp(`.${re.css}$`,"i")))try{return ae(e,process.env,{type:"css"})}catch(t){return console.log(re.css+"条件编译出错"),console.log(t),e}return e};const{currentNamespace:ie}=_,{preprocess:oe}=c;var pe={htmlMixinPlugin:z,cssMixinPlugin:X,polyfillPlugin:ee,jsPreProcessPlugin:ne,cssPreProcessPlugin:se,htmlPreProcessPlugin:function(e,{relative:t}){if(t.match(RegExp(`.${ie.html}$`,"i")))try{return oe(e,process.env,{type:"html"})}catch(t){return console.log(ie.html+"条件编译出错"),console.log(t),e}return e}};const{projectToSubPackageConfig:ce,targetPath:ue}=_;(!ce.plugins||!ce.plugins instanceof Array)&&(ce.plugins=[]);var le={runPlugins:function(e){return function(t){const{plugins:n}=ce;if(!n||!n instanceof Array)return;const a=r.resolve(e,this.file.relative),s={relative:a.replace(RegExp("^"+ue.replace(/\\/g,"\\\\")),"").replace(/\\/g,"/"),absolute:a};return n.reduce((e,t)=>{if("string"==typeof t&&(t=pe[t]),"function"!=typeof t)return e;const n=t(e,s,pe);return null==n?e:n},t)}}};const ge=i(),{cwd:fe,projectToSubPackageConfig:he,target:de,env:me}=_,{writeLastLine:Pe}=A,{runPlugins:be}=le;n.task("watch:pluginJson",(function(){return n.src("src/plugin.json",{allowEmpty:!0,cwd:fe}).pipe(ge.if("dev"===me,ge.watch("src/plugin.json",{cwd:fe},(function(e){Pe("处理"+e.relative+"......")})))).pipe(ge.replace(/[\s\S]*/,be(r.resolve(fe,de+"/"+he.subPackagePath)))).pipe(n.dest(de+"/"+he.subPackagePath,{cwd:fe}))}));const ve=i(),{cwd:we,target:ye,env:je,targetPath:ke}=_,{writeLastLine:xe}=A,{runPlugins:Ne}=le;n.task("watch:projectConfigJson",(function(){return n.src("project.config.json",{allowEmpty:!0,cwd:we}).pipe(ve.if("dev"===je,ve.watch("project.config.json",{cwd:we},(function(e){xe("处理"+e.relative+"......")})))).pipe(ve.replace(/[\s\S]*/,Ne(ke))).pipe(n.dest(ye,{cwd:we}))}));const{program:$e,cwd:Se,projectToSubPackageConfig:_e,basePath:Ee,subModePath:Oe,targetPath:Ae,packIsSubpackage:Ce,currentNamespace:Re}=_;var Te=function(){if($e.plugin)return;const e=r.resolve(Se,_e[Re.mainMpPath]+"/app.js");if(u.existsSync(e)){const t=u.readFileSync(e,"utf8");let n=`require('${`./${_e.subPackagePath}/`}app.js');\n`;if(Oe===Ae){n=u.readFileSync(Ee+"/app.js","utf8")+";\n"}(Ce.mode||$e.plugin)&&(n=""),u.outputFileSync(Ae+"/app.js",n+t)}};const Le=i(),{program:Me,cwd:qe,projectToSubPackageConfig:Je,configWxResourceKey:We,base:Be,packIsSubpackage:Fe,currentNamespace:Ie}=_,{writeLastLine:Ue}=A;var Ke=function(e){return Ue("处理app.json......"),Le.replace(/[\s\S]+/,(function(t){if(Me.plugin&&"mainAppJson"===e)return t;Fe.mode=!1;let n,a,s,i={};({pagesJson(){try{n=JSON.parse(l(t))}catch(e){n={}}},baseAppJson(){try{a=JSON.parse(t)}catch(e){a={}}},mainAppJson(){try{s=JSON.parse(t)}catch(e){s={}}}})[e]();try{n||(n=JSON.parse(l(u.readFileSync(r.resolve(qe,"src/pages.json"),"utf8"))))}catch(e){n={}}try{a||(a=JSON.parse(u.readFileSync(r.resolve(qe,Be+"/app.json"),"utf8")))}catch(e){a={}}try{s||(s=JSON.parse(u.readFileSync(r.resolve(qe,Je[Ie.mainMpPath]+"/app.json"),"utf8")))}catch(e){s={}}function o(e){return Je.subPackagePath+(Je.subPackagePath?"/":"")+e}if(s.subPackages){let e=s.subPackages.find(e=>e.root===Je.subPackagePath);if(e){Fe.mode=!0;let t=[...n[We]&&n[We].pages||[],...a.pages||[]];return a.subPackages&&a.subPackages.forEach(e=>{t=[...t,...(e.pages||[]).map(t=>e.root+(e.root?"/":"")+t)]}),n[We]&&n[We].subPackages&&n[We].subPackages.forEach(e=>{t=[...t,...(e.pages||[]).map(t=>e.root+(e.root?"/":"")+t)]}),e.pages=t,Te(),delete a.pages,delete a.subPackages,JSON.stringify({...a,...s},null,2)}}a.pages&&a.pages.forEach((e,t)=>{a.pages[t]=o(e)}),a.subPackages&&a.subPackages.forEach(e=>{e.root=o(e.root)}),n[We]&&(n[We].pages&&n[We].pages.forEach((e,t)=>{n[We].pages[t]=o(e)}),n[We].subPackages&&n[We].subPackages.forEach(e=>{e.root=o(e.root)})),a.tabBar&&a.tabBar.list&&a.tabBar.list.forEach(({pagePath:e,iconPath:t,selectedIconPath:n,...r},s)=>{a.tabBar.list[s]={pagePath:e?o(e):"",iconPath:t?o(t):"",selectedIconPath:n?o(n):"",...r}}),i={...a,...s},i.pages=Array.from(new Set([...n.indexPage?[o(n.indexPage)]:[],...s.pages||[],...a.pages||[],...n[We]&&n[We].pages||[]]));let p=[],c={};function g(e){e.forEach(e=>{c[e.root]=c[e.root]?Array.from(new Set([...c[e.root],...e.pages])):e.pages})}g(n[We]&&n[We].subPackages||[]),g(a.subPackages||[]),g(s.subPackages||[]);for(let e in c)p.push({root:e,pages:c[e]});if(i.subPackages=[...p],a.usingComponents){for(let e in a.usingComponents)a.usingComponents[e]="/"+Je.subPackagePath+a.usingComponents[e];i.usingComponents={...i.usingComponents||{},...a.usingComponents}}return Te(),"toutiao"===Me.type&&i.subPackages&&(i.subPackages.forEach(e=>{e.pages.forEach(t=>{i.pages.push(e.root+"/"+t)})}),delete i.subPackages),JSON.stringify(i,null,2)}),{skipBinary:!1})};const De=i(),{cwd:Ye,target:He,env:ze,targetPath:Ve}=_,{writeLastLine:Ze}=A,{runPlugins:Ge}=le;n.task("watch:pagesJson",(function(){return n.src("src/pages.json",{allowEmpty:!0,cwd:Ye}).pipe(De.if("dev"===ze,De.watch("src/pages.json",{cwd:Ye},(function(e){Ze("处理"+e.relative+"......")})))).pipe(Ke("pagesJson")).pipe(De.rename("app.json")).pipe(De.replace(/[\s\S]*/,Ge(Ve))).pipe(n.dest(He,{cwd:Ye}))}));const Qe=i(),{cwd:Xe,target:et,env:tt,base:nt,targetPath:rt}=_,{writeLastLine:at}=A,{runPlugins:st}=le;n.task("watch:baseAppJson",(function(){return n.src(nt+"/app.json",{allowEmpty:!0,cwd:Xe}).pipe(Qe.if("dev"===tt,Qe.watch(nt+"/app.json",{cwd:Xe},(function(e){at("处理"+e.relative+"......")})))).pipe(Ke("baseAppJson")).pipe(Qe.replace(/[\s\S]*/,st(rt))).pipe(n.dest(et,{cwd:Xe}))}));const it=i(),{cwd:ot,target:pt,env:ct,projectToSubPackageConfig:ut,program:lt,currentNamespace:gt}=_,{writeLastLine:ft}=A,{runPlugins:ht}=le;n.task("watch:mainAppJson",(function(){let e=ut[gt.mainMpPath];return n.src(e+"/app.json",{allowEmpty:!0,cwd:ot}).pipe(it.if("dev"===ct,it.watch(e+"/app.json",{cwd:ot},(function(e){ft("处理"+e.relative+"......")})))).pipe(Ke("mainAppJson")).pipe(it.replace(/[\s\S]*/,ht(r.resolve(ot,pt+(lt.plugin?"/miniprogram":""))))).pipe(n.dest(pt+(lt.plugin?"/miniprogram":""),{cwd:ot}))}));const dt=i(),{cwd:mt,target:Pt,env:bt,projectToSubPackageConfig:vt,program:wt,basePath:yt,currentNamespace:jt,mpTypeNamespace:kt}=_,{writeLastLine:xt}=A,{runPlugins:Nt}=le;n.task("watch:topMode-mainAppJsAndAppWxss",(function(){let e=vt[jt.mainMpPath];const t=Object.keys(kt).map(t=>`${e}/app.${kt[t].css}`),a=dt.filter([...t],{restore:!0}),s=dt.filter([e+"/app.js"],{restore:!0});return n.src([e+"/app.js",...t],{allowEmpty:!0,cwd:mt}).pipe(dt.if("dev"===bt,dt.watch([e+"/app.js",`${e}/app.${jt.css}`],{cwd:mt},(function(e){xt("处理"+e.relative+"......")})))).pipe(s).pipe(dt.replace(/^/,(function(e){return u.readFileSync(yt+"/app.js","utf8")+";\n"}),{skipBinary:!1})).pipe(s.restore).pipe(a).pipe(dt.replace(/^/,(function(e){return u.readFileSync(`${yt}/app.${jt.css}`,"utf8")+"\n"}),{skipBinary:!1})).pipe(dt.rename((function(e){e.extname="."+jt.css}))).pipe(a.restore).pipe(dt.replace(/[\s\S]*/,Nt(r.resolve(mt,Pt+(wt.plugin?"/miniprogram":""))))).pipe(n.dest(Pt+(wt.plugin?"/miniprogram":""),{cwd:mt}))}));const{mpTypeNamespace:$t,currentNamespace:St}=_,_t=(process,new Set(Object.keys($t).map(e=>$t[e].globalObject)));var Et={mixinsEnvCode:function(e){let t="";return _t.forEach(e=>{St.globalObject!==e&&(t+=`var ${e} = ${St.globalObject};\n`)}),t}};const Ot=i(),{cwd:At,target:Ct,env:Rt,projectToSubPackageConfig:Tt,base:Lt,wxResourcePath:Mt,currentNamespace:qt,mpTypeNamespace:Jt}=_,{writeLastLine:Wt}=A,{mixinsEnvCode:Bt}=Et,{runPlugins:Ft}=le;n.task("watch:mainWeixinMpPackPath",(function(){const e=Tt[qt.mainMpPath],a=e+"/"+Tt.subPackagePath,s=Ct+"/"+Tt.subPackagePath,i=[],o=[];Object.keys(Jt).forEach(e=>{i.push(`${a}/**/*.${Jt[e].css}`),o.push(`${a}/**/*.${Jt[e].html}`)});const p=Ot.filter([...o],{restore:!0}),c=Ot.filter([...i],{restore:!0}),l=Ot.filter([a+"/**/*.js"],{restore:!0});return n.src([a,a+"/**/*","!"+a+"/pack.config.js"],{allowEmpty:!0,cwd:At}).pipe(Ot.if("dev"===Rt,Ot.watch([a,a+"/**/*","!/"+a+"/pack.config.js"],{cwd:At},(function(e){Wt("处理"+e.relative+"......")})))).pipe(Ot.filter((function(n){if(!function(e){const t=Tt[qt.mainMpPath]+"/"+Tt.subPackagePath;return!u.existsSync(e.path.replace(r.resolve(At,t),r.resolve(At,Lt)))&&!u.existsSync(e.path.replace(r.resolve(At,t),r.resolve(At,Mt)))}(n))return!1;if("unlink"===n.event){try{t.sync([n.path.replace(r.resolve(At,e),r.resolve(At,Ct))],{force:!0})}catch(e){}return!1}return!0}))).pipe(p).pipe(Ot.rename((function(e){e.extname="."+qt.html}))).pipe(p.restore).pipe(c).pipe(Ot.rename((function(e){e.extname="."+qt.css}))).pipe(c.restore).pipe(l).pipe(Ot.replace(/[\s\S]*/,(function(e){return Bt(e)+e}))).pipe(l.restore).pipe(Ot.replace(/[\s\S]*/,Ft(r.resolve(At,s)))).pipe(n.dest(s,{cwd:At}))}));const It=i(),{cwd:Ut,target:Kt,env:Dt,projectToSubPackageConfig:Yt,basePath:Ht,subModePath:zt,targetPath:Vt,program:Zt,packIsSubpackage:Gt,currentNamespace:Qt,mpTypeNamespace:Xt}=_,{writeLastLine:en}=A,{mixinsEnvCode:tn}=Et,{runPlugins:nn}=le;n.task("watch:mainWeixinMp",(function(){const e=Yt[Qt.mainMpPath],a=e+"/"+Yt.subPackagePath,s=[],i=[];Object.keys(Xt).forEach(t=>{s.push(`${e}/**/*.${Xt[t].css}`),i.push(`${e}/**/*.${Xt[t].html}`)});const o=It.filter([e+"/app.js"],{restore:!0}),p=It.filter([e+"/**/*.js"],{restore:!0}),c=It.filter([...i],{restore:!0}),u=It.filter([...s],{restore:!0});return n.src([e+"/**/*","!"+e+"/app.json","!"+e+"/**/*.json___jb_tmp___","!"+e+`/**/*.${Qt.html}___jb_tmp___`,"!"+e+`/**/*.${Qt.css}___jb_tmp___`,"!"+e+"/**/*.js___jb_tmp___","!"+a+"/**/*"],{base:r.resolve(Ut,e),allowEmpty:!0,cwd:Ut}).pipe(It.if("dev"===Dt,It.watch([e+"/**/*","!/"+e+"/app.json","!/"+a+"/**/*"],{cwd:Ut},(function(e){en("处理"+e.relative+"......")})))).pipe(It.filter((function(n){if("unlink"===n.event){try{t.sync([n.path.replace(r.resolve(Ut,e),r.resolve(Ut,Kt))],{force:!0})}catch(e){}return!1}return!0}))).pipe(p).pipe(It.replace(/[\s\S]*/,(function(e){return tn(e)+e}))).pipe(p.restore).pipe(o).pipe(It.replace(/^/,(function(e){if(Gt.mode||Zt.plugin)return"";let t=`./${Yt.subPackagePath}/`;if(zt===Vt){return fs.readFileSync(Ht+"/app.js","utf8")+";\n"}return`require('${t}app.js');\n`}),{skipBinary:!1})).pipe(o.restore).pipe(c).pipe(It.rename((function(e){e.extname="."+Qt.html}))).pipe(c.restore).pipe(u).pipe(It.rename((function(e){e.extname="."+Qt.css}))).pipe(u.restore).pipe(It.replace(/[\s\S]*/,nn(r.resolve(Ut,Kt+(Zt.plugin?"/miniprogram":""))))).pipe(n.dest(Kt+(Zt.plugin?"/miniprogram":""),{cwd:Ut}))}));var rn={fakeUniBootstrap:function(e,t,n,r){globalObject.__uniapp2wxpack||(globalObject.__uniapp2wxpack={platform:r});var a=globalObject.__uniapp2wxpack[t.replace("/","")]={__packInit:{}};if(e)for(var s in e)"function"!=typeof e[s]?a.__packInit[s]=e[s]:function(t){a.__packInit[t]=function(){return e[t].apply(e,arguments)}}(s);else e={};if("none"!==n){var i=Page,o=Component,p="",c=1,u=1;"function"==typeof e.onError&&globalObject.onError&&globalObject.onError((function(){return e.onError.apply(e,arguments)})),"function"==typeof e.onPageNotFound&&globalObject.onPageNotFound&&globalObject.onPageNotFound((function(){return e.onPageNotFound.apply(e,arguments)})),"function"==typeof e.onUnhandledRejection&&globalObject.onUnhandledRejection&&globalObject.onUnhandledRejection((function(){return e.onUnhandledRejection.apply(e,arguments)})),globalObject.onAppRoute((function(r){"top"!==n&&0!==("/"+r.path).indexOf(t+"/")&&(c=1,e.onHide.call(e,globalObject.getLaunchOptionsSync())),p=r.path})),globalObject.onAppHide((function(){if("top"===n)return e.onHide.call(e,globalObject.getLaunchOptionsSync());var r=getCurrentPages();return 0===("/"+(null==r[r.length-1].route?r[r.length-1].__route__:r[r.length-1].route)).indexOf(t+"/")?(c=1,p="",e.onHide.call(e,globalObject.getLaunchOptionsSync())):void 0})),globalObject.onAppShow((function(){"top"===n&&"function"==typeof e.onShow&&e.onShow.call(e,globalObject.getLaunchOptionsSync()),u&&getApp()&&(getApp().globalData||(getApp().globalData={}),Object.assign(getApp().globalData,e.globalData||{})),u=0})),"top"===n&&u&&"function"==typeof e.onLaunch&&e.onLaunch.call(e,globalObject.getLaunchOptionsSync()),Page=function(e){return l(e),i.call(this,e)},Component=function(e){return l(e.methods||{}),o.call(this,e)}}function l(r){if("top"!==n){var a=r.onShow;"function"!=typeof e.onShow&&"function"!=typeof e.onLaunch||(r.onShow=function(){var n=getCurrentPages(),r=null==n[n.length-1].route?n[n.length-1].__route__:n[n.length-1].route;if(p&&0===("/"+p).indexOf(t+"/")||0!==("/"+r).indexOf(t+"/")||(c&&(c=0,e.onLaunch.call(e,globalObject.getLaunchOptionsSync())),e.onShow.call(e,globalObject.getLaunchOptionsSync())),"function"==typeof a)return a.apply(this,arguments)})}}},fakeUniBootstrapName:"fakeUniBootstrap"};const an=i(),{regExpWxResources:sn,regExpUniRequire:on}=_,{getLevelPath:pn,getLevel:cn}=A;var un={uniRequireWxResource:function(){return an.replace(on,(function(e,t){const n=cn(this.file.relative);return console.log(`\n编译${e}--\x3erequire(${t.replace(sn,pn(n))})`),`require(${t.replace(sn,pn(n))})`}),{skipBinary:!1})}};const ln=i(),{fakeUniBootstrapName:gn,fakeUniBootstrap:fn}=rn,{cwd:hn,env:dn,program:mn,basePath:Pn,targetPath:bn,subModePath:vn,base:wn,regExpUniRequire:yn,regExpWxResources:jn,regExpUniImportWxss:kn,wxResourceAlias:xn,currentNamespace:Nn,mpTypeNamespace:$n}=_,Sn=process.env.PACK_TYPE,{writeLastLine:_n,getLevel:En,getLevelPath:On,deepFind:An}=A,{mixinsEnvCode:Cn}=Et,{uniRequireWxResource:Rn}=un,{runPlugins:Tn}=le,Ln=Object.keys($n).map(e=>$n[e].css);n.task("subMode:createUniSubPackage",(function(){u.mkdirsSync(Pn);const e=ln.filter(wn+"/**/*.js",{restore:!0}),a=ln.filter([wn+"/common/vendor.js"],{restore:!0}),s=ln.filter([wn+"/common/main.js"],{restore:!0}),i=ln.filter([wn+"/**/*.js","!"+wn+"/app.js","!"+wn+"/common/vendor.js","!"+wn+"/common/main.js","!"+wn+"/common/runtime.js"],{restore:!0}),o=ln.filter([`${wn}/**/*.${Nn.css}`,`!${wn}/app.${Nn.css}`,`!${wn}/common/main.${Nn.css}`],{restore:!0}),p=ln.filter([`${wn}/**/*.${Nn.css}`,`!${wn}/app.${Nn.css}`],{restore:!0}),c=ln.filter([wn+"/**/*.json"],{restore:!0}),l=ln.filter([`${wn}/**/*.${Nn.html}`],{restore:!0});return n.src([wn+"/**","!"+wn+"/*.*",wn+"/app.js",`${wn}/app.${Nn.css}`],{allowEmpty:!0,cwd:hn}).pipe(ln.if("dev"===dn,ln.watch([wn+"/**/*","!/"+wn+"/*.json"],{cwd:hn},(function(e){_n("处理"+e.relative+"......")})))).pipe(ln.filter((function(e){if(function(e){const t=r.resolve(bn,"app.js"),n=r.resolve(bn,"app."+Nn.css),a=e.path.replace(Pn,vn);return t===a||n===a}(e))return!1;if("unlink"===e.event){try{t.sync([e.path.replace(Pn,r.resolve(hn,vn))],{force:!0})}catch(e){}return!1}return!0}))).pipe(l).pipe(ln.replace(/[\s\S]*/,(function(e){const t=new B(e);let n=0;return An(t.topNode,e=>{if("#text"===e.nodeName&&"wxs"===e.parentNode.nodeName){e.value.replace(yn,(t,r,a,s)=>{const i=En(this.file.relative),o=r.replace(jn,On(i)).replace(/['"]/g,"");e.parentNode.attrs.src=o,e.parentNode.childNodes=[],n=1,console.log(`\n编译${t}--\x3erequire(${o})`)})}}),n?t.render():e}),{skipBinary:!1})).pipe(l.restore).pipe(a).pipe(ln.replace(/^/,(function(e){return mn.plugin?`var App=function(packInit){};${Nn.globalObject}.canIUse=function(){return false};`:`var __packConfig=require('../pack.config.js');var App=function(packInit){var ${gn}=${(""+fn).replace(/globalObject/g,Nn.globalObject)};${gn}(packInit,__packConfig.packPath,__packConfig.appMode,'${Sn}');};`}),{skipBinary:!1})).pipe(a.restore).pipe(e).pipe(g()).pipe(Rn()).pipe(ln.replace(/[\s\S]*/,(function(e){return Cn(e)+e}))).pipe(e.restore).pipe(s).pipe(ln.replace(/^/,(function(e){return"var __uniPluginExports={};\n"}),{skipBinary:!1})).pipe(ln.replace(/$/,(function(e){return"\nmodule.exports=__uniPluginExports;"}),{skipBinary:!1})).pipe(s.restore).pipe(i).pipe(ln.replace(/^/,(function(e){if(u.existsSync(r.resolve(hn,"src",this.file.relative)))return e;return`require('${On(En(this.file.relative))}app.js');\n`}),{skipBinary:!1})).pipe(i.restore).pipe(c).pipe(ln.replace(/[\s\S]*/,(function(e){if(!u.existsSync(r.resolve(hn,"src",this.file.relative.replace(/json$/,"vue")))&&!u.existsSync(r.resolve(hn,"src",this.file.relative.replace(/json$/,"nvue"))))return e;let t=JSON.parse(""+this.file.contents);for(let e in t.usingComponents)0===t.usingComponents[e].indexOf("/")&&(t.usingComponents[e]=On(En(this.file.relative))+t.usingComponents[e].replace(/^\//,""));return JSON.stringify(t)}),{skipBinary:!1})).pipe(c.restore).pipe(p).pipe(ln.stripCssComments()).pipe(ln.replace(kn,(function(e,t,n){let r="",a=En(this.file.relative);return(n+=";").replace(/\s*import\s*:\s*(('[^\s';]*')|("[^\s";]*"))/g,(function(e,t){const n=RegExp(`(${Ln.join("|")})(['"])$`);t=t.replace(n,Nn.css+"$2"),r+=`@import ${t.replace(jn,On(a))};\n`})),t+r}),{skipBinary:!1})).pipe(p.restore).pipe(o).pipe(ln.stripCssComments()).pipe(ln.replace(/^[\s\S]*$/,(function(e){if(vn===bn)return e;let t=En(this.file.relative);return"@import "+`"${xn}/app.${Nn.css}";`.replace(jn,On(t))+("\n"+e)}),{skipBinary:!1})).pipe(o.restore).pipe(ln.replace(/[\s\S]*/,Tn(vn))).pipe(n.dest(vn,{cwd:hn}))}));const Mn=i(),{cwd:qn,env:Jn,targetPath:Wn,subModePath:Bn,regExpWxResources:Fn,regExpUniImportWxss:In,wxResourceAlias:Un,wxResourcePath:Kn,currentNamespace:Dn,mpTypeNamespace:Yn}=_,{writeLastLine:Hn,getLevel:zn,getLevelPath:Vn}=A,{mixinsEnvCode:Zn}=Et,{uniRequireWxResource:Gn}=un,{runPlugins:Qn}=le,Xn=[],er=[],tr=[];Object.keys(Yn).forEach(e=>{Xn.push(Yn[e].css),er.push(`${Kn}/**/*.${Yn[e].css}`),tr.push(`${Kn}/**/*.${Yn[e].html}`)}),n.task("subMode:copyWxResource",(function(){const e=Mn.filter([Kn+"/**/*.js"],{restore:!0}),a=Mn.filter([...er],{restore:!0}),s=Mn.filter([...tr],{restore:!0});return n.src([Kn+"/**",Kn],{allowEmpty:!0,cwd:qn}).pipe(Mn.if("dev"===Jn,Mn.watch([Kn+"/**",Kn,`!/${Kn}/**/*.*___jb_tmp___`],{cwd:qn},(function(e){Hn("处理"+e.relative+"......")})))).pipe(e).pipe(Mn.replace(/[\s\S]*/,(function(e){return Zn(e)+e}))).pipe(Mn.replace(/^/,(function(e){return`require('${Vn(zn(this.file.relative))}app.js');\n`}),{skipBinary:!1})).pipe(g()).pipe(Gn()).pipe(e.restore).pipe(a).pipe(Mn.stripCssComments()).pipe(Mn.replace(In,(function(e,t,n){let r="";zn(this.file.relative);return t+r}),{skipBinary:!1})).pipe(Mn.replace(/^[\s\S]*$/,(function(e){if(Bn===Wn)return e;let t=zn(this.file.relative);return"@import "+`"${Un}/app.${Dn.css}";`.replace(Fn,Vn(t))+("\n"+e)}),{skipBinary:!1})).pipe(Mn.rename((function(e){e.extname="."+Dn.css}))).pipe(a.restore).pipe(s).pipe(Mn.rename((function(e){e.extname="."+Dn.html}))).pipe(s.restore).pipe(Mn.filter((function(e){if("unlink"===e.event){try{t.sync([e.path.replace(r.resolve(qn,Kn),r.resolve(qn,Bn))],{force:!0})}catch(e){}return!1}return!0}))).pipe(Mn.replace(/[\s\S]*/,Qn(Bn))).pipe(n.dest(Bn,{cwd:qn}))}));const{cwd:nr,env:rr,targetPath:ar,subModePath:sr,projectToSubPackageConfig:ir,program:or,currentNamespace:pr}=_,{tryAgain:cr}=A;n.task("mpWxSubMode",n.series((function(e){console.log("对uni-app进行解耦构建，解除uni-app对原生小程序方法的改写，此过程如果出现权限问题，请使用管理员权限运行"),e()}),"clean:previewDist",(async function e(t){if(or.plugin)t();else{try{let e={packPath:(ir.subPackagePath?"/":"")+ir.subPackagePath,appMode:ir.appMode};await u.outputFile(sr+"/pack.config.js","module.exports="+JSON.stringify(e,null,4))}catch(n){return void await cr(async()=>{await e(t)})}t()}}),function(){let e=[async function(e){let t=r.resolve(nr,ir[pr.mainMpPath],"app.js");await u.exists(t)||await u.outputFile(t,"App({});"),e()},"subMode:createUniSubPackage","subMode:copyWxResource",...or.plugin?["watch:pluginJson"]:["watch:baseAppJson","watch:pagesJson",...ir.mergePack?["watch:mainWeixinMpPackPath"]:[],...sr===ar?["watch:topMode-mainAppJsAndAppWxss"]:[]],"watch:mainAppJson","watch:mainWeixinMp","watch:projectConfigJson"];return"build"===rr?n.series.apply(this,e):n.parallel.apply(this,e)}(),(function(e){e(),"build"===rr&&process.exit()})));const{cwd:ur,basePath:lr,base:gr}=_;n.task("startToPackServe",n.series((async function(e){await u.exists(lr)||await u.mkdirs(lr),e()}),"clean:base",(function(e){n.watch(gr+"/app.json",{events:["all"],cwd:ur},(function(){e()}))}),"mpWxSubMode")),process.on("unhandledRejection",()=>{});
