!function(){const e=require("gulp"),s=require("del"),t=require("gulp-load-plugins")(),r=require("path"),a=require("fs-extra"),n=require("strip-json-comments"),i=require("gulp-strip-comments"),c=require("readline"),{program:o}=require("commander");o.option("--scope <type>","运行目录",process.cwd()),o.parse(process.argv);const p=o.scope,u=require(r.resolve(p,"./projectToSubPackageConfig"));process.on("unhandledRejection",(e,s)=>{});let l="dev";"production"===process.env.NODE_ENV&&(l="build");const w="dist/"+l+"/mp-weixin",f="dist/"+l+"/mp-weixin-pack",m=r.resolve(p,w),g=r.resolve(p,f,u.subPackagePath),d=r.resolve(p,f);let h;function y(e){c.cursorTo(process.stdout,0),process.stdout.write(e),clearTimeout(h),h=setTimeout(()=>{c.clearLine(process.stdout),c.cursorTo(process.stdout,0),process.stdout.write("解耦构建，正在监听中......(此过程如果出现权限问题，请使用管理员权限运行)")},1e3)}async function x(e){return new Promise(async s=>{setTimeout(async()=>{s(await e())},100)})}function k(e){return Array(e).fill("../").join("")}function b(e){return e.split(/[\\/]/).length-1}function v(){return t.replace(/__uniRequireWx\(([a-zA-Z.\/"'@\d]+)\)/g,(function(e,s,t,r){let a=b(this.file.relative);return console.log(`\n编译${e}--\x3erequire(${s.replace(/@wxResource\//g,k(a))})`),`require(${s.replace(/@wxResource\//g,k(a))})`}),{skipBinary:!1})}function P(e){return y("处理app.json......"),t.replace(/[\s\S]+/,(function(s){let t,i,c,o={};({pagesJson(){try{t=JSON.parse(n(s))}catch(e){t={}}},baseAppJson(){try{i=JSON.parse(s)}catch(e){i={}}},mainAppJson(){try{c=JSON.parse(s)}catch(e){c={}}}})[e]();try{t||(t=JSON.parse(n(a.readFileSync(r.resolve(p,"src/pages.json")))))}catch(e){t={}}try{i||(i=JSON.parse(a.readFileSync(r.resolve(p,w+"/app.json"))))}catch(e){i={}}try{c||(c=JSON.parse(a.readFileSync(r.resolve(p,u.mainWeixinMpPath+"/app.json"))))}catch(e){c={}}function l(e){return u.subPackagePath+"/"+e}if(c.subPackages){let e=c.subPackages.find(e=>e.root===u.subPackagePath);if(e){let s=[...t.wxResource&&t.wxResource.pages||[],...i.pages||[]];return i.subPackages&&i.subPackages.forEach(e=>{s=[...s,...(e.pages||[]).map(s=>e.root+"/"+s)]}),t.wxResource&&t.wxResource.subPackages&&t.wxResource.subPackages.forEach(e=>{s=[...s,...(e.pages||[]).map(s=>e.root+"/"+s)]}),e.pages=s,delete i.pages,delete i.subPackages,JSON.stringify({...i,...c},null,2)}}if(i.pages&&i.pages.forEach((e,s)=>{i.pages[s]=l(e)}),i.subPackages&&i.subPackages.forEach(e=>{e.root=l(e.root)}),t.wxResource&&(t.wxResource.pages&&t.wxResource.pages.forEach((e,s)=>{t.wxResource.pages[s]=l(e)}),t.wxResource.subPackages&&t.wxResource.subPackages.forEach(e=>{e.root=l(e.root)})),i.tabBar&&i.tabBar.list&&i.tabBar.list.forEach(({pagePath:e,iconPath:s,selectedIconPath:t,...r},a)=>{i.tabBar.list[a]={pagePath:e?l(e):"",iconPath:s?l(s):"",selectedIconPath:t?l(t):"",...r}}),o={...i,...c},o.pages=Array.from(new Set([...t.indexPage?[l(t.indexPage)]:[],...c.pages||[],...i.pages||[],...t.wxResource&&t.wxResource.pages||[]])),o.subPackages=[...t.wxResource&&t.wxResource.subPackages||[],...i.subPackages||[],...c.subPackages||[]],i.usingComponents){for(let e in i.usingComponents)i.usingComponents[e]="/"+u.subPackagePath+i.usingComponents[e];o.usingComponents={...o.usingComponents||{},...i.usingComponents}}return JSON.stringify(o,null,2)}),{skipBinary:!1})}e.task("clean:base",(async function e(t){try{await s([m+"/**/*"],{force:!0})}catch(s){return void await x(async()=>{await e(t)})}t()})),e.task("clean:subModePath",(async function e(t){try{await s([g+"/**/*"],{force:!0})}catch(s){return void await x(async()=>{await e(t)})}t()})),e.task("clean:previewDist",(async function e(t){try{await s([d+"/**/*"],{force:!0})}catch(s){return void await x(async()=>{await e(t)})}t()})),e.task("watch:pagesJson",(function(){return e.src("src/pages.json",{allowEmpty:!0,cwd:p}).pipe(t.if("dev"===l,t.watch("src/pages.json",{cwd:p},(function(e){y("处理"+e.path+"......")})))).pipe(P("pagesJson")).pipe(t.rename("app.json")).pipe(e.dest(f,{cwd:p}))})),e.task("watch:baseAppJson",(function(){return e.src(w+"/app.json",{allowEmpty:!0,cwd:p}).pipe(t.if("dev"===l,t.watch(w+"/app.json",{cwd:p},(function(e){y("处理"+e.path+"......")})))).pipe(P("baseAppJson")).pipe(e.dest(f,{cwd:p}))})),e.task("watch:mainAppJson",(function(){let s=u.mainWeixinMpPath;return e.src(s+"/app.json",{allowEmpty:!0,cwd:p}).pipe(t.if("dev"===l,t.watch(s+"/app.json",{cwd:p},(function(e){y("处理"+e.path+"......")})))).pipe(P("mainAppJson")).pipe(e.dest(f,{cwd:p}))})),e.task("watch:mainWeixinMp",(function(){let a=u.mainWeixinMpPath,n=a+"/"+u.subPackagePath;return e.src([a+"/**/*","!"+a+"/app.json","!"+a+"/**/*.json___jb_tmp___","!"+a+"/**/*.wxml___jb_tmp___","!"+a+"/**/*.wxss___jb_tmp___","!"+a+"/**/*.js___jb_tmp___","!"+n+"/**/*"],{base:r.resolve(p,a),allowEmpty:!0,cwd:p}).pipe(t.if("dev"===l,t.watch([a+"/**/*","!/"+a+"/app.json","!/"+n+"/**/*"],{cwd:p},(function(e){y("处理"+e.path+"......")})))).pipe(t.filter((async function(e){if("unlink"===e.event){try{await s([e.path.replace(r.resolve(p,a),r.resolve(p,f))],{force:!0})}catch(e){}return!1}return!0}))).pipe(e.dest(f,{cwd:p}))})),e.task("subMode:createUniSubPackage",(async function(n){await a.mkdirs(m);let c=t.filter([w+"/common/vendor.js",w+"/common/main.js",w+"/common/runtime.js",w+"/pages/**/*.js"],{restore:!0}),o=t.filter([w+"/common/vendor.js"],{restore:!0}),u=t.filter([w+"/**/*.js","!"+w+"/common/vendor.js","!"+w+"/common/main.js","!"+w+"/common/runtime.js"],{restore:!0}),f=t.filter([w+"/**/*.wxss"],{restore:!0}),d=t.filter([w+"/**/*.json"],{restore:!0});return e.src([w+"/**",w,"!"+w+"/*.*"],{allowEmpty:!0,cwd:p}).pipe(t.if("dev"===l,t.watch([w+"/**",w,"!/"+w+"/*.*"],{cwd:p},(function(e){y("处理"+e.path+"......")})))).pipe(t.filter((async function(e){if("unlink"===e.event){try{await s([e.path.replace(m,r.resolve(p,g))],{force:!0})}catch(e){}return!1}return!0}))).pipe(o).pipe(t.replace(/^/,"let App=function(){};",{skipBinary:!1})).pipe(o.restore).pipe(c).pipe(i()).pipe(v()).pipe(c.restore).pipe(u).pipe(t.replace(/^/,(function(e){if(a.existsSync("./src/"+this.file.relative))return e;let s=k(b(this.file.relative));return`\n                require('${s}common/runtime.js');\n                require('${s}common/vendor.js');\n                require('${s}common/main.js');\n                `}),{skipBinary:!1})).pipe(u.restore).pipe(d).pipe(t.replace(/[\s\S]*/,(function(e){if(!a.existsSync("./src/"+this.file.relative.replace(/json$/,"vue"))&&!a.existsSync("./src/"+this.file.relative.replace(/json$/,"nvue")))return e;let s=JSON.parse(this.file.contents.toString());for(let e in s.usingComponents)0===s.usingComponents[e].indexOf("/")&&(s.usingComponents[e]=k(b(this.file.relative))+s.usingComponents[e].replace(/^\//,""));return JSON.stringify(s)}),{skipBinary:!1})).pipe(d.restore).pipe(f).pipe(t.replace(/(}|^|\s)__uniWxss\s*{([^{}]+)}/g,(function(e,s,t){let r="",a=b(this.file.relative);return(t+";").replace(/\s*import\s*:\s*([^\s]*;)/g,(function(e,s){r+=`@import ${s.replace(/@wxResource\//g,k(a))}`})),s+r}),{skipBinary:!1})).pipe(t.replace(/^[\s\S]*$/,(function(e){let s=b(this.file.relative),t=`@import ${'"@wxResource/common/main.wxss";'.replace(/@wxResource\//g,k(s))}`,r=`\n${e}`;return this.file.relative.match(/^common[\\/]+main.wxss/i)||(r=t+r),r}),{skipBinary:!1})).pipe(f.restore).pipe(e.dest(g,{cwd:p}))})),e.task("subMode:copyWxResource",(function(){let a=t.filter(["src/wxresource/**/*.js"],{restore:!0});return e.src(["src/wxresource/**","src/wxresource"],{allowEmpty:!0,cwd:p}).pipe(t.if("dev"===l,t.watch(["src/wxresource/**","src/wxresource","!src/wxresource/**/*.*___jb_tmp___"],{cwd:p},(function(e){y("处理"+e.path+"......")})))).pipe(a).pipe(i()).pipe(v()).pipe(a.restore).pipe(t.filter((async function(e){if("unlink"===e.event){try{await s([e.path.replace(r.resolve(p,"src/wxresource"),r.resolve(p,g))],{force:!0})}catch(e){}return!1}return!0}))).pipe(e.dest(g,{cwd:p}))})),e.task("mpWxSubMode",e.series((function(e){console.log("对uni-app进行解耦构建，解除uni-app对原生小程序方法的改写，此过程如果出现权限问题，请使用管理员权限运行"),e()}),"clean:previewDist",(async function e(s){try{await a.outputFile(g+"/pack.config.js",`module.exports={packPath:'/${u.subPackagePath}'}`)}catch(t){return void await x(async()=>{await e(s)})}s()}),function(){let s=["subMode:createUniSubPackage","subMode:copyWxResource","watch:baseAppJson","watch:pagesJson","watch:mainAppJson","watch:mainWeixinMp"];return"build"===l?e.series.apply(this,s):e.parallel.apply(this,s)}(),(function(e){e(),"build"===l&&process.exit()}))),e.task("startToPackServe",e.series((async function(e){await a.exists(m)||await a.mkdirs(m),e()}),"clean:base",(function(s){e.watch(w+"/app.json",{events:["all"],cwd:p},(function(){s()}))}),"mpWxSubMode"))}();