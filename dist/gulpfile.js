!function(){const e=require("parse5"),n=require("gulp"),t=require("del"),i=require("gulp-load-plugins")(),p=require("path"),a=require("fs-extra"),r=require("strip-json-comments"),s=require("gulp-strip-comments"),o=require("single-line-log").stdout,{program:c}=require("commander");c.option("--scope <type>","运行目录",process.cwd()).option("--plugin","插件模式"),c.parse(process.argv);const u=c.scope,l=require(p.resolve(u,"./projectToSubPackageConfig")),f=l.wxResourcePath||"src/wxresource",g=l.wxResourceAlias||"@wxResource",w=new RegExp(`${g}\\/`,"g"),h=l.uniRequireApiName||"__uniRequireWx",d=new RegExp(`${h}\\(([a-zA-Z.\\/"'@\\d]+)\\)`,"g"),m=l.uniImportWxssApiName||"__uniWxss",y=new RegExp(`(}|^|\\s|;)${m}\\s*{([^{}]+)}`,"g"),x=l.configWxResourceKey||"wxResource";process.on("unhandledRejection",(e,n)=>{});let k="dev";"production"===process.env.NODE_ENV&&(k="build");const v="dist/"+k+"/mp-weixin";let P="dist/"+k+"/mp-weixin-pack";c.plugin&&(P="dist/"+k+"/mp-weixin-pack-plugin");const j=p.resolve(u,v),b=p.resolve(u,P,l.subPackagePath),_=p.resolve(u,P);let S,$;function A(e,n,t){wx.__uniapp2wxpack||(wx.__uniapp2wxpack={});var i=wx.__uniapp2wxpack[n.replace("/","")]={__packInit:{}};if(e)for(var p in e)"function"!=typeof e[p]?i.__packInit[p]=e[p]:function(n){i.__packInit[n]=function(){return e[n].apply(e,arguments)}}(p);else e={};if("none"!==t){var a=Page,r=Component,s="",o=1,c=1;"function"==typeof e.onError&&wx.onError((function(){return e.onError.apply(e,arguments)})),"function"==typeof e.onPageNotFound&&wx.onPageNotFound((function(){return e.onPageNotFound.apply(e,arguments)})),"function"==typeof e.onUnhandledRejection&&wx.onUnhandledRejection((function(){return e.onUnhandledRejection.apply(e,arguments)})),wx.onAppRoute((function(i){"top"!==t&&0!==("/"+i.path).indexOf(n+"/")&&(o=1,e.onHide.call(e,wx.getLaunchOptionsSync())),s=i.path})),wx.onAppHide((function(){if("top"===t)return e.onHide.call(e,wx.getLaunchOptionsSync());var i=getCurrentPages();return 0===("/"+i[i.length-1].route).indexOf(n+"/")?(o=1,s="",e.onHide.call(e,wx.getLaunchOptionsSync())):void 0})),wx.onAppShow((function(){"top"===t&&"function"==typeof e.onShow&&e.onShow.call(e,wx.getLaunchOptionsSync()),c&&getApp()&&(getApp().globalData||(getApp().globalData={}),Object.assign(getApp().globalData,e.globalData||{})),c=0})),"top"===t&&c&&"function"==typeof e.onLaunch&&e.onLaunch.call(e,wx.getLaunchOptionsSync()),Page=function(e){return u(e),a.call(this,e)},Component=function(e){return u(e.methods||{}),r.call(this,e)}}function u(i){if("top"!==t){var p=i.onShow;"function"!=typeof e.onShow&&"function"!=typeof e.onLaunch||(i.onShow=function(){var t=getCurrentPages();if(s&&0===("/"+s).indexOf(n+"/")||0!==("/"+t[t.length-1].route).indexOf(n+"/")||(o&&(o=0,e.onLaunch.call(e,wx.getLaunchOptionsSync())),e.onShow.call(e,wx.getLaunchOptionsSync())),"function"==typeof p)return p.apply(this,arguments)})}}}function J(e){o(e),clearTimeout(S),S=setTimeout(()=>{o("解耦构建，正在监听中......(此过程如果出现权限问题，请使用管理员权限运行)")},300)}async function E(e){return new Promise(async n=>{setTimeout(async()=>{n(await e())},100)})}function N(e){return Array(e).fill("../").join("")}function C(e){return e.split(/[\\/]/).length-1}function O(){return i.replace(d,(function(e,n,t,i){let p=C(this.file.relative);return console.log(`\n编译${e}--\x3erequire(${n.replace(w,N(p))})`),`require(${n.replace(w,N(p))})`}),{skipBinary:!1})}function M(){if(c.plugin)return;const e=p.resolve(u,l.mainWeixinMpPath+"/app.js");if(a.existsSync(e)){const n=a.readFileSync(e,"utf8");let t=`require('${`./${l.subPackagePath}/`}app.js');\n`;if(b===_){t=`${a.readFileSync(j+"/app.js","utf8")};\n`}($||c.plugin)&&(t=""),a.outputFileSync(_+"/app.js",t+n)}}function W(e){return J("处理app.json......"),i.replace(/[\s\S]+/,(function(n){if(c.plugin&&"mainAppJson"===e)return n;$=!1;let t,i,s,o={};({pagesJson(){try{t=JSON.parse(r(n))}catch(e){t={}}},baseAppJson(){try{i=JSON.parse(n)}catch(e){i={}}},mainAppJson(){try{s=JSON.parse(n)}catch(e){s={}}}})[e]();try{t||(t=JSON.parse(r(a.readFileSync(p.resolve(u,"src/pages.json"),"utf8"))))}catch(e){t={}}try{i||(i=JSON.parse(a.readFileSync(p.resolve(u,v+"/app.json"),"utf8")))}catch(e){i={}}try{s||(s=JSON.parse(a.readFileSync(p.resolve(u,l.mainWeixinMpPath+"/app.json"),"utf8")))}catch(e){s={}}function f(e){return l.subPackagePath+(l.subPackagePath?"/":"")+e}if(s.subPackages){let e=s.subPackages.find(e=>e.root===l.subPackagePath);if(e){$=!0;let n=[...t[x]&&t[x].pages||[],...i.pages||[]];return i.subPackages&&i.subPackages.forEach(e=>{n=[...n,...(e.pages||[]).map(n=>e.root+(e.root?"/":"")+n)]}),t[x]&&t[x].subPackages&&t[x].subPackages.forEach(e=>{n=[...n,...(e.pages||[]).map(n=>e.root+(e.root?"/":"")+n)]}),e.pages=n,M(),delete i.pages,delete i.subPackages,JSON.stringify({...i,...s},null,2)}}i.pages&&i.pages.forEach((e,n)=>{i.pages[n]=f(e)}),i.subPackages&&i.subPackages.forEach(e=>{e.root=f(e.root)}),t[x]&&(t[x].pages&&t[x].pages.forEach((e,n)=>{t[x].pages[n]=f(e)}),t[x].subPackages&&t[x].subPackages.forEach(e=>{e.root=f(e.root)})),i.tabBar&&i.tabBar.list&&i.tabBar.list.forEach(({pagePath:e,iconPath:n,selectedIconPath:t,...p},a)=>{i.tabBar.list[a]={pagePath:e?f(e):"",iconPath:n?f(n):"",selectedIconPath:t?f(t):"",...p}}),o={...i,...s},o.pages=Array.from(new Set([...t.indexPage?[f(t.indexPage)]:[],...s.pages||[],...i.pages||[],...t[x]&&t[x].pages||[]]));let g=[],w={};function h(e){e.forEach(e=>{w[e.root]?w[e.root]=Array.from(new Set([...w[e.root],...e.pages])):w[e.root]=e.pages})}h(t[x]&&t[x].subPackages||[]),h(i.subPackages||[]),h(s.subPackages||[]);for(let e in w)g.push({root:e,pages:w[e]});if(o.subPackages=[...g],i.usingComponents){for(let e in i.usingComponents)i.usingComponents[e]="/"+l.subPackagePath+i.usingComponents[e];o.usingComponents={...o.usingComponents||{},...i.usingComponents}}return M(),JSON.stringify(o,null,2)}),{skipBinary:!1})}function q(e){const n=n,t=l.mainWeixinMpPath+"/"+l.subPackagePath;return!a.existsSync(e.path.replace(p.resolve(u,t),p.resolve(u,v)))&&!a.existsSync(e.path.replace(p.resolve(u,t),p.resolve(u,n)))}A.name="fakeUniBootstrap",n.task("clean:base",(async function e(n){try{await t([j+"/**/*"],{force:!0})}catch(t){return void await E(async()=>{await e(n)})}n()})),n.task("clean:subModePath",(async function e(n){try{await t([b+"/**/*"],{force:!0})}catch(t){return void await E(async()=>{await e(n)})}n()})),n.task("clean:previewDist",(async function e(n){try{await t([_+"/**/*"],{force:!0})}catch(t){return void await E(async()=>{await e(n)})}n()})),n.task("watch:pluginJson",(function(){return n.src("src/plugin.json",{allowEmpty:!0,cwd:u}).pipe(i.if("dev"===k,i.watch("src/plugin.json",{cwd:u},(function(e){J("处理"+e.relative+"......")})))).pipe(n.dest(P+`/${l.subPackagePath}`,{cwd:u}))})),n.task("watch:projectConfigJson",(function(){return n.src("project.config.json",{allowEmpty:!0,cwd:u}).pipe(i.if("dev"===k,i.watch("project.config.json",{cwd:u},(function(e){J("处理"+e.relative+"......")})))).pipe(n.dest(P,{cwd:u}))})),n.task("watch:pagesJson",(function(){return n.src("src/pages.json",{allowEmpty:!0,cwd:u}).pipe(i.if("dev"===k,i.watch("src/pages.json",{cwd:u},(function(e){J("处理"+e.relative+"......")})))).pipe(W("pagesJson")).pipe(i.rename("app.json")).pipe(n.dest(P,{cwd:u}))})),n.task("watch:baseAppJson",(function(){return n.src(v+"/app.json",{allowEmpty:!0,cwd:u}).pipe(i.if("dev"===k,i.watch(v+"/app.json",{cwd:u},(function(e){J("处理"+e.relative+"......")})))).pipe(W("baseAppJson")).pipe(n.dest(P,{cwd:u}))})),n.task("watch:mainAppJson",(function(){let e=l.mainWeixinMpPath;return n.src(e+"/app.json",{allowEmpty:!0,cwd:u}).pipe(i.if("dev"===k,i.watch(e+"/app.json",{cwd:u},(function(e){J("处理"+e.relative+"......")})))).pipe(W("mainAppJson")).pipe(n.dest(P+(c.plugin?"/miniprogram":""),{cwd:u}))})),n.task("watch:topMode-mainAppJsAndAppWxss",(function(){let e=l.mainWeixinMpPath;const t=i.filter([e+"/app.wxss"],{restore:!0}),p=i.filter([e+"/app.js"],{restore:!0});return n.src([e+"/app.js",e+"/app.wxss"],{allowEmpty:!0,cwd:u}).pipe(i.if("dev"===k,i.watch([e+"/app.js",e+"/app.wxss"],{cwd:u},(function(e){J("处理"+e.relative+"......")})))).pipe(p).pipe(i.replace(/^/,(function(e){return`${a.readFileSync(j+"/app.js","utf8")};\n`}),{skipBinary:!1})).pipe(p.restore).pipe(t).pipe(i.replace(/^/,(function(e){return`${a.readFileSync(j+"/app.wxss","utf8")}\n`}),{skipBinary:!1})).pipe(t.restore).pipe(n.dest(P+(c.plugin?"/miniprogram":""),{cwd:u}))})),n.task("watch:mainWeixinMpPackPath",(function(){const e=l.mainWeixinMpPath,a=e+"/"+l.subPackagePath,r=P+"/"+l.subPackagePath;return n.src([a,a+"/**/*","!"+a+"/pack.config.js"],{allowEmpty:!0,cwd:u}).pipe(i.if("dev"===k,i.watch([a,a+"/**/*","!/"+a+"/pack.config.js"],{cwd:u},(function(e){J("处理"+e.relative+"......")})))).pipe(i.filter((function(n){if(!q(n))return!1;if("unlink"===n.event){try{t.sync([n.path.replace(p.resolve(u,e),p.resolve(u,P))],{force:!0})}catch(e){}return!1}return!0}))).pipe(n.dest(r,{cwd:u}))})),n.task("watch:mainWeixinMp",(function(){let e=l.mainWeixinMpPath,r=e+"/"+l.subPackagePath,s=i.filter([e+"/app.js"],{restore:!0});return n.src([e+"/**/*","!"+e+"/app.json","!"+e+"/**/*.json___jb_tmp___","!"+e+"/**/*.wxml___jb_tmp___","!"+e+"/**/*.wxss___jb_tmp___","!"+e+"/**/*.js___jb_tmp___","!"+r+"/**/*"],{base:p.resolve(u,e),allowEmpty:!0,cwd:u}).pipe(i.if("dev"===k,i.watch([e+"/**/*","!/"+e+"/app.json","!/"+r+"/**/*"],{cwd:u},(function(e){J("处理"+e.relative+"......")})))).pipe(i.filter((function(n){if("unlink"===n.event){try{t.sync([n.path.replace(p.resolve(u,e),p.resolve(u,P))],{force:!0})}catch(e){}return!1}return!0}))).pipe(s).pipe(i.replace(/^/,(function(e){if($||c.plugin)return"";let n=`./${l.subPackagePath}/`;if(b===_){return`${a.readFileSync(j+"/app.js","utf8")};\n`}return`require('${n}app.js');\n`}),{skipBinary:!1})).pipe(s.restore).pipe(n.dest(P+(c.plugin?"/miniprogram":""),{cwd:u}))})),n.task("subMode:createUniSubPackage",(function(){a.mkdirsSync(j);let r=i.filter([v+"/common/vendor.js",v+"/common/main.js",v+"/common/runtime.js",v+"/pages/**/*.js"],{restore:!0}),o=i.filter([v+"/common/vendor.js"],{restore:!0}),l=i.filter([v+"/common/main.js"],{restore:!0}),f=i.filter([v+"/**/*.js","!"+v+"/app.js","!"+v+"/common/vendor.js","!"+v+"/common/main.js","!"+v+"/common/runtime.js"],{restore:!0}),h=i.filter([v+"/**/*.wxss","!"+v+"/app.wxss","!"+v+"/common/main.wxss"],{restore:!0}),m=i.filter([v+"/**/*.wxss","!"+v+"/app.wxss"],{restore:!0}),x=i.filter([v+"/**/*.json"],{restore:!0});const P=i.filter([v+"/**/*.wxml"],{restore:!0});return n.src([v+"/**","!"+v+"/*.*",v+"/app.js",v+"/app.wxss"],{allowEmpty:!0,cwd:u}).pipe(i.if("dev"===k,i.watch([v+"/**/*","!/"+v+"/*.json"],{cwd:u},(function(e){J("处理"+e.relative+"......")})))).pipe(i.filter((function(e){if(function(e){const n=p.resolve(_,"app.js"),t=p.resolve(_,"app.wxss"),i=e.path.replace(j,b);return n===i||t===i}(e))return!1;if("unlink"===e.event){try{t.sync([e.path.replace(j,p.resolve(u,b))],{force:!0})}catch(e){}return!1}return!0}))).pipe(P).pipe(i.replace(/[\s\S]*/,(function(n){const t=e.parse(n);let i=0;const p=t.childNodes[0].childNodes[1];return function e(n,t){t&&(t(n),n.childNodes&&n.childNodes.forEach(n=>{e(n,t)}))}(t,e=>{if("#text"===e.nodeName&&"wxs"===e.parentNode.nodeName){e.value.replace(d,(n,t,p,a)=>{const r=C(this.file.relative),s=t.replace(w,N(r)).replace(/['"]/g,"");e.parentNode.attrs.push({name:"src",value:s}),e.parentNode.childNodes=[],i=1,console.log(`\n编译${n}--\x3erequire(${s})`)})}}),i?e.serialize(p):n}),{skipBinary:!1})).pipe(P.restore).pipe(o).pipe(i.replace(/^/,(function(e){return c.plugin?"var App=function(packInit){};wx.canIUse=function(){return false};":`var __packConfig=require('../pack.config.js');var App=function(packInit){${A.toString()};${A.name}(packInit,__packConfig.packPath,__packConfig.appMode);};`}),{skipBinary:!1})).pipe(o.restore).pipe(r).pipe(s()).pipe(O()).pipe(r.restore).pipe(l).pipe(i.replace(/^/,(function(e){return"var __uniPluginExports={};\n"}),{skipBinary:!1})).pipe(i.replace(/$/,(function(e){return"\nmodule.exports=__uniPluginExports;"}),{skipBinary:!1})).pipe(l.restore).pipe(f).pipe(i.replace(/^/,(function(e){if(a.existsSync(p.resolve(u,"src",this.file.relative)))return e;return`require('${N(C(this.file.relative))}app.js');\n`}),{skipBinary:!1})).pipe(f.restore).pipe(x).pipe(i.replace(/[\s\S]*/,(function(e){if(!a.existsSync(p.resolve(u,"src",this.file.relative.replace(/json$/,"vue")))&&!a.existsSync(p.resolve(u,"src",this.file.relative.replace(/json$/,"nvue"))))return e;let n=JSON.parse(this.file.contents.toString());for(let e in n.usingComponents)0===n.usingComponents[e].indexOf("/")&&(n.usingComponents[e]=N(C(this.file.relative))+n.usingComponents[e].replace(/^\//,""));return JSON.stringify(n)}),{skipBinary:!1})).pipe(x.restore).pipe(m).pipe(i.stripCssComments()).pipe(i.replace(y,(function(e,n,t){let i="",p=C(this.file.relative);return(t+";").replace(/\s*import\s*:\s*(('[^\s';]*')|("[^\s";]*"))/g,(function(e,n){i+=`@import ${n.replace(w,N(p))};\n`})),n+i}),{skipBinary:!1})).pipe(m.restore).pipe(h).pipe(i.stripCssComments()).pipe(i.replace(/^[\s\S]*$/,(function(e){if(b===_)return e;let n=C(this.file.relative);return`@import ${('"'+g+'/app.wxss";').replace(w,N(n))}`+`\n${e}`}),{skipBinary:!1})).pipe(h.restore).pipe(n.dest(b,{cwd:u}))})),n.task("subMode:copyWxResource",(function(){let e=i.filter([f+"/**/*.js"],{restore:!0}),a=i.filter([f+"/**/*.wxss"],{restore:!0});return n.src([f+"/**",f],{allowEmpty:!0,cwd:u}).pipe(i.if("dev"===k,i.watch([f+"/**",f,`!/${f}/**/*.*___jb_tmp___`],{cwd:u},(function(e){J("处理"+e.relative+"......")})))).pipe(e).pipe(i.replace(/^/,(function(e){return`require('${N(C(this.file.relative))}app.js');\n`}),{skipBinary:!1})).pipe(s()).pipe(O()).pipe(e.restore).pipe(a).pipe(i.stripCssComments()).pipe(i.replace(y,(function(e,n,t){let i="",p=C(this.file.relative);return(t+";").replace(/\s*import\s*:\s*(('[^\s']*')|("[^\s']*"))/g,(function(e,n){i+=`@import ${n.replace(w,N(p))};\n`})),n+i}),{skipBinary:!1})).pipe(i.replace(/^[\s\S]*$/,(function(e){if(b===_)return e;let n=C(this.file.relative);return`@import ${('"'+g+'/app.wxss";').replace(w,N(n))}`+`\n${e}`}),{skipBinary:!1})).pipe(a.restore).pipe(i.filter((function(e){if("unlink"===e.event){try{t.sync([e.path.replace(p.resolve(u,f),p.resolve(u,b))],{force:!0})}catch(e){}return!1}return!0}))).pipe(n.dest(b,{cwd:u}))})),n.task("mpWxSubMode",n.series((function(e){console.log("对uni-app进行解耦构建，解除uni-app对原生小程序方法的改写，此过程如果出现权限问题，请使用管理员权限运行"),e()}),"clean:previewDist",(async function e(n){if(c.plugin)n();else{try{let e={packPath:(l.subPackagePath?"/":"")+l.subPackagePath,appMode:l.appMode};await a.outputFile(b+"/pack.config.js",`module.exports=${JSON.stringify(e,null,4)}`)}catch(t){return void await E(async()=>{await e(n)})}n()}}),function(){let e=[async function(e){let n=p.resolve(u,l.mainWeixinMpPath,"app.js");await a.exists(n)||await a.outputFile(n,"App({});"),e()},"subMode:createUniSubPackage","subMode:copyWxResource",...c.plugin?["watch:pluginJson"]:["watch:baseAppJson","watch:pagesJson",...l.mergePack?["watch:mainWeixinMpPackPath"]:[],...b===_?["watch:topMode-mainAppJsAndAppWxss"]:[]],"watch:mainAppJson","watch:mainWeixinMp","watch:projectConfigJson"];return"build"===k?n.series.apply(this,e):n.parallel.apply(this,e)}(),(function(e){e(),"build"===k&&process.exit()}))),n.task("startToPackServe",n.series((async function(e){await a.exists(j)||await a.mkdirs(j),e()}),"clean:base",(function(e){n.watch(v+"/app.json",{events:["all"],cwd:u},(function(){e()}))}),"mpWxSubMode"))}();