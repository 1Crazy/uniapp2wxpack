!function(){const e=require("gulp"),n=require("del"),t=require("gulp-load-plugins")(),a=require("path"),r=require("fs-extra"),s=require("strip-json-comments"),i=require("gulp-strip-comments"),o=require("single-line-log").stdout,{program:p}=require("commander");p.option("--scope <type>","运行目录",process.cwd()),p.parse(process.argv);const c=p.scope,u=require(a.resolve(c,"./projectToSubPackageConfig"));process.on("unhandledRejection",(e,n)=>{});let l="dev";"production"===process.env.NODE_ENV&&(l="build");const f="dist/"+l+"/mp-weixin",w="dist/"+l+"/mp-weixin-pack",g=a.resolve(c,f),h=a.resolve(c,w,u.subPackagePath),d=a.resolve(c,w);let m;function x(e,n,t){wx.__uniapp2wxpack||(wx.__uniapp2wxpack={});var a=wx.__uniapp2wxpack[n.replace("/","")]={__packInit:{}};if(e)for(var r in e)"function"!=typeof e[r]?a.__packInit[r]=e[r]:function(n){a.__packInit[n]=function(){return e[n].apply(e,arguments)}}(r);else e={};if("none"!==t){var s=Page,i=Component,o="",p=1,c=1;"function"==typeof e.onError&&wx.onError((function(){return e.onError.apply(e,arguments)})),"function"==typeof e.onPageNotFound&&wx.onPageNotFound((function(){return e.onPageNotFound.apply(e,arguments)})),"function"==typeof e.onUnhandledRejection&&wx.onUnhandledRejection((function(){return e.onUnhandledRejection.apply(e,arguments)})),wx.onAppRoute((function(a){"top"!==t&&0!==("/"+a.path).indexOf(n+"/")&&(p=1,e.onHide.call(e,wx.getLaunchOptionsSync())),o=a.path})),wx.onAppHide((function(){if("top"===t)return e.onHide.call(e,wx.getLaunchOptionsSync());var a=getCurrentPages();return 0===("/"+a[a.length-1].route).indexOf(n+"/")?(p=1,o="",e.onHide.call(e,wx.getLaunchOptionsSync())):void 0})),wx.onAppShow((function(){"top"===t&&"function"==typeof e.onShow&&e.onShow.call(e,wx.getLaunchOptionsSync()),c&&getApp()&&(getApp().globalData||(getApp().globalData={}),Object.assign(getApp().globalData,e.globalData||{})),c=0})),"top"===t&&c&&"function"==typeof e.onLaunch&&e.onLaunch.call(e,wx.getLaunchOptionsSync()),Page=function(e){return u(e),s.call(this,e)},Component=function(e){return u(e.methods||{}),i.call(this,e)}}function u(a){if("top"!==t){var r=a.onShow;"function"!=typeof e.onShow&&"function"!=typeof e.onLaunch||(a.onShow=function(){var t=getCurrentPages();if(o&&0===("/"+o).indexOf(n+"/")||0!==("/"+t[t.length-1].route).indexOf(n+"/")||(p&&(p=0,e.onLaunch.call(e,wx.getLaunchOptionsSync())),e.onShow.call(e,wx.getLaunchOptionsSync())),"function"==typeof r)return r.apply(this,arguments)})}}}function y(e){o(e),clearTimeout(m),m=setTimeout(()=>{o("解耦构建，正在监听中......(此过程如果出现权限问题，请使用管理员权限运行)")},300)}async function k(e){return new Promise(async n=>{setTimeout(async()=>{n(await e())},100)})}function v(e){return Array(e).fill("../").join("")}function _(e){return e.split(/[\\/]/).length-1}function b(){return t.replace(/__uniRequireWx\(([a-zA-Z.\/"'@\d]+)\)/g,(function(e,n,t,a){let r=_(this.file.relative);return console.log(`\n编译${e}--\x3erequire(${n.replace(/@wxResource\//g,v(r))})`),`require(${n.replace(/@wxResource\//g,v(r))})`}),{skipBinary:!1})}function P(e){return y("处理app.json......"),t.replace(/[\s\S]+/,(function(n){let t,i,o,p={};({pagesJson(){try{t=JSON.parse(s(n))}catch(e){t={}}},baseAppJson(){try{i=JSON.parse(n)}catch(e){i={}}},mainAppJson(){try{o=JSON.parse(n)}catch(e){o={}}}})[e]();try{t||(t=JSON.parse(s(r.readFileSync(a.resolve(c,"src/pages.json"),"utf8"))))}catch(e){t={}}try{i||(i=JSON.parse(r.readFileSync(a.resolve(c,f+"/app.json"),"utf8")))}catch(e){i={}}try{o||(o=JSON.parse(r.readFileSync(a.resolve(c,u.mainWeixinMpPath+"/app.json"),"utf8")))}catch(e){o={}}function l(e){return u.subPackagePath+"/"+e}if(o.subPackages){let e=o.subPackages.find(e=>e.root===u.subPackagePath);if(e){let n=[...t.wxResource&&t.wxResource.pages||[],...i.pages||[]];return i.subPackages&&i.subPackages.forEach(e=>{n=[...n,...(e.pages||[]).map(n=>e.root+"/"+n)]}),t.wxResource&&t.wxResource.subPackages&&t.wxResource.subPackages.forEach(e=>{n=[...n,...(e.pages||[]).map(n=>e.root+"/"+n)]}),e.pages=n,delete i.pages,delete i.subPackages,JSON.stringify({...i,...o},null,2)}}i.pages&&i.pages.forEach((e,n)=>{i.pages[n]=l(e)}),i.subPackages&&i.subPackages.forEach(e=>{e.root=l(e.root)}),t.wxResource&&(t.wxResource.pages&&t.wxResource.pages.forEach((e,n)=>{t.wxResource.pages[n]=l(e)}),t.wxResource.subPackages&&t.wxResource.subPackages.forEach(e=>{e.root=l(e.root)})),i.tabBar&&i.tabBar.list&&i.tabBar.list.forEach(({pagePath:e,iconPath:n,selectedIconPath:t,...a},r)=>{i.tabBar.list[r]={pagePath:e?l(e):"",iconPath:n?l(n):"",selectedIconPath:t?l(t):"",...a}}),p={...i,...o},p.pages=Array.from(new Set([...t.indexPage?[l(t.indexPage)]:[],...o.pages||[],...i.pages||[],...t.wxResource&&t.wxResource.pages||[]]));let w=[],g={};function h(e){e.forEach(e=>{g[e.root]?g[e.root]=Array.from(new Set([...g[e.root],...e.pages])):g[e.root]=e.pages})}h(t.wxResource&&t.wxResource.subPackages||[]),h(i.subPackages||[]),h(o.subPackages||[]);for(let e in g)w.push({root:e,pages:g[e]});if(p.subPackages=[...w],i.usingComponents){for(let e in i.usingComponents)i.usingComponents[e]="/"+u.subPackagePath+i.usingComponents[e];p.usingComponents={...p.usingComponents||{},...i.usingComponents}}return JSON.stringify(p,null,2)}),{skipBinary:!1})}x.name="fakeUniBootstrap",e.task("clean:base",(async function e(t){try{await n([g+"/**/*"],{force:!0})}catch(n){return void await k(async()=>{await e(t)})}t()})),e.task("clean:subModePath",(async function e(t){try{await n([h+"/**/*"],{force:!0})}catch(n){return void await k(async()=>{await e(t)})}t()})),e.task("clean:previewDist",(async function e(t){try{await n([d+"/**/*"],{force:!0})}catch(n){return void await k(async()=>{await e(t)})}t()})),e.task("watch:pagesJson",(function(){return e.src("src/pages.json",{allowEmpty:!0,cwd:c}).pipe(t.if("dev"===l,t.watch("src/pages.json",{cwd:c},(function(e){y("处理"+e.relative+"......")})))).pipe(P("pagesJson")).pipe(t.rename("app.json")).pipe(e.dest(w,{cwd:c}))})),e.task("watch:baseAppJson",(function(){return e.src(f+"/app.json",{allowEmpty:!0,cwd:c}).pipe(t.if("dev"===l,t.watch(f+"/app.json",{cwd:c},(function(e){y("处理"+e.relative+"......")})))).pipe(P("baseAppJson")).pipe(e.dest(w,{cwd:c}))})),e.task("watch:mainAppJson",(function(){let n=u.mainWeixinMpPath;return e.src(n+"/app.json",{allowEmpty:!0,cwd:c}).pipe(t.if("dev"===l,t.watch(n+"/app.json",{cwd:c},(function(e){y("处理"+e.relative+"......")})))).pipe(P("mainAppJson")).pipe(e.dest(w,{cwd:c}))})),e.task("watch:mainWeixinMp",(function(){let r=u.mainWeixinMpPath,s=r+"/"+u.subPackagePath,i=t.filter([r+"/app.js"],{restore:!0});return e.src([r+"/**/*","!"+r+"/app.json","!"+r+"/**/*.json___jb_tmp___","!"+r+"/**/*.wxml___jb_tmp___","!"+r+"/**/*.wxss___jb_tmp___","!"+r+"/**/*.js___jb_tmp___","!"+s+"/**/*"],{base:a.resolve(c,r),allowEmpty:!0,cwd:c}).pipe(t.if("dev"===l,t.watch([r+"/**/*","!/"+r+"/app.json","!/"+s+"/**/*"],{cwd:c},(function(e){y("处理"+e.relative+"......")})))).pipe(t.filter((async function(e){if("unlink"===e.event){try{await n([e.path.replace(a.resolve(c,r),a.resolve(c,w))],{force:!0})}catch(e){}return!1}return!0}))).pipe(i).pipe(t.replace(/^/,(function(e){return`require('${`./${u.subPackagePath}/`}app.js');\n`}),{skipBinary:!1})).pipe(i.restore).pipe(e.dest(w,{cwd:c}))})),e.task("subMode:createUniSubPackage",(function(){r.mkdirsSync(g);let s=t.filter([f+"/common/vendor.js",f+"/common/main.js",f+"/common/runtime.js",f+"/pages/**/*.js"],{restore:!0}),o=t.filter([f+"/common/vendor.js"],{restore:!0}),p=t.filter([f+"/**/*.js","!"+f+"/app.js","!"+f+"/common/vendor.js","!"+f+"/common/main.js","!"+f+"/common/runtime.js"],{restore:!0}),u=t.filter([f+"/**/*.wxss","!"+f+"/app.wxss","!"+f+"/common/main.wxss"],{restore:!0}),w=t.filter([f+"/**/*.wxss","!"+f+"/app.wxss"],{restore:!0}),d=t.filter([f+"/**/*.json"],{restore:!0});return e.src([f+"/**","!"+f+"/*.*",f+"/app.js",f+"/app.wxss"],{allowEmpty:!0,cwd:c}).pipe(t.if("dev"===l,t.watch([f+"/**/*","!/"+f+"/*.json"],{cwd:c},(function(e){y("处理"+e.relative+"......")})))).pipe(t.filter((async function(e){if("unlink"===e.event){try{await n([e.path.replace(g,a.resolve(c,h))],{force:!0})}catch(e){}return!1}return!0}))).pipe(o).pipe(t.replace(/^/,`var __packConfig=require('../pack.config.js');var App=function(packInit){${x.toString()};${x.name}(packInit,__packConfig.packPath,__packConfig.appMode);};`,{skipBinary:!1})).pipe(o.restore).pipe(s).pipe(i()).pipe(b()).pipe(s.restore).pipe(p).pipe(t.replace(/^/,(function(e){if(r.existsSync(a.resolve(c,"src",this.file.relative)))return e;return`require('${v(_(this.file.relative))}app.js');\n`}),{skipBinary:!1})).pipe(p.restore).pipe(d).pipe(t.replace(/[\s\S]*/,(function(e){if(!r.existsSync(a.resolve(c,"src",this.file.relative.replace(/json$/,"vue")))&&!r.existsSync(a.resolve(c,"src",this.file.relative.replace(/json$/,"nvue"))))return e;let n=JSON.parse(this.file.contents.toString());for(let e in n.usingComponents)0===n.usingComponents[e].indexOf("/")&&(n.usingComponents[e]=v(_(this.file.relative))+n.usingComponents[e].replace(/^\//,""));return JSON.stringify(n)}),{skipBinary:!1})).pipe(d.restore).pipe(w).pipe(t.stripCssComments()).pipe(t.replace(/(}|^|\s|;)__uniWxss\s*{([^{}]+)}/g,(function(e,n,t){let a="",r=_(this.file.relative);return(t+";").replace(/\s*import\s*:\s*(('[^\s';]*')|("[^\s";]*"))/g,(function(e,n){a+=`@import ${n.replace(/@wxResource\//g,v(r))};\n`})),n+a}),{skipBinary:!1})).pipe(w.restore).pipe(u).pipe(t.stripCssComments()).pipe(t.replace(/^[\s\S]*$/,(function(e){let n=_(this.file.relative);return`@import ${'"@wxResource/app.wxss";'.replace(/@wxResource\//g,v(n))}`+`\n${e}`}),{skipBinary:!1})).pipe(u.restore).pipe(e.dest(h,{cwd:c}))})),e.task("subMode:copyWxResource",(function(){let r=t.filter(["src/wxresource/**/*.js"],{restore:!0}),s=t.filter(["src/wxresource/**/*.wxss"],{restore:!0});return e.src(["src/wxresource/**","src/wxresource"],{allowEmpty:!0,cwd:c}).pipe(t.if("dev"===l,t.watch(["src/wxresource/**","src/wxresource","!/src/wxresource/**/*.*___jb_tmp___"],{cwd:c},(function(e){y("处理"+e.relative+"......")})))).pipe(r).pipe(t.replace(/^/,(function(e){return`require('${v(_(this.file.relative))}app.js');\n`}),{skipBinary:!1})).pipe(i()).pipe(b()).pipe(r.restore).pipe(s).pipe(t.stripCssComments()).pipe(t.replace(/(}|^|\s|;)__uniWxss\s*{([^{}]+)}/g,(function(e,n,t){let a="",r=_(this.file.relative);return(t+";").replace(/\s*import\s*:\s*(('[^\s']*')|("[^\s']*"))/g,(function(e,n){a+=`@import ${n.replace(/@wxResource\//g,v(r))};\n`})),n+a}),{skipBinary:!1})).pipe(t.replace(/^[\s\S]*$/,(function(e){let n=_(this.file.relative);return`@import ${'"@wxResource/app.wxss";'.replace(/@wxResource\//g,v(n))}`+`\n${e}`}),{skipBinary:!1})).pipe(s.restore).pipe(t.filter((async function(e){if("unlink"===e.event){try{await n([e.path.replace(a.resolve(c,"src/wxresource"),a.resolve(c,h))],{force:!0})}catch(e){}return!1}return!0}))).pipe(e.dest(h,{cwd:c}))})),e.task("mpWxSubMode",e.series((function(e){console.log("对uni-app进行解耦构建，解除uni-app对原生小程序方法的改写，此过程如果出现权限问题，请使用管理员权限运行"),e()}),"clean:previewDist",(async function e(n){try{let e={packPath:"/"+u.subPackagePath,appMode:u.appMode};await r.outputFile(h+"/pack.config.js",`module.exports=${JSON.stringify(e,null,4)}`)}catch(t){return void await k(async()=>{await e(n)})}n()}),function(){let n=[async function(e){let n=a.resolve(c,u.mainWeixinMpPath,"app.js");await r.exists(n)||await r.outputFile(n,"App({});"),e()},"subMode:createUniSubPackage","subMode:copyWxResource","watch:baseAppJson","watch:pagesJson","watch:mainAppJson","watch:mainWeixinMp"];return"build"===l?e.series.apply(this,n):e.parallel.apply(this,n)}(),(function(e){e(),"build"===l&&process.exit()}))),e.task("startToPackServe",e.series((async function(e){await r.exists(g)||await r.mkdirs(g),e()}),"clean:base",(function(n){e.watch(f+"/app.json",{events:["all"],cwd:c},(function(){n()}))}),"mpWxSubMode"))}();