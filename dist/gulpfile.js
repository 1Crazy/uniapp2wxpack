"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t=e(require("del")),r=e(require("gulp")),n=e(require("path")),a=e(require("commander")),s=e(require("single-line-log")),p=e(require("gulp-load-plugins")),i=e(require("vue-template-compiler")),c=e(require("preprocess")),o=e(require("fs-extra")),l=e(require("strip-json-comments")),u=e(require("gulp-strip-comments"));const{program:g}=a;g.option("--scope <type>","运行目录",process.cwd()).option("--plugin","插件模式").option("--type <type>","解耦包类型(哪种小程序)","weixin").option("--native","原生模式"),g.parse(process.argv);const f={weixin:{html:"wxml",css:"wxss",globalObject:"wx",mainMpPath:"mainWeixinMpPath",directivePrefix:"wx:"},baidu:{html:"swan",css:"css",globalObject:"swan",mainMpPath:"mainBaiduMpPath",directivePrefix:"s-"},toutiao:{html:"ttml",css:"ttss",globalObject:"tt",mainMpPath:"mainToutiaoMpPath",directivePrefix:"tt:"},alipay:{html:"axml",css:"acss",globalObject:"my",mainMpPath:"mainAlipayMpPath",directivePrefix:"a:"}},m=f[g.type];if(!m)throw Error("小程序类型错");process.env.PACK_TYPE=g.type;const h=g.scope,d=function(){return require.apply(null,arguments)}(n.resolve(h,"./projectToSubPackageConfig")),y=d.wxResourcePath||`src/${m.globalObject}resource`,P=d.wxResourceAlias||"@wxResource",v=RegExp(P+"\\/","g"),b=d.uniRequireApiName||"__uniRequireWx",w=RegExp(b+"\\(([a-zA-Z.\\/\"'@\\d]+)\\)","g"),k=d.uniImportWxssApiName||"__uniWxss",j=RegExp(`(}|^|\\s|;)${k}\\s*{([^{}]+)}`,"g");let x="dev";"production"===process.env.NODE_ENV&&(x="build");const $="dist/"+x+"/mp-"+g.type;let S="dist/"+x+`/mp-${g.type}-pack`;g.plugin&&(S="dist/"+x+`/mp-${g.type}-pack-plugin`);var _={pluginProcessFileTypes:d.pluginProcessFileTypes||["js","json","wxml","ttml","ttss","swan","css","html","wxss","htm","wxs","sjs","acss","axml"],currentNamespace:m,program:g,cwd:h,projectToSubPackageConfig:d,wxResourcePath:y,wxResourceAlias:P,regExpWxResources:v,uniRequireApiName:b,regExpUniRequire:w,uniImportWxssApiName:k,regExpUniImportWxss:j,configWxResourceKey:d.configWxResourceKey||"wxResource",env:x,base:$,target:S,basePath:n.resolve(h,$),subModePath:n.resolve(h,S,d.subPackagePath),targetPath:n.resolve(h,S),packIsSubpackage:{mode:!1},mpTypeNamespace:f};let E;const O=s.stdout;var A={tryAgain:async function(e){return new Promise(async t=>{setTimeout(async()=>{t(await e())},100)})},getLevelPath:function(e){return Array(e).fill("../").join("")},getLevel:function(e){return e.split(/[\\/]/).length-1},writeLastLine:function(e){O(e),clearTimeout(E),E=setTimeout(()=>{O("解耦构建，正在监听中......(此过程如果出现权限问题，请使用管理员权限运行)")},300)},deepFind:function e(t,r,n,a){r&&(r(t,n,a),t.childNodes?t.childNodes.forEach((t,n,a)=>{e(t,r,n,a)}):t.children&&t.children.forEach((t,n,a)=>{e(t,r,n,a)}))}};const{basePath:N}=_,{tryAgain:R}=A;r.task("clean:base",(async function e(r){try{await t([N+"/**/*"],{force:!0})}catch(t){return void await R(async()=>{await e(r)})}r()}));const{subModePath:T}=_,{tryAgain:M}=A;r.task("clean:subModePath",(async function e(r){try{await t([T+"/**/*"],{force:!0})}catch(t){return void await M(async()=>{await e(r)})}r()}));const{targetPath:C}=_,{tryAgain:L}=A;r.task("clean:previewDist",(async function e(r){try{await t([C+"/**/*"],{force:!0})}catch(t){return void await L(async()=>{await e(r)})}r()}));const{compile:B}=i;var q=class{constructor(e){this.topNode={children:[]},this.init(e)}init(e){this.topNode=B(`<div>${e}</div>`).ast}getAttr(e,t){return e.attrsMap&&e.attrsMap[t]||""}setAttr(e,t,r){if(!e.attrsMap)return"";e.attrsMap[t]=r}render(e=this.topNode.children,t=""){return e.reduce((e,t)=>{if(t.removed)return e;if(1===t.type&&!t.tag)return e;if(3===t.type||2===t.type)return e+=this.writeText(t);const{tag:r,attrsMap:n,children:a=[]}=t;return e+=this.writeOpenTag(r,n),e+=this.render(a),e+=this.writeCloseTag(r)},t)}writeOpenTag(e,t){if(t){const r=Object.keys(t).map(e=>t[e].indexOf('"')>-1&&0>t[e].indexOf("'")?`${e}='${t[e]}'`:`${e}="${t[e]}"`);return`<${e}${r.length>0?" "+r.join(" "):""}>`}return`<${e}>`}writeText(e){return e.text}writeCloseTag(e){return`</${e}>`}};const{currentNamespace:F,mpTypeNamespace:J}=_,{deepFind:W}=A,I=Object.keys(J).map(e=>J[e].directivePrefix),U=Object.keys(J).map(e=>J[e].html),K=RegExp(`^(${I.join("|")})`),D=RegExp(`\\.(${U.join("|")})$`,"i");var Y=function(e,t){if(t.relative.match(D)){const t=new q(e);return W(t.topNode,e=>{if(!e.tag||3===e.type)return;const r=t.getAttr(e,"class");"toutiao"===process.env.PACK_TYPE&&r&&!r.match(/(^\s|(\s$))/)&&t.setAttr(e,"class",r+" ");const n=t.getAttr(e,"catchTap");"toutiao"===process.env.PACK_TYPE&&n&&!t.getAttr(e,"bindTap")&&t.setAttr(e,"bindTap",n);const a=t.getAttr(e,"src");e.tag.match(/^(include|import)$/)&&a&&t.setAttr(e,"src",a.replace(D,"."+F.html)),e.attrsMap&&Object.keys(e.attrsMap).forEach(t=>{if(t.match(K)){const r=t.replace(K,F.directivePrefix);e.attrsMap[r]=e.attrsMap[t],r!==t&&delete e.attrsMap[t]}})}),t.render()}return e};const{currentNamespace:H,mpTypeNamespace:z}=_,V=Object.keys(z).map(e=>z[e].css),Z=RegExp(`\\.(${V.join("|")})$`,"i");var G=function(e,{relative:t}){return t.match(Z)&&(e=e.replace(/@import\s*['"](\S+)['"]/g,(function(e,t){return`@import '${t.replace(Z,"."+H.css)}'`}))),e};var Q=function(e,{relative:t}){return"toutiao"===process.env.PACK_TYPE&&t.match(/^\/app.js$/i)?"\nif (!Promise.prototype.finally) {\n    Promise.prototype.finally = function (callback) {\n        let P = this.constructor;\n        return this.then(\n            value  => P.resolve(callback()).then(() => value),\n            reason => P.resolve(callback()).then(() => { throw reason })\n        );\n    };\n}\n;\n"+e:e};const{preprocess:X}=c;var ee=function(e,{relative:t}){if(t.match(/.js$/i))try{return X(e,process.env,{type:"js"})}catch(t){return console.log("js条件编译出错"),console.log(t),e}return e};const{currentNamespace:te}=_,{preprocess:re}=c;var ne=function(e,{relative:t}){if(t.match(RegExp(`.${te.css}$`,"i")))try{return re(e,process.env,{type:"css"})}catch(t){return console.log(te.css+"条件编译出错"),console.log(t),e}return e};const{currentNamespace:ae}=_,{preprocess:se}=c;var pe={htmlMixinPlugin:Y,cssMixinPlugin:G,polyfillPlugin:Q,jsPreProcessPlugin:ee,cssPreProcessPlugin:ne,htmlPreProcessPlugin:function(e,{relative:t}){if(t.match(RegExp(`.${ae.html}$`,"i")))try{return se(e,process.env,{type:"html"})}catch(t){return console.log(ae.html+"条件编译出错"),console.log(t),e}return e}};const{projectToSubPackageConfig:ie,targetPath:ce}=_;(!ie.plugins||!ie.plugins instanceof Array)&&(ie.plugins=[]);var oe={runPlugins:function(e){return function(t){const{plugins:r}=ie;if(!r||!r instanceof Array)return;const a=n.resolve(e,this.file.relative),s={relative:a.replace(RegExp("^"+ce.replace(/\\/g,"\\\\")),"").replace(/\\/g,"/"),absolute:a};return r.reduce((e,t)=>{if("string"==typeof t&&(t=pe[t]),"function"!=typeof t)return e;const r=t(e,s,pe);return null==r?e:r},t)}}};const le=p(),{cwd:ue,projectToSubPackageConfig:ge,target:fe,env:me,pluginProcessFileTypes:he}=_,{writeLastLine:de}=A,{runPlugins:ye}=oe;r.task("watch:pluginJson",(function(){const e=le.filter(he.map(e=>"/**/*."+e),{restore:!0});return r.src("src/plugin.json",{allowEmpty:!0,cwd:ue}).pipe(le.if("dev"===me,le.watch("src/plugin.json",{cwd:ue},(function(e){de("处理"+e.relative+"......")})))).pipe(e).pipe(le.replace(/[\s\S]*/,ye(n.resolve(ue,fe+"/"+ge.subPackagePath)),{skipBinary:!1})).pipe(e.restore).pipe(r.dest(fe+"/"+ge.subPackagePath,{cwd:ue}))}));const Pe=p(),{cwd:ve,target:be,env:we,targetPath:ke,pluginProcessFileTypes:je}=_,{writeLastLine:xe}=A,{runPlugins:$e}=oe;r.task("watch:projectConfigJson",(function(){const e=Pe.filter(je.map(e=>"/**/*."+e),{restore:!0});return r.src("project.config.json",{allowEmpty:!0,cwd:ve}).pipe(Pe.if("dev"===we,Pe.watch("project.config.json",{cwd:ve},(function(e){xe("处理"+e.relative+"......")})))).pipe(e).pipe(Pe.replace(/[\s\S]*/,$e(ke),{skipBinary:!1})).pipe(e.restore).pipe(r.dest(be,{cwd:ve}))}));const{program:Se,cwd:_e,projectToSubPackageConfig:Ee,basePath:Oe,subModePath:Ae,targetPath:Ne,packIsSubpackage:Re,currentNamespace:Te}=_;var Me=function(){if(Se.plugin)return;const e=n.resolve(_e,Ee[Te.mainMpPath]+"/app.js");if(o.existsSync(e)){const t=o.readFileSync(e,"utf8");let r=`require('${`./${Ee.subPackagePath}/`}app.js');\n`;if(Ae===Ne){r=o.readFileSync(Oe+"/app.js","utf8")+";\n"}(Re.mode||Se.plugin)&&(r=""),o.outputFileSync(Ne+"/app.js",r+t)}};const Ce=p(),{program:Le,cwd:Be,projectToSubPackageConfig:qe,configWxResourceKey:Fe,base:Je,packIsSubpackage:We,currentNamespace:Ie}=_,{writeLastLine:Ue}=A;var Ke=function(e){return Ue("处理app.json......"),Ce.replace(/[\s\S]+/,(function(t){if(Le.plugin&&"mainAppJson"===e)return t;We.mode=!1;let r,a,s,p={};({pagesJson(){try{r=JSON.parse(l(t))}catch(e){r={}}},baseAppJson(){try{a=JSON.parse(t)}catch(e){a={}}},mainAppJson(){try{s=JSON.parse(t)}catch(e){s={}}}})[e]();try{r||(r=JSON.parse(l(o.readFileSync(n.resolve(Be,"src/pages.json"),"utf8"))))}catch(e){r={}}try{a||(a=JSON.parse(o.readFileSync(n.resolve(Be,Je+"/app.json"),"utf8")))}catch(e){a={}}try{s||(s=JSON.parse(o.readFileSync(n.resolve(Be,qe[Ie.mainMpPath]+"/app.json"),"utf8")))}catch(e){s={}}function i(e){return qe.subPackagePath+(qe.subPackagePath?"/":"")+e}if(s.subPackages){let e=s.subPackages.find(e=>e.root===qe.subPackagePath);if(e){We.mode=!0;let t=[...r[Fe]&&r[Fe].pages||[],...a.pages||[]];return a.subPackages&&a.subPackages.forEach(e=>{t=[...t,...(e.pages||[]).map(t=>e.root+(e.root?"/":"")+t)]}),r[Fe]&&r[Fe].subPackages&&r[Fe].subPackages.forEach(e=>{t=[...t,...(e.pages||[]).map(t=>e.root+(e.root?"/":"")+t)]}),e.pages=t,Me(),delete a.pages,delete a.subPackages,JSON.stringify({...a,...s},null,2)}}a.pages&&a.pages.forEach((e,t)=>{a.pages[t]=i(e)}),a.subPackages&&a.subPackages.forEach(e=>{e.root=i(e.root)}),r[Fe]&&(r[Fe].pages&&r[Fe].pages.forEach((e,t)=>{r[Fe].pages[t]=i(e)}),r[Fe].subPackages&&r[Fe].subPackages.forEach(e=>{e.root=i(e.root)})),a.tabBar&&a.tabBar.list&&a.tabBar.list.forEach(({pagePath:e,iconPath:t,selectedIconPath:r,...n},s)=>{a.tabBar.list[s]={pagePath:e?i(e):"",iconPath:t?i(t):"",selectedIconPath:r?i(r):"",...n}}),p={...a,...s},p.pages=Array.from(new Set([...r.indexPage?[i(r.indexPage)]:[],...s.pages||[],...a.pages||[],...r[Fe]&&r[Fe].pages||[]]));let c=[],u={};function g(e){e.forEach(e=>{u[e.root]=u[e.root]?Array.from(new Set([...u[e.root],...e.pages])):e.pages})}g(r[Fe]&&r[Fe].subPackages||[]),g(a.subPackages||[]),g(s.subPackages||[]);for(let e in u)c.push({root:e,pages:u[e]});if(p.subPackages=[...c],a.usingComponents){for(let e in a.usingComponents)a.usingComponents[e]="/"+qe.subPackagePath+a.usingComponents[e];p.usingComponents={...p.usingComponents||{},...a.usingComponents}}return Me(),"toutiao"===Le.type&&p.subPackages&&(p.subPackages.forEach(e=>{e.pages.forEach(t=>{p.pages.push((e.root+"/"+t).replace(/\/\//g,"/"))})}),delete p.subPackages),JSON.stringify(p,null,2)}),{skipBinary:!1})};const De=p(),{cwd:Ye,target:He,env:ze,targetPath:Ve,pluginProcessFileTypes:Ze}=_,{writeLastLine:Ge}=A,{runPlugins:Qe}=oe;r.task("watch:pagesJson",(function(){const e=De.filter(Ze.map(e=>"/**/*."+e),{restore:!0});return r.src("src/pages.json",{allowEmpty:!0,cwd:Ye}).pipe(De.if("dev"===ze,De.watch("src/pages.json",{cwd:Ye},(function(e){Ge("处理"+e.relative+"......")})))).pipe(Ke("pagesJson")).pipe(De.rename("app.json")).pipe(e).pipe(De.replace(/[\s\S]*/,Qe(Ve),{skipBinary:!1})).pipe(e.restore).pipe(r.dest(He,{cwd:Ye}))}));const Xe=p(),{cwd:et,target:tt,env:rt,base:nt,targetPath:at,pluginProcessFileTypes:st}=_,{writeLastLine:pt}=A,{runPlugins:it}=oe;r.task("watch:baseAppJson",(function(){const e=Xe.filter(st.map(e=>`${nt}/**/*.${e}`),{restore:!0});return r.src(nt+"/app.json",{allowEmpty:!0,cwd:et}).pipe(Xe.if("dev"===rt,Xe.watch(nt+"/app.json",{cwd:et},(function(e){pt("处理"+e.relative+"......")})))).pipe(Ke("baseAppJson")).pipe(e).pipe(Xe.replace(/[\s\S]*/,it(at),{skipBinary:!1})).pipe(e.restore).pipe(r.dest(tt,{cwd:et}))}));const ct=p(),{cwd:ot,target:lt,env:ut,projectToSubPackageConfig:gt,program:ft,currentNamespace:mt,pluginProcessFileTypes:ht}=_,{writeLastLine:dt}=A,{runPlugins:yt}=oe;r.task("watch:mainAppJson",(function(){const e=gt[mt.mainMpPath],t=ct.filter(ht.map(t=>`${e}/**/*.${t}`),{restore:!0});return r.src(e+"/app.json",{allowEmpty:!0,cwd:ot}).pipe(ct.if("dev"===ut,ct.watch(e+"/app.json",{cwd:ot},(function(e){dt("处理"+e.relative+"......")})))).pipe(Ke("mainAppJson")).pipe(t).pipe(ct.replace(/[\s\S]*/,yt(n.resolve(ot,lt+(ft.plugin?"/miniprogram":""))),{skipBinary:!1})).pipe(t.restore).pipe(r.dest(lt+(ft.plugin?"/miniprogram":""),{cwd:ot}))}));const Pt=p(),{cwd:vt,target:bt,env:wt,projectToSubPackageConfig:kt,program:jt,basePath:xt,currentNamespace:$t,mpTypeNamespace:St,pluginProcessFileTypes:_t}=_,{writeLastLine:Et}=A,{runPlugins:Ot}=oe;r.task("watch:topMode-mainAppJsAndAppWxss",(function(){let e=kt[$t.mainMpPath];const t=Object.keys(St).map(t=>`${e}/app.${St[t].css}`),a=Pt.filter([...t],{restore:!0}),s=Pt.filter([e+"/app.js"],{restore:!0}),p=Pt.filter(_t.map(t=>`${e}/**/*.${t}`),{restore:!0});return r.src([e+"/app.js",...t],{allowEmpty:!0,cwd:vt}).pipe(Pt.if("dev"===wt,Pt.watch([e+"/app.js",`${e}/app.${$t.css}`],{cwd:vt},(function(e){Et("处理"+e.relative+"......")})))).pipe(s).pipe(Pt.replace(/^/,(function(e){return o.readFileSync(xt+"/app.js","utf8")+";\n"}),{skipBinary:!1})).pipe(s.restore).pipe(a).pipe(Pt.replace(/^/,(function(e){return o.readFileSync(`${xt}/app.${$t.css}`,"utf8")+"\n"}),{skipBinary:!1})).pipe(Pt.rename((function(e){e.extname="."+$t.css}))).pipe(a.restore).pipe(p).pipe(Pt.replace(/[\s\S]*/,Ot(n.resolve(vt,bt+(jt.plugin?"/miniprogram":""))),{skipBinary:!1})).pipe(p.restore).pipe(r.dest(bt+(jt.plugin?"/miniprogram":""),{cwd:vt}))}));const{mpTypeNamespace:At,currentNamespace:Nt}=_,Rt=(process,new Set(Object.keys(At).map(e=>At[e].globalObject)));var Tt={mixinsEnvCode:function(e){let t="";return Rt.forEach(e=>{Nt.globalObject!==e&&(t+=`var ${e} = ${Nt.globalObject};\n`)}),t}};const Mt=p(),{cwd:Ct,target:Lt,env:Bt,projectToSubPackageConfig:qt,base:Ft,wxResourcePath:Jt,currentNamespace:Wt,mpTypeNamespace:It,pluginProcessFileTypes:Ut}=_,{writeLastLine:Kt}=A,{mixinsEnvCode:Dt}=Tt,{runPlugins:Yt}=oe;r.task("watch:mainWeixinMpPackPath",(function(){const e=qt[Wt.mainMpPath],a=e+"/"+qt.subPackagePath,s=Lt+"/"+qt.subPackagePath,p=[],i=[],c=new Set,l=new Set;Object.keys(It).forEach(e=>{p.push(`${a}/**/*.${It[e].css}`),i.push(`${a}/**/*.${It[e].html}`),c.add("."+It[e].css),l.add("."+It[e].html)});const u=Mt.filter([...i],{restore:!0}),g=Mt.filter([...p],{restore:!0}),f=Mt.filter([a+"/**/*.js"],{restore:!0}),m=Mt.filter(Ut.map(e=>`${a}/**/*.${e}`),{restore:!0});return r.src([a,a+"/**/*","!"+a+"/pack.config.js"],{allowEmpty:!0,cwd:Ct}).pipe(Mt.if("dev"===Bt,Mt.watch([a,a+"/**/*","!/"+a+"/pack.config.js"],{cwd:Ct},(function(e){Kt("处理"+e.relative+"......")})))).pipe(Mt.filter((function(r){if("project.config.json"!==r.relative&&!function(e){const t=qt[Wt.mainMpPath]+"/"+qt.subPackagePath;return!o.existsSync(e.path.replace(n.resolve(Ct,t),n.resolve(Ct,Ft)))&&!o.existsSync(e.path.replace(n.resolve(Ct,t),n.resolve(Ct,Jt)))}(r))return!1;if("unlink"===r.event){try{let a=r.path;const s=RegExp(r.extname+"$","i");c.has(r.extname)&&(a=a.replace(s,"."+Wt.css)),l.has(r.extname)&&(a=a.replace(s,"."+Wt.html)),t.sync([a.replace(n.resolve(Ct,e),n.resolve(Ct,Lt))],{force:!0})}catch(e){}return!1}return!0}))).pipe(u).pipe(Mt.rename((function(e){e.extname="."+Wt.html}))).pipe(u.restore).pipe(g).pipe(Mt.rename((function(e){e.extname="."+Wt.css}))).pipe(g.restore).pipe(f).pipe(Mt.replace(/[\s\S]*/,(function(e){return Dt(e)+e}),{skipBinary:!1})).pipe(f.restore).pipe(m).pipe(Mt.replace(/[\s\S]*/,Yt(n.resolve(Ct,s)),{skipBinary:!1})).pipe(m.restore).pipe(r.dest(s,{cwd:Ct}))}));const Ht=p(),{cwd:zt,target:Vt,env:Zt,projectToSubPackageConfig:Gt,basePath:Qt,subModePath:Xt,targetPath:er,program:tr,packIsSubpackage:rr,currentNamespace:nr,mpTypeNamespace:ar,pluginProcessFileTypes:sr}=_,{writeLastLine:pr}=A,{mixinsEnvCode:ir}=Tt,{runPlugins:cr}=oe;r.task("watch:mainWeixinMp",(function(){const e=Gt[nr.mainMpPath],a=e+"/"+Gt.subPackagePath,s=[],p=[],i=new Set,c=new Set;Object.keys(ar).forEach(t=>{s.push(`${e}/**/*.${ar[t].css}`),p.push(`${e}/**/*.${ar[t].html}`),i.add("."+ar[t].css),c.add("."+ar[t].html)});const o=Ht.filter([e+"/app.js"],{restore:!0}),l=Ht.filter([e+"/**/*.js"],{restore:!0}),u=Ht.filter([...p],{restore:!0}),g=Ht.filter([...s],{restore:!0}),f=Ht.filter(sr.map(t=>`${e}/**/*.${t}`),{restore:!0});return r.src([e+"/**/*","!"+e+"/app.json","!"+e+"/**/*.json___jb_tmp___","!"+e+`/**/*.${nr.html}___jb_tmp___`,"!"+e+`/**/*.${nr.css}___jb_tmp___`,"!"+e+"/**/*.js___jb_tmp___","!"+a+"/**/*"],{base:n.resolve(zt,e),allowEmpty:!0,cwd:zt}).pipe(Ht.if("dev"===Zt,Ht.watch([e+"/**/*","!/"+e+"/app.json","!/"+a+"/**/*"],{cwd:zt},(function(e){e.relative.match(/.json/),pr("处理"+e.relative+"......")})))).pipe(Ht.filter((function(r){if("unlink"===r.event){try{let a=r.path;const s=RegExp(r.extname+"$","i");i.has(r.extname)&&(a=a.replace(s,"."+nr.css)),c.has(r.extname)&&(a=a.replace(s,"."+nr.html)),t.sync([a.replace(n.resolve(zt,e),n.resolve(zt,Vt))],{force:!0})}catch(e){}return!1}return!0}))).pipe(l).pipe(Ht.replace(/[\s\S]*/,(function(e){return ir(e)+e}),{skipBinary:!1})).pipe(l.restore).pipe(o).pipe(Ht.replace(/^/,(function(e){if(rr.mode||tr.plugin)return"";let t=`./${Gt.subPackagePath}/`;if(Xt===er){return fs.readFileSync(Qt+"/app.js","utf8")+";\n"}return`require('${t}app.js');\n`}),{skipBinary:!1})).pipe(o.restore).pipe(u).pipe(Ht.rename((function(e){e.extname="."+nr.html}))).pipe(u.restore).pipe(g).pipe(Ht.rename((function(e){e.extname="."+nr.css}))).pipe(g.restore).pipe(f).pipe(Ht.replace(/[\s\S]*/,cr(n.resolve(zt,Vt+(tr.plugin?"/miniprogram":""))),{skipBinary:!1})).pipe(f.restore).pipe(r.dest(Vt+(tr.plugin?"/miniprogram":""),{cwd:zt}))}));var or={fakeUniBootstrap:function(e,t,r,n){globalObject.__uniapp2wxpack||(globalObject.__uniapp2wxpack={platform:n}),"alipay"===n&&(n="top");var a=globalObject.__uniapp2wxpack[t.replace("/","")]={__packInit:{}};if(e)for(var s in e)"function"!=typeof e[s]?a.__packInit[s]=e[s]:function(t){a.__packInit[t]=function(){return e[t].apply(e,arguments)}}(s);else e={};if("none"!==r){var p=Page,i=Component,c="",o=1,l=1;"function"==typeof e.onError&&globalObject.onError&&globalObject.onError((function(){return e.onError.apply(e,arguments)})),"function"==typeof e.onPageNotFound&&globalObject.onPageNotFound&&globalObject.onPageNotFound((function(){return e.onPageNotFound.apply(e,arguments)})),"function"==typeof e.onUnhandledRejection&&globalObject.onUnhandledRejection&&globalObject.onUnhandledRejection((function(){return e.onUnhandledRejection.apply(e,arguments)})),globalObject.onAppRoute&&globalObject.onAppRoute((function(n){"top"!==r&&0!==("/"+n.path).indexOf(t+"/")&&(o=1,e.onHide.call(e,globalObject.getLaunchOptionsSync())),c=n.path})),globalObject.onAppHide((function(){if("top"===r)return e.onHide.call(e,globalObject.getLaunchOptionsSync());var n=getCurrentPages();return 0===("/"+(null==n[n.length-1].route?n[n.length-1].__route__:n[n.length-1].route)).indexOf(t+"/")?(o=1,c="",e.onHide.call(e,globalObject.getLaunchOptionsSync())):void 0})),globalObject.onAppShow((function(){"top"===r&&"function"==typeof e.onShow&&e.onShow.call(e,globalObject.getLaunchOptionsSync()),l&&getApp()&&(getApp().globalData||(getApp().globalData={}),Object.assign(getApp().globalData,e.globalData||{})),l=0})),"top"===r&&l&&"function"==typeof e.onLaunch&&e.onLaunch.call(e,globalObject.getLaunchOptionsSync()),Page=function(e){return u(e),p.call(this,e)},Component=function(e){return u(e.methods||{}),i.call(this,e)}}function u(n){if("top"!==r){var a=n.onShow;"function"!=typeof e.onShow&&"function"!=typeof e.onLaunch||(n.onShow=function(){var r=getCurrentPages(),n=null==r[r.length-1].route?r[r.length-1].__route__:r[r.length-1].route;if(c&&0===("/"+c).indexOf(t+"/")||0!==("/"+n).indexOf(t+"/")||(o&&(o=0,e.onLaunch.call(e,globalObject.getLaunchOptionsSync())),e.onShow.call(e,globalObject.getLaunchOptionsSync())),"function"==typeof a)return a.apply(this,arguments)})}}},fakeUniBootstrapName:"fakeUniBootstrap"};const lr=p(),{regExpWxResources:ur,regExpUniRequire:gr}=_,{getLevelPath:fr,getLevel:mr}=A;var hr={uniRequireWxResource:function(){return lr.replace(/[\s\S]*/,(function(e,t){const r=["var __uniPackNativeRequireInject={};\n"],n=mr(this.file.relative);return e=e.replace(gr,(e,t)=>{console.log(`\n编译${e}--\x3erequire(${t.replace(ur,fr(n))})`);const a=t.replace(ur,fr(n)),s=`__uniPackNativeRequireInject[${a}] = require(${a});\n`;return 0>r.indexOf(s)&&r.push(s),`__uniPackNativeRequireInject[${a}]`}),r[1]?`${r.join("")} ${e}`:e}),{skipBinary:!1})}};const{currentNamespace:dr,regExpWxResources:yr,wxResourceAlias:Pr}=_,{getLevelPath:vr,getLevel:br}=A;var wr=function(e,t){const r=br(t);return"@import "+`"${Pr}/common/main.${dr.css}";`.replace(yr,vr(r))+("\n"+e)};const kr=p(),{fakeUniBootstrapName:jr,fakeUniBootstrap:xr}=or,{cwd:$r,env:Sr,program:_r,basePath:Er,targetPath:Or,subModePath:Ar,base:Nr,regExpUniRequire:Rr,regExpWxResources:Tr,regExpUniImportWxss:Mr,currentNamespace:Cr,mpTypeNamespace:Lr,pluginProcessFileTypes:Br}=_,qr=process.env.PACK_TYPE,{writeLastLine:Fr,getLevel:Jr,getLevelPath:Wr,deepFind:Ir}=A,{mixinsEnvCode:Ur}=Tt,{uniRequireWxResource:Kr}=hr,{runPlugins:Dr}=oe,Yr=Object.keys(Lr).map(e=>Lr[e].css),Hr=new Set(Yr);r.task("subMode:createUniSubPackage",(function(){o.mkdirsSync(Er);const e=kr.filter(Nr+"/**/*.js",{restore:!0}),a=kr.filter([Nr+"/common/vendor.js"],{restore:!0}),s=kr.filter([Nr+"/common/main.js"],{restore:!0}),p=kr.filter(Br.map(e=>`${Nr}/**/*.${e}`),{restore:!0}),i=kr.filter([Nr+"/**/*.js","!"+Nr+"/app.js","!"+Nr+"/common/vendor.js","!"+Nr+"/common/main.js","!"+Nr+"/common/runtime.js"],{restore:!0}),c=kr.filter([`${Nr}/**/*.${Cr.css}`,`!${Nr}/app.${Cr.css}`,`!${Nr}/common/main.${Cr.css}`],{restore:!0}),l=kr.filter([`${Nr}/**/*.${Cr.css}`,`!${Nr}/app.${Cr.css}`],{restore:!0}),g=kr.filter([Nr+"/**/*.json"],{restore:!0}),f=kr.filter([`${Nr}/**/*.${Cr.html}`],{restore:!0});return r.src([Nr+"/**","!"+Nr+"/*.*",Nr+"/app.js",`${Nr}/app.${Cr.css}`],{allowEmpty:!0,cwd:$r}).pipe(kr.if("dev"===Sr,kr.watch([Nr+"/**/*","!/"+Nr+"/*.json"],{cwd:$r},(function(e){Fr("处理"+e.relative+"......")})))).pipe(kr.filter((function(e){if(function(e){const t=n.resolve(Or,"app.js"),r=n.resolve(Or,"app."+Cr.css),a=e.path.replace(Er,Ar);return t===a||r===a}(e))return!1;if("unlink"===e.event){try{let r=e.path;const a=RegExp(e.extname+"$","i");Hr.has(e.extname.substr(1))&&(r=r.replace(a,"."+Cr.css)),t.sync([r.replace(Er,n.resolve($r,Ar))],{force:!0})}catch(e){}return!1}return!0}))).pipe(f).pipe(kr.replace(/[\s\S]*/,(function(e){const t=this.file.path.replace(RegExp(Cr.html+"$","i"),Cr.css),r=this.file.relative.replace(RegExp(Cr.html+"$","i"),Cr.css);o.existsSync(t)||o.outputFileSync(n.resolve($r,Ar,r),wr("",r));const a=new q(e);let s=0;return Ir(a.topNode,e=>{if(1===e.type&&"wxs"===e.tag&&1===e.children.length&&3===e.children[0].type){e.children[0].text.replace(Rr,(t,r,n,a)=>{const p=Jr(this.file.relative),i=r.replace(Tr,Wr(p)).replace(/['"]/g,"");e.attrsMap.src=i,e.children=[],s=1,console.log(`\n编译${t}--\x3erequire(${i})`)})}}),s?a.render():e}),{skipBinary:!1})).pipe(f.restore).pipe(a).pipe(kr.replace(/^/,(function(e){return _r.plugin?`var App=function(packInit){};${Cr.globalObject}.canIUse=function(){return false};`:`var __packConfig=require('../pack.config.js');var App=function(packInit){var ${jr}=${(""+xr).replace(/globalObject/g,Cr.globalObject)};${jr}(packInit,__packConfig.packPath,__packConfig.appMode,'${qr}');};`}),{skipBinary:!1})).pipe(a.restore).pipe(e).pipe(u()).pipe(Kr()).pipe(kr.replace(/[\s\S]*/,(function(e){return Ur(e)+e}),{skipBinary:!1})).pipe(e.restore).pipe(s).pipe(kr.replace(/^/,(function(e){return"var __uniPluginExports={};\n"}),{skipBinary:!1})).pipe(kr.replace(/$/,(function(e){return"\nmodule.exports=__uniPluginExports;"}),{skipBinary:!1})).pipe(s.restore).pipe(i).pipe(kr.replace(/^/,(function(e){if(o.existsSync(n.resolve($r,"src",this.file.relative)))return e;return`require('${Wr(Jr(this.file.relative))}app.js');\n`}),{skipBinary:!1})).pipe(i.restore).pipe(g).pipe(kr.replace(/[\s\S]*/,(function(e){if(!o.existsSync(n.resolve($r,"src",this.file.relative.replace(/json$/,"vue")))&&!o.existsSync(n.resolve($r,"src",this.file.relative.replace(/json$/,"nvue"))))return e;let t=JSON.parse(""+this.file.contents);for(let e in t.usingComponents)0===t.usingComponents[e].indexOf("/")&&(t.usingComponents[e]=Wr(Jr(this.file.relative))+t.usingComponents[e].replace(/^\//,""));return JSON.stringify(t)}),{skipBinary:!1})).pipe(g.restore).pipe(l).pipe(kr.stripCssComments()).pipe(kr.replace(Mr,(function(e,t,r){let n="",a=Jr(this.file.relative);return(r+=";").replace(/\s*import\s*:\s*(('[^\s';]*')|("[^\s";]*"))/g,(function(e,t){const r=RegExp(`(${Yr.join("|")})(['"])$`);t=t.replace(r,Cr.css+"$2"),n+=`@import ${t.replace(Tr,Wr(a))};\n`})),t+n}),{skipBinary:!1})).pipe(l.restore).pipe(c).pipe(kr.stripCssComments()).pipe(kr.replace(/^[\s\S]*$/,(function(e){return Ar===Or?e:wr(e,this.file.relative)}),{skipBinary:!1})).pipe(c.restore).pipe(p).pipe(kr.replace(/[\s\S]*/,Dr(Ar),{skipBinary:!1})).pipe(p.restore).pipe(r.dest(Ar,{cwd:$r}))}));const zr=p(),{cwd:Vr,env:Zr,targetPath:Gr,subModePath:Qr,regExpWxResources:Xr,regExpUniImportWxss:en,wxResourcePath:tn,currentNamespace:rn,mpTypeNamespace:nn,pluginProcessFileTypes:an}=_,{writeLastLine:sn,getLevel:pn,getLevelPath:cn}=A,{mixinsEnvCode:on}=Tt,{uniRequireWxResource:ln}=hr,{runPlugins:un}=oe,gn=[],fn=[],mn=[],hn=new Set,dn=new Set;Object.keys(nn).forEach(e=>{gn.push(nn[e].css),fn.push(`${tn}/**/*.${nn[e].css}`),mn.push(`${tn}/**/*.${nn[e].html}`),hn.add("."+nn[e].css),dn.add("."+nn[e].html)}),r.task("subMode:copyWxResource",(function(){const e=zr.filter([tn+"/**/*.js"],{restore:!0}),a=zr.filter([...fn],{restore:!0}),s=zr.filter([...mn],{restore:!0}),p=zr.filter(an.map(e=>`${tn}/**/*${e}`),{restore:!0});return r.src([tn+"/**",tn],{allowEmpty:!0,cwd:Vr}).pipe(zr.if("dev"===Zr,zr.watch([tn+"/**",tn,`!/${tn}/**/*.*___jb_tmp___`],{cwd:Vr},(function(e){sn("处理"+e.relative+"......")})))).pipe(e).pipe(zr.replace(/[\s\S]*/,(function(e){return on(e)+e}),{skipBinary:!1})).pipe(zr.replace(/^/,(function(e){return`require('${cn(pn(this.file.relative))}app.js');\n`}),{skipBinary:!1})).pipe(u()).pipe(ln()).pipe(e.restore).pipe(a).pipe(zr.stripCssComments()).pipe(zr.replace(en,(function(e,t,r){let n="";pn(this.file.relative);return t+n}),{skipBinary:!1})).pipe(zr.replace(/^[\s\S]*$/,(function(e){return Qr===Gr?e:wr(e,this.file.relative)}),{skipBinary:!1})).pipe(zr.rename((function(e){e.extname="."+rn.css}))).pipe(a.restore).pipe(s).pipe(zr.rename((function(e){e.extname="."+rn.html}))).pipe(s.restore).pipe(zr.filter((function(e){if("unlink"===e.event){try{let r=e.path;const a=RegExp(e.extname+"$","i");hn.has(e.extname)&&(r=r.replace(a,"."+rn.css)),dn.has(e.extname)&&(r=r.replace(a,"."+rn.html)),t.sync([r.replace(n.resolve(Vr,tn),n.resolve(Vr,Qr))],{force:!0})}catch(e){}return!1}return!0}))).pipe(p).pipe(zr.replace(/[\s\S]*/,un(Qr),{skipBinary:!1})).pipe(p.restore).pipe(r.dest(Qr,{cwd:Vr}))}));const yn=p(),{cwd:Pn,target:vn,env:bn,projectToSubPackageConfig:wn,currentNamespace:kn,mpTypeNamespace:jn,pluginProcessFileTypes:xn}=_,{writeLastLine:$n}=A,{mixinsEnvCode:Sn}=Tt,{runPlugins:_n}=oe;r.task("watch:native",(function(){const e=wn[kn.mainMpPath],a=[],s=[],p=new Set,i=new Set;Object.keys(jn).forEach(t=>{a.push(`${e}/**/*.${jn[t].css}`),s.push(`${e}/**/*.${jn[t].html}`),p.add("."+jn[t].css),i.add("."+jn[t].html)});const c=yn.filter([e+"/**/*.js"],{restore:!0}),o=yn.filter([...s],{restore:!0}),l=yn.filter([...a],{restore:!0}),u=yn.filter(xn.map(t=>`${e}/**/*.${t}`),{restore:!0});return r.src([e+"/**/*","!"+e+"/app.json"],{base:n.resolve(Pn,e),allowEmpty:!0,cwd:Pn}).pipe(yn.if("dev"===bn,yn.watch([e+"/**/*","!/"+e+"/app.json"],{cwd:Pn},(function(e){$n("处理"+e.relative+"......")})))).pipe(yn.filter((function(r){if("unlink"===r.event){try{let a=r.path;const s=RegExp(r.extname+"$","i");p.has(r.extname)&&(a=a.replace(s,"."+kn.css)),i.has(r.extname)&&(a=a.replace(s,"."+kn.html)),t.sync([a.replace(n.resolve(Pn,e),n.resolve(Pn,vn))],{force:!0})}catch(e){console.log(e)}return!1}return!0}))).pipe(c).pipe(yn.replace(/[\s\S]*/,(function(e){return Sn(e)+e}),{skipBinary:!1})).pipe(c.restore).pipe(o).pipe(yn.rename((function(e){e.extname="."+kn.html}))).pipe(o.restore).pipe(l).pipe(yn.rename((function(e){e.extname="."+kn.css}))).pipe(l.restore).pipe(u).pipe(yn.replace(/[\s\S]*/,_n(n.resolve(Pn,vn)),{skipBinary:!1})).pipe(u.restore).pipe(r.dest(vn,{cwd:Pn}))}));const{cwd:En,env:On,targetPath:An,subModePath:Nn,projectToSubPackageConfig:Rn,program:Tn,currentNamespace:Mn}=_,{tryAgain:Cn}=A;async function Ln(e){let t=n.resolve(En,Rn[Mn.mainMpPath],"app.js");await o.exists(t)||await o.outputFile(t,"App({});"),e()}r.task("mpWxSubMode",r.series((function(e){console.log("小程序解耦构建开启，此过程如果出现权限问题，请使用管理员权限运行"),e()}),"clean:previewDist",(async function e(t){if(Tn.plugin||Tn.native)t();else{try{let e={packPath:(Rn.subPackagePath?"/":"")+Rn.subPackagePath,appMode:Rn.appMode};await o.outputFile(Nn+"/pack.config.js","module.exports="+JSON.stringify(e,null,4))}catch(r){return void await Cn(async()=>{await e(t)})}t()}}),function(){let e=[Ln,"subMode:createUniSubPackage","subMode:copyWxResource",...Tn.plugin?["watch:pluginJson"]:["watch:baseAppJson","watch:pagesJson",...Rn.mergePack?["watch:mainWeixinMpPackPath"]:[],...Nn===An?["watch:topMode-mainAppJsAndAppWxss"]:[]],"watch:mainAppJson","watch:mainWeixinMp","watch:projectConfigJson"];return Tn.native&&(e=[Ln,"watch:mainAppJson","watch:native"]),"build"===On?r.series.apply(this,e):r.parallel.apply(this,e)}(),(function(e){e(),"build"===On&&process.exit()})));const{cwd:Bn,basePath:qn,base:Fn,program:Jn}=_;r.task("startToPackServe",r.series((async function(e){Jn.native||await o.exists(qn)||await o.mkdirs(qn),e()}),"clean:base",(function(e){Jn.native?e():r.watch(Fn+"/app.json",{events:["all"],cwd:Bn},(function(){e()}))}),"mpWxSubMode")),process.on("unhandledRejection",()=>{});
