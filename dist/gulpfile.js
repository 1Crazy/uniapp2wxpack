"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t=e(require("del")),r=e(require("gulp")),n=e(require("path")),a=e(require("commander")),s=e(require("single-line-log")),p=e(require("gulp-load-plugins")),i=e(require("vue-template-compiler")),o=e(require("preprocess")),c=e(require("fs-extra")),l=e(require("strip-json-comments")),u=e(require("gulp-strip-comments"));const{program:g}=a;g.option("--scope <type>","运行目录",process.cwd()).option("--plugin","插件模式").option("--type <type>","解耦包类型(哪种小程序)","weixin").option("--native","原生模式"),g.parse(process.argv);const f={weixin:{html:"wxml",css:"wxss",globalObject:"wx",mainMpPath:"mainWeixinMpPath",directivePrefix:"wx:"},baidu:{html:"swan",css:"css",globalObject:"swan",mainMpPath:"mainBaiduMpPath",directivePrefix:"s-"},toutiao:{html:"ttml",css:"ttss",globalObject:"tt",mainMpPath:"mainToutiaoMpPath",directivePrefix:"tt:"}},m=f[g.type];if(!m)throw Error("小程序类型错");process.env.PACK_TYPE=g.type;const h=g.scope,d=function(){return require.apply(null,arguments)}(n.resolve(h,"./projectToSubPackageConfig")),y=d.wxResourcePath||`src/${m.globalObject}resource`,P=d.wxResourceAlias||"@wxResource",b=RegExp(P+"\\/","g"),v=d.uniRequireApiName||"__uniRequireWx",w=RegExp(v+"\\(([a-zA-Z.\\/\"'@\\d]+)\\)","g"),k=d.uniImportWxssApiName||"__uniWxss",j=RegExp(`(}|^|\\s|;)${k}\\s*{([^{}]+)}`,"g");let x="dev";"production"===process.env.NODE_ENV&&(x="build");const $="dist/"+x+"/mp-"+g.type;let S="dist/"+x+`/mp-${g.type}-pack`;g.plugin&&(S="dist/"+x+`/mp-${g.type}-pack-plugin`);var _={pluginProcessFileTypes:d.pluginProcessFileTypes||["js","json","wxml","ttml","ttss","swan","css","html","wxss","htm","wxs","sjs"],currentNamespace:m,program:g,cwd:h,projectToSubPackageConfig:d,wxResourcePath:y,wxResourceAlias:P,regExpWxResources:b,uniRequireApiName:v,regExpUniRequire:w,uniImportWxssApiName:k,regExpUniImportWxss:j,configWxResourceKey:d.configWxResourceKey||"wxResource",env:x,base:$,target:S,basePath:n.resolve(h,$),subModePath:n.resolve(h,S,d.subPackagePath),targetPath:n.resolve(h,S),packIsSubpackage:{mode:!1},mpTypeNamespace:f};let E;const O=s.stdout;var A={tryAgain:async function(e){return new Promise(async t=>{setTimeout(async()=>{t(await e())},100)})},getLevelPath:function(e){return Array(e).fill("../").join("")},getLevel:function(e){return e.split(/[\\/]/).length-1},writeLastLine:function(e){O(e),clearTimeout(E),E=setTimeout(()=>{O("解耦构建，正在监听中......(此过程如果出现权限问题，请使用管理员权限运行)")},300)},deepFind:function e(t,r,n,a){r&&(r(t,n,a),t.childNodes?t.childNodes.forEach((t,n,a)=>{e(t,r,n,a)}):t.children&&t.children.forEach((t,n,a)=>{e(t,r,n,a)}))}};const{basePath:N}=_,{tryAgain:T}=A;r.task("clean:base",(async function e(r){try{await t([N+"/**/*"],{force:!0})}catch(t){return void await T(async()=>{await e(r)})}r()}));const{subModePath:R}=_,{tryAgain:C}=A;r.task("clean:subModePath",(async function e(r){try{await t([R+"/**/*"],{force:!0})}catch(t){return void await C(async()=>{await e(r)})}r()}));const{targetPath:M}=_,{tryAgain:L}=A;r.task("clean:previewDist",(async function e(r){try{await t([M+"/**/*"],{force:!0})}catch(t){return void await L(async()=>{await e(r)})}r()}));const{compile:B}=i;var F=class{constructor(e){this.topNode={children:[]},this.init(e)}init(e){this.topNode=B(`<div>${e}</div>`).ast}getAttr(e,t){return e.attrsMap&&e.attrsMap[t]||""}setAttr(e,t,r){if(!e.attrsMap)return"";e.attrsMap[t]=r}render(e=this.topNode.children,t=""){return e.reduce((e,t)=>{if(t.removed)return e;if(1===t.type&&!t.tag)return e;if(3===t.type||2===t.type)return e+=this.writeText(t);const{tag:r,attrsMap:n,children:a=[]}=t;return e+=this.writeOpenTag(r,n),e+=this.render(a),e+=this.writeCloseTag(r)},t)}writeOpenTag(e,t){if(t){const r=Object.keys(t).map(e=>t[e].indexOf('"')>-1&&0>t[e].indexOf("'")?`${e}='${t[e]}'`:`${e}="${t[e]}"`);return`<${e}${r.length>0?" "+r.join(" "):""}>`}return`<${e}>`}writeText(e){return e.text}writeCloseTag(e){return`</${e}>`}};const{currentNamespace:J,mpTypeNamespace:q}=_,{deepFind:W}=A,I=Object.keys(q).map(e=>q[e].directivePrefix),U=Object.keys(q).map(e=>q[e].html),K=RegExp(`^(${I.join("|")})`),D=RegExp(`\\.(${U.join("|")})$`,"i");var Y=function(e,t){if(t.relative.match(D)){const t=new F(e);return W(t.topNode,e=>{if(!e.tag||3===e.type)return;const r=t.getAttr(e,"class");"toutiao"===process.env.PACK_TYPE&&r&&!r.match(/(^\s|(\s$))/)&&t.setAttr(e,"class",r+" ");const n=t.getAttr(e,"catchTap");"toutiao"===process.env.PACK_TYPE&&n&&!t.getAttr(e,"bindTap")&&t.setAttr(e,"bindTap",n);const a=t.getAttr(e,"src");e.tag.match(/^(include|import)$/)&&a&&t.setAttr(e,"src",a.replace(D,"."+J.html)),e.attrsMap&&Object.keys(e.attrsMap).forEach(t=>{if(t.match(K)){const r=t.replace(K,J.directivePrefix);e.attrsMap[r]=e.attrsMap[t],r!==t&&delete e.attrsMap[t]}})}),t.render()}return e};const{currentNamespace:H,mpTypeNamespace:z}=_,V=Object.keys(z).map(e=>z[e].css),Z=RegExp(`\\.(${V.join("|")})$`,"i");var G=function(e,{relative:t}){return t.match(Z)&&(e=e.replace(/@import\s*['"](\S+)['"]/g,(function(e,t){return`@import '${t.replace(Z,"."+H.css)}'`}))),e};var Q=function(e,{relative:t}){return"toutiao"===process.env.PACK_TYPE&&t.match(/^\/app.js$/i)?"\nif (!Promise.prototype.finally) {\n    Promise.prototype.finally = function (callback) {\n        let P = this.constructor;\n        return this.then(\n            value  => P.resolve(callback()).then(() => value),\n            reason => P.resolve(callback()).then(() => { throw reason })\n        );\n    };\n}\n;\n"+e:e};const{preprocess:X}=o;var ee=function(e,{relative:t}){if(t.match(/.js$/i))try{return X(e,process.env,{type:"js"})}catch(t){return console.log("js条件编译出错"),console.log(t),e}return e};const{currentNamespace:te}=_,{preprocess:re}=o;var ne=function(e,{relative:t}){if(t.match(RegExp(`.${te.css}$`,"i")))try{return re(e,process.env,{type:"css"})}catch(t){return console.log(te.css+"条件编译出错"),console.log(t),e}return e};const{currentNamespace:ae}=_,{preprocess:se}=o;var pe={htmlMixinPlugin:Y,cssMixinPlugin:G,polyfillPlugin:Q,jsPreProcessPlugin:ee,cssPreProcessPlugin:ne,htmlPreProcessPlugin:function(e,{relative:t}){if(t.match(RegExp(`.${ae.html}$`,"i")))try{return se(e,process.env,{type:"html"})}catch(t){return console.log(ae.html+"条件编译出错"),console.log(t),e}return e}};const{projectToSubPackageConfig:ie,targetPath:oe}=_;(!ie.plugins||!ie.plugins instanceof Array)&&(ie.plugins=[]);var ce={runPlugins:function(e){return function(t){const{plugins:r}=ie;if(!r||!r instanceof Array)return;const a=n.resolve(e,this.file.relative),s={relative:a.replace(RegExp("^"+oe.replace(/\\/g,"\\\\")),"").replace(/\\/g,"/"),absolute:a};return r.reduce((e,t)=>{if("string"==typeof t&&(t=pe[t]),"function"!=typeof t)return e;const r=t(e,s,pe);return null==r?e:r},t)}}};const le=p(),{cwd:ue,projectToSubPackageConfig:ge,target:fe,env:me,pluginProcessFileTypes:he}=_,{writeLastLine:de}=A,{runPlugins:ye}=ce;r.task("watch:pluginJson",(function(){const e=le.filter(he.map(e=>"/**/*."+e),{restore:!0});return r.src("src/plugin.json",{allowEmpty:!0,cwd:ue}).pipe(le.if("dev"===me,le.watch("src/plugin.json",{cwd:ue},(function(e){de("处理"+e.relative+"......")})))).pipe(e).pipe(le.replace(/[\s\S]*/,ye(n.resolve(ue,fe+"/"+ge.subPackagePath)),{skipBinary:!1})).pipe(e.restore).pipe(r.dest(fe+"/"+ge.subPackagePath,{cwd:ue}))}));const Pe=p(),{cwd:be,target:ve,env:we,targetPath:ke,pluginProcessFileTypes:je}=_,{writeLastLine:xe}=A,{runPlugins:$e}=ce;r.task("watch:projectConfigJson",(function(){const e=Pe.filter(je.map(e=>"/**/*."+e),{restore:!0});return r.src("project.config.json",{allowEmpty:!0,cwd:be}).pipe(Pe.if("dev"===we,Pe.watch("project.config.json",{cwd:be},(function(e){xe("处理"+e.relative+"......")})))).pipe(e).pipe(Pe.replace(/[\s\S]*/,$e(ke),{skipBinary:!1})).pipe(e.restore).pipe(r.dest(ve,{cwd:be}))}));const{program:Se,cwd:_e,projectToSubPackageConfig:Ee,basePath:Oe,subModePath:Ae,targetPath:Ne,packIsSubpackage:Te,currentNamespace:Re}=_;var Ce=function(){if(Se.plugin)return;const e=n.resolve(_e,Ee[Re.mainMpPath]+"/app.js");if(c.existsSync(e)){const t=c.readFileSync(e,"utf8");let r=`require('${`./${Ee.subPackagePath}/`}app.js');\n`;if(Ae===Ne){r=c.readFileSync(Oe+"/app.js","utf8")+";\n"}(Te.mode||Se.plugin)&&(r=""),c.outputFileSync(Ne+"/app.js",r+t)}};const Me=p(),{program:Le,cwd:Be,projectToSubPackageConfig:Fe,configWxResourceKey:Je,base:qe,packIsSubpackage:We,currentNamespace:Ie}=_,{writeLastLine:Ue}=A;var Ke=function(e){return Ue("处理app.json......"),Me.replace(/[\s\S]+/,(function(t){if(Le.plugin&&"mainAppJson"===e)return t;We.mode=!1;let r,a,s,p={};({pagesJson(){try{r=JSON.parse(l(t))}catch(e){r={}}},baseAppJson(){try{a=JSON.parse(t)}catch(e){a={}}},mainAppJson(){try{s=JSON.parse(t)}catch(e){s={}}}})[e]();try{r||(r=JSON.parse(l(c.readFileSync(n.resolve(Be,"src/pages.json"),"utf8"))))}catch(e){r={}}try{a||(a=JSON.parse(c.readFileSync(n.resolve(Be,qe+"/app.json"),"utf8")))}catch(e){a={}}try{s||(s=JSON.parse(c.readFileSync(n.resolve(Be,Fe[Ie.mainMpPath]+"/app.json"),"utf8")))}catch(e){s={}}function i(e){return Fe.subPackagePath+(Fe.subPackagePath?"/":"")+e}if(s.subPackages){let e=s.subPackages.find(e=>e.root===Fe.subPackagePath);if(e){We.mode=!0;let t=[...r[Je]&&r[Je].pages||[],...a.pages||[]];return a.subPackages&&a.subPackages.forEach(e=>{t=[...t,...(e.pages||[]).map(t=>e.root+(e.root?"/":"")+t)]}),r[Je]&&r[Je].subPackages&&r[Je].subPackages.forEach(e=>{t=[...t,...(e.pages||[]).map(t=>e.root+(e.root?"/":"")+t)]}),e.pages=t,Ce(),delete a.pages,delete a.subPackages,JSON.stringify({...a,...s},null,2)}}a.pages&&a.pages.forEach((e,t)=>{a.pages[t]=i(e)}),a.subPackages&&a.subPackages.forEach(e=>{e.root=i(e.root)}),r[Je]&&(r[Je].pages&&r[Je].pages.forEach((e,t)=>{r[Je].pages[t]=i(e)}),r[Je].subPackages&&r[Je].subPackages.forEach(e=>{e.root=i(e.root)})),a.tabBar&&a.tabBar.list&&a.tabBar.list.forEach(({pagePath:e,iconPath:t,selectedIconPath:r,...n},s)=>{a.tabBar.list[s]={pagePath:e?i(e):"",iconPath:t?i(t):"",selectedIconPath:r?i(r):"",...n}}),p={...a,...s},p.pages=Array.from(new Set([...r.indexPage?[i(r.indexPage)]:[],...s.pages||[],...a.pages||[],...r[Je]&&r[Je].pages||[]]));let o=[],u={};function g(e){e.forEach(e=>{u[e.root]=u[e.root]?Array.from(new Set([...u[e.root],...e.pages])):e.pages})}g(r[Je]&&r[Je].subPackages||[]),g(a.subPackages||[]),g(s.subPackages||[]);for(let e in u)o.push({root:e,pages:u[e]});if(p.subPackages=[...o],a.usingComponents){for(let e in a.usingComponents)a.usingComponents[e]="/"+Fe.subPackagePath+a.usingComponents[e];p.usingComponents={...p.usingComponents||{},...a.usingComponents}}return Ce(),"toutiao"===Le.type&&p.subPackages&&(p.subPackages.forEach(e=>{e.pages.forEach(t=>{p.pages.push((e.root+"/"+t).replace(/\/\//g,"/"))})}),delete p.subPackages),JSON.stringify(p,null,2)}),{skipBinary:!1})};const De=p(),{cwd:Ye,target:He,env:ze,targetPath:Ve,pluginProcessFileTypes:Ze}=_,{writeLastLine:Ge}=A,{runPlugins:Qe}=ce;r.task("watch:pagesJson",(function(){const e=De.filter(Ze.map(e=>"/**/*."+e),{restore:!0});return r.src("src/pages.json",{allowEmpty:!0,cwd:Ye}).pipe(De.if("dev"===ze,De.watch("src/pages.json",{cwd:Ye},(function(e){Ge("处理"+e.relative+"......")})))).pipe(Ke("pagesJson")).pipe(De.rename("app.json")).pipe(e).pipe(De.replace(/[\s\S]*/,Qe(Ve),{skipBinary:!1})).pipe(e.restore).pipe(r.dest(He,{cwd:Ye}))}));const Xe=p(),{cwd:et,target:tt,env:rt,base:nt,targetPath:at,pluginProcessFileTypes:st}=_,{writeLastLine:pt}=A,{runPlugins:it}=ce;r.task("watch:baseAppJson",(function(){const e=Xe.filter(st.map(e=>`${nt}/**/*.${e}`),{restore:!0});return r.src(nt+"/app.json",{allowEmpty:!0,cwd:et}).pipe(Xe.if("dev"===rt,Xe.watch(nt+"/app.json",{cwd:et},(function(e){pt("处理"+e.relative+"......")})))).pipe(Ke("baseAppJson")).pipe(e).pipe(Xe.replace(/[\s\S]*/,it(at),{skipBinary:!1})).pipe(e.restore).pipe(r.dest(tt,{cwd:et}))}));const ot=p(),{cwd:ct,target:lt,env:ut,projectToSubPackageConfig:gt,program:ft,currentNamespace:mt,pluginProcessFileTypes:ht}=_,{writeLastLine:dt}=A,{runPlugins:yt}=ce;r.task("watch:mainAppJson",(function(){const e=gt[mt.mainMpPath],t=ot.filter(ht.map(t=>`${e}/**/*.${t}`),{restore:!0});return r.src(e+"/app.json",{allowEmpty:!0,cwd:ct}).pipe(ot.if("dev"===ut,ot.watch(e+"/app.json",{cwd:ct},(function(e){dt("处理"+e.relative+"......")})))).pipe(Ke("mainAppJson")).pipe(t).pipe(ot.replace(/[\s\S]*/,yt(n.resolve(ct,lt+(ft.plugin?"/miniprogram":""))),{skipBinary:!1})).pipe(t.restore).pipe(r.dest(lt+(ft.plugin?"/miniprogram":""),{cwd:ct}))}));const Pt=p(),{cwd:bt,target:vt,env:wt,projectToSubPackageConfig:kt,program:jt,basePath:xt,currentNamespace:$t,mpTypeNamespace:St,pluginProcessFileTypes:_t}=_,{writeLastLine:Et}=A,{runPlugins:Ot}=ce;r.task("watch:topMode-mainAppJsAndAppWxss",(function(){let e=kt[$t.mainMpPath];const t=Object.keys(St).map(t=>`${e}/app.${St[t].css}`),a=Pt.filter([...t],{restore:!0}),s=Pt.filter([e+"/app.js"],{restore:!0}),p=Pt.filter(_t.map(t=>`${e}/**/*.${t}`),{restore:!0});return r.src([e+"/app.js",...t],{allowEmpty:!0,cwd:bt}).pipe(Pt.if("dev"===wt,Pt.watch([e+"/app.js",`${e}/app.${$t.css}`],{cwd:bt},(function(e){Et("处理"+e.relative+"......")})))).pipe(s).pipe(Pt.replace(/^/,(function(e){return c.readFileSync(xt+"/app.js","utf8")+";\n"}),{skipBinary:!1})).pipe(s.restore).pipe(a).pipe(Pt.replace(/^/,(function(e){return c.readFileSync(`${xt}/app.${$t.css}`,"utf8")+"\n"}),{skipBinary:!1})).pipe(Pt.rename((function(e){e.extname="."+$t.css}))).pipe(a.restore).pipe(p).pipe(Pt.replace(/[\s\S]*/,Ot(n.resolve(bt,vt+(jt.plugin?"/miniprogram":""))),{skipBinary:!1})).pipe(p.restore).pipe(r.dest(vt+(jt.plugin?"/miniprogram":""),{cwd:bt}))}));const{mpTypeNamespace:At,currentNamespace:Nt}=_,Tt=(process,new Set(Object.keys(At).map(e=>At[e].globalObject)));var Rt={mixinsEnvCode:function(e){let t="";return Tt.forEach(e=>{Nt.globalObject!==e&&(t+=`var ${e} = ${Nt.globalObject};\n`)}),t}};const Ct=p(),{cwd:Mt,target:Lt,env:Bt,projectToSubPackageConfig:Ft,base:Jt,wxResourcePath:qt,currentNamespace:Wt,mpTypeNamespace:It,pluginProcessFileTypes:Ut}=_,{writeLastLine:Kt}=A,{mixinsEnvCode:Dt}=Rt,{runPlugins:Yt}=ce;r.task("watch:mainWeixinMpPackPath",(function(){const e=Ft[Wt.mainMpPath],a=e+"/"+Ft.subPackagePath,s=Lt+"/"+Ft.subPackagePath,p=[],i=[],o=new Set,l=new Set;Object.keys(It).forEach(e=>{p.push(`${a}/**/*.${It[e].css}`),i.push(`${a}/**/*.${It[e].html}`),o.add("."+It[e].css),l.add("."+It[e].html)});const u=Ct.filter([...i],{restore:!0}),g=Ct.filter([...p],{restore:!0}),f=Ct.filter([a+"/**/*.js"],{restore:!0}),m=Ct.filter(Ut.map(e=>`${a}/**/*.${e}`),{restore:!0});return r.src([a,a+"/**/*","!"+a+"/pack.config.js"],{allowEmpty:!0,cwd:Mt}).pipe(Ct.if("dev"===Bt,Ct.watch([a,a+"/**/*","!/"+a+"/pack.config.js"],{cwd:Mt},(function(e){Kt("处理"+e.relative+"......")})))).pipe(Ct.filter((function(r){if(!function(e){const t=Ft[Wt.mainMpPath]+"/"+Ft.subPackagePath;return!c.existsSync(e.path.replace(n.resolve(Mt,t),n.resolve(Mt,Jt)))&&!c.existsSync(e.path.replace(n.resolve(Mt,t),n.resolve(Mt,qt)))}(r))return!1;if("unlink"===r.event){try{let a=r.path;const s=RegExp(r.extname+"$","i");o.has(r.extname)&&(a=a.replace(s,"."+Wt.css)),l.has(r.extname)&&(a=a.replace(s,"."+Wt.html)),t.sync([a.replace(n.resolve(Mt,e),n.resolve(Mt,Lt))],{force:!0})}catch(e){}return!1}return!0}))).pipe(u).pipe(Ct.rename((function(e){e.extname="."+Wt.html}))).pipe(u.restore).pipe(g).pipe(Ct.rename((function(e){e.extname="."+Wt.css}))).pipe(g.restore).pipe(f).pipe(Ct.replace(/[\s\S]*/,(function(e){return Dt(e)+e}),{skipBinary:!1})).pipe(f.restore).pipe(m).pipe(Ct.replace(/[\s\S]*/,Yt(n.resolve(Mt,s)),{skipBinary:!1})).pipe(m.restore).pipe(r.dest(s,{cwd:Mt}))}));const Ht=p(),{cwd:zt,target:Vt,env:Zt,projectToSubPackageConfig:Gt,basePath:Qt,subModePath:Xt,targetPath:er,program:tr,packIsSubpackage:rr,currentNamespace:nr,mpTypeNamespace:ar,pluginProcessFileTypes:sr}=_,{writeLastLine:pr}=A,{mixinsEnvCode:ir}=Rt,{runPlugins:or}=ce;r.task("watch:mainWeixinMp",(function(){const e=Gt[nr.mainMpPath],a=e+"/"+Gt.subPackagePath,s=[],p=[],i=new Set,o=new Set;Object.keys(ar).forEach(t=>{s.push(`${e}/**/*.${ar[t].css}`),p.push(`${e}/**/*.${ar[t].html}`),i.add("."+ar[t].css),o.add("."+ar[t].html)});const c=Ht.filter([e+"/app.js"],{restore:!0}),l=Ht.filter([e+"/**/*.js"],{restore:!0}),u=Ht.filter([...p],{restore:!0}),g=Ht.filter([...s],{restore:!0}),f=Ht.filter(sr.map(t=>`${e}/**/*.${t}`),{restore:!0});return r.src([e+"/**/*","!"+e+"/app.json","!"+e+"/**/*.json___jb_tmp___","!"+e+`/**/*.${nr.html}___jb_tmp___`,"!"+e+`/**/*.${nr.css}___jb_tmp___`,"!"+e+"/**/*.js___jb_tmp___","!"+a+"/**/*"],{base:n.resolve(zt,e),allowEmpty:!0,cwd:zt}).pipe(Ht.if("dev"===Zt,Ht.watch([e+"/**/*","!/"+e+"/app.json","!/"+a+"/**/*"],{cwd:zt},(function(e){pr("处理"+e.relative+"......")})))).pipe(Ht.filter((function(r){if("unlink"===r.event){try{let a=r.path;const s=RegExp(r.extname+"$","i");i.has(r.extname)&&(a=a.replace(s,"."+nr.css)),o.has(r.extname)&&(a=a.replace(s,"."+nr.html)),t.sync([a.replace(n.resolve(zt,e),n.resolve(zt,Vt))],{force:!0})}catch(e){}return!1}return!0}))).pipe(l).pipe(Ht.replace(/[\s\S]*/,(function(e){return ir(e)+e}),{skipBinary:!1})).pipe(l.restore).pipe(c).pipe(Ht.replace(/^/,(function(e){if(rr.mode||tr.plugin)return"";let t=`./${Gt.subPackagePath}/`;if(Xt===er){return fs.readFileSync(Qt+"/app.js","utf8")+";\n"}return`require('${t}app.js');\n`}),{skipBinary:!1})).pipe(c.restore).pipe(u).pipe(Ht.rename((function(e){e.extname="."+nr.html}))).pipe(u.restore).pipe(g).pipe(Ht.rename((function(e){e.extname="."+nr.css}))).pipe(g.restore).pipe(f).pipe(Ht.replace(/[\s\S]*/,or(n.resolve(zt,Vt+(tr.plugin?"/miniprogram":""))),{skipBinary:!1})).pipe(f.restore).pipe(r.dest(Vt+(tr.plugin?"/miniprogram":""),{cwd:zt}))}));var cr={fakeUniBootstrap:function(e,t,r,n){globalObject.__uniapp2wxpack||(globalObject.__uniapp2wxpack={platform:n});var a=globalObject.__uniapp2wxpack[t.replace("/","")]={__packInit:{}};if(e)for(var s in e)"function"!=typeof e[s]?a.__packInit[s]=e[s]:function(t){a.__packInit[t]=function(){return e[t].apply(e,arguments)}}(s);else e={};if("none"!==r){var p=Page,i=Component,o="",c=1,l=1;"function"==typeof e.onError&&globalObject.onError&&globalObject.onError((function(){return e.onError.apply(e,arguments)})),"function"==typeof e.onPageNotFound&&globalObject.onPageNotFound&&globalObject.onPageNotFound((function(){return e.onPageNotFound.apply(e,arguments)})),"function"==typeof e.onUnhandledRejection&&globalObject.onUnhandledRejection&&globalObject.onUnhandledRejection((function(){return e.onUnhandledRejection.apply(e,arguments)})),globalObject.onAppRoute((function(n){"top"!==r&&0!==("/"+n.path).indexOf(t+"/")&&(c=1,e.onHide.call(e,globalObject.getLaunchOptionsSync())),o=n.path})),globalObject.onAppHide((function(){if("top"===r)return e.onHide.call(e,globalObject.getLaunchOptionsSync());var n=getCurrentPages();return 0===("/"+(null==n[n.length-1].route?n[n.length-1].__route__:n[n.length-1].route)).indexOf(t+"/")?(c=1,o="",e.onHide.call(e,globalObject.getLaunchOptionsSync())):void 0})),globalObject.onAppShow((function(){"top"===r&&"function"==typeof e.onShow&&e.onShow.call(e,globalObject.getLaunchOptionsSync()),l&&getApp()&&(getApp().globalData||(getApp().globalData={}),Object.assign(getApp().globalData,e.globalData||{})),l=0})),"top"===r&&l&&"function"==typeof e.onLaunch&&e.onLaunch.call(e,globalObject.getLaunchOptionsSync()),Page=function(e){return u(e),p.call(this,e)},Component=function(e){return u(e.methods||{}),i.call(this,e)}}function u(n){if("top"!==r){var a=n.onShow;"function"!=typeof e.onShow&&"function"!=typeof e.onLaunch||(n.onShow=function(){var r=getCurrentPages(),n=null==r[r.length-1].route?r[r.length-1].__route__:r[r.length-1].route;if(o&&0===("/"+o).indexOf(t+"/")||0!==("/"+n).indexOf(t+"/")||(c&&(c=0,e.onLaunch.call(e,globalObject.getLaunchOptionsSync())),e.onShow.call(e,globalObject.getLaunchOptionsSync())),"function"==typeof a)return a.apply(this,arguments)})}}},fakeUniBootstrapName:"fakeUniBootstrap"};const lr=p(),{regExpWxResources:ur,regExpUniRequire:gr}=_,{getLevelPath:fr,getLevel:mr}=A;var hr={uniRequireWxResource:function(){return lr.replace(gr,(function(e,t){const r=mr(this.file.relative);return console.log(`\n编译${e}--\x3erequire(${t.replace(ur,fr(r))})`),`require(${t.replace(ur,fr(r))})`}),{skipBinary:!1})}};const dr=p(),{fakeUniBootstrapName:yr,fakeUniBootstrap:Pr}=cr,{cwd:br,env:vr,program:wr,basePath:kr,targetPath:jr,subModePath:xr,base:$r,regExpUniRequire:Sr,regExpWxResources:_r,regExpUniImportWxss:Er,wxResourceAlias:Or,currentNamespace:Ar,mpTypeNamespace:Nr,pluginProcessFileTypes:Tr}=_,Rr=process.env.PACK_TYPE,{writeLastLine:Cr,getLevel:Mr,getLevelPath:Lr,deepFind:Br}=A,{mixinsEnvCode:Fr}=Rt,{uniRequireWxResource:Jr}=hr,{runPlugins:qr}=ce,Wr=Object.keys(Nr).map(e=>Nr[e].css),Ir=new Set(Wr);r.task("subMode:createUniSubPackage",(function(){c.mkdirsSync(kr);const e=dr.filter($r+"/**/*.js",{restore:!0}),a=dr.filter([$r+"/common/vendor.js"],{restore:!0}),s=dr.filter([$r+"/common/main.js"],{restore:!0}),p=dr.filter(Tr.map(e=>`${$r}/**/*.${e}`),{restore:!0}),i=dr.filter([$r+"/**/*.js","!"+$r+"/app.js","!"+$r+"/common/vendor.js","!"+$r+"/common/main.js","!"+$r+"/common/runtime.js"],{restore:!0}),o=dr.filter([`${$r}/**/*.${Ar.css}`,`!${$r}/app.${Ar.css}`,`!${$r}/common/main.${Ar.css}`],{restore:!0}),l=dr.filter([`${$r}/**/*.${Ar.css}`,`!${$r}/app.${Ar.css}`],{restore:!0}),g=dr.filter([$r+"/**/*.json"],{restore:!0}),f=dr.filter([`${$r}/**/*.${Ar.html}`],{restore:!0});return r.src([$r+"/**","!"+$r+"/*.*",$r+"/app.js",`${$r}/app.${Ar.css}`],{allowEmpty:!0,cwd:br}).pipe(dr.if("dev"===vr,dr.watch([$r+"/**/*","!/"+$r+"/*.json"],{cwd:br},(function(e){Cr("处理"+e.relative+"......")})))).pipe(dr.filter((function(e){if(function(e){const t=n.resolve(jr,"app.js"),r=n.resolve(jr,"app."+Ar.css),a=e.path.replace(kr,xr);return t===a||r===a}(e))return!1;if("unlink"===e.event){try{let r=e.path;const a=RegExp(e.extname+"$","i");Ir.has(e.extname.substr(1))&&(r=r.replace(a,"."+Ar.css)),t.sync([r.replace(kr,n.resolve(br,xr))],{force:!0})}catch(e){}return!1}return!0}))).pipe(f).pipe(dr.replace(/[\s\S]*/,(function(e){const t=new F(e);let r=0;return Br(t.topNode,e=>{if(1===e.type&&"wxs"===e.tag&&1===e.children.length&&3===e.children[0].type){e.children[0].text.replace(Sr,(t,n,a,s)=>{const p=Mr(this.file.relative),i=n.replace(_r,Lr(p)).replace(/['"]/g,"");e.attrsMap.src=i,e.children=[],r=1,console.log(`\n编译${t}--\x3erequire(${i})`)})}}),r?t.render():e}),{skipBinary:!1})).pipe(f.restore).pipe(a).pipe(dr.replace(/^/,(function(e){return wr.plugin?`var App=function(packInit){};${Ar.globalObject}.canIUse=function(){return false};`:`var __packConfig=require('../pack.config.js');var App=function(packInit){var ${yr}=${(""+Pr).replace(/globalObject/g,Ar.globalObject)};${yr}(packInit,__packConfig.packPath,__packConfig.appMode,'${Rr}');};`}),{skipBinary:!1})).pipe(a.restore).pipe(e).pipe(u()).pipe(Jr()).pipe(dr.replace(/[\s\S]*/,(function(e){return Fr(e)+e}),{skipBinary:!1})).pipe(e.restore).pipe(s).pipe(dr.replace(/^/,(function(e){return"var __uniPluginExports={};\n"}),{skipBinary:!1})).pipe(dr.replace(/$/,(function(e){return"\nmodule.exports=__uniPluginExports;"}),{skipBinary:!1})).pipe(s.restore).pipe(i).pipe(dr.replace(/^/,(function(e){if(c.existsSync(n.resolve(br,"src",this.file.relative)))return e;return`require('${Lr(Mr(this.file.relative))}app.js');\n`}),{skipBinary:!1})).pipe(i.restore).pipe(g).pipe(dr.replace(/[\s\S]*/,(function(e){if(!c.existsSync(n.resolve(br,"src",this.file.relative.replace(/json$/,"vue")))&&!c.existsSync(n.resolve(br,"src",this.file.relative.replace(/json$/,"nvue"))))return e;let t=JSON.parse(""+this.file.contents);for(let e in t.usingComponents)0===t.usingComponents[e].indexOf("/")&&(t.usingComponents[e]=Lr(Mr(this.file.relative))+t.usingComponents[e].replace(/^\//,""));return JSON.stringify(t)}),{skipBinary:!1})).pipe(g.restore).pipe(l).pipe(dr.stripCssComments()).pipe(dr.replace(Er,(function(e,t,r){let n="",a=Mr(this.file.relative);return(r+=";").replace(/\s*import\s*:\s*(('[^\s';]*')|("[^\s";]*"))/g,(function(e,t){const r=RegExp(`(${Wr.join("|")})(['"])$`);t=t.replace(r,Ar.css+"$2"),n+=`@import ${t.replace(_r,Lr(a))};\n`})),t+n}),{skipBinary:!1})).pipe(l.restore).pipe(o).pipe(dr.stripCssComments()).pipe(dr.replace(/^[\s\S]*$/,(function(e){if(xr===jr)return e;let t=Mr(this.file.relative);return"@import "+`"${Or}/app.${Ar.css}";`.replace(_r,Lr(t))+("\n"+e)}),{skipBinary:!1})).pipe(o.restore).pipe(p).pipe(dr.replace(/[\s\S]*/,qr(xr),{skipBinary:!1})).pipe(p.restore).pipe(r.dest(xr,{cwd:br}))}));const Ur=p(),{cwd:Kr,env:Dr,targetPath:Yr,subModePath:Hr,regExpWxResources:zr,regExpUniImportWxss:Vr,wxResourceAlias:Zr,wxResourcePath:Gr,currentNamespace:Qr,mpTypeNamespace:Xr,pluginProcessFileTypes:en}=_,{writeLastLine:tn,getLevel:rn,getLevelPath:nn}=A,{mixinsEnvCode:an}=Rt,{uniRequireWxResource:sn}=hr,{runPlugins:pn}=ce,on=[],cn=[],ln=[],un=new Set,gn=new Set;Object.keys(Xr).forEach(e=>{on.push(Xr[e].css),cn.push(`${Gr}/**/*.${Xr[e].css}`),ln.push(`${Gr}/**/*.${Xr[e].html}`),un.add("."+Xr[e].css),gn.add("."+Xr[e].html)}),r.task("subMode:copyWxResource",(function(){const e=Ur.filter([Gr+"/**/*.js"],{restore:!0}),a=Ur.filter([...cn],{restore:!0}),s=Ur.filter([...ln],{restore:!0}),p=Ur.filter(en.map(e=>`${Gr}/**/*${e}`),{restore:!0});return r.src([Gr+"/**",Gr],{allowEmpty:!0,cwd:Kr}).pipe(Ur.if("dev"===Dr,Ur.watch([Gr+"/**",Gr,`!/${Gr}/**/*.*___jb_tmp___`],{cwd:Kr},(function(e){tn("处理"+e.relative+"......")})))).pipe(e).pipe(Ur.replace(/[\s\S]*/,(function(e){return an(e)+e}),{skipBinary:!1})).pipe(Ur.replace(/^/,(function(e){return`require('${nn(rn(this.file.relative))}app.js');\n`}),{skipBinary:!1})).pipe(u()).pipe(sn()).pipe(e.restore).pipe(a).pipe(Ur.stripCssComments()).pipe(Ur.replace(Vr,(function(e,t,r){let n="";rn(this.file.relative);return t+n}),{skipBinary:!1})).pipe(Ur.replace(/^[\s\S]*$/,(function(e){if(Hr===Yr)return e;let t=rn(this.file.relative);return"@import "+`"${Zr}/app.${Qr.css}";`.replace(zr,nn(t))+("\n"+e)}),{skipBinary:!1})).pipe(Ur.rename((function(e){e.extname="."+Qr.css}))).pipe(a.restore).pipe(s).pipe(Ur.rename((function(e){e.extname="."+Qr.html}))).pipe(s.restore).pipe(Ur.filter((function(e){if("unlink"===e.event){try{let r=e.path;const a=RegExp(e.extname+"$","i");un.has(e.extname)&&(r=r.replace(a,"."+Qr.css)),gn.has(e.extname)&&(r=r.replace(a,"."+Qr.html)),t.sync([r.replace(n.resolve(Kr,Gr),n.resolve(Kr,Hr))],{force:!0})}catch(e){}return!1}return!0}))).pipe(p).pipe(Ur.replace(/[\s\S]*/,pn(Hr),{skipBinary:!1})).pipe(p.restore).pipe(r.dest(Hr,{cwd:Kr}))}));const fn=p(),{cwd:mn,target:hn,env:dn,projectToSubPackageConfig:yn,currentNamespace:Pn,mpTypeNamespace:bn,pluginProcessFileTypes:vn}=_,{writeLastLine:wn}=A,{mixinsEnvCode:kn}=Rt,{runPlugins:jn}=ce;r.task("watch:native",(function(){const e=yn[Pn.mainMpPath],a=[],s=[],p=new Set,i=new Set;Object.keys(bn).forEach(t=>{a.push(`${e}/**/*.${bn[t].css}`),s.push(`${e}/**/*.${bn[t].html}`),p.add("."+bn[t].css),i.add("."+bn[t].html)});const o=fn.filter([e+"/**/*.js"],{restore:!0}),c=fn.filter([...s],{restore:!0}),l=fn.filter([...a],{restore:!0}),u=fn.filter(vn.map(t=>`${e}/**/*.${t}`),{restore:!0});return r.src([e+"/**/*","!"+e+"/app.json"],{base:n.resolve(mn,e),allowEmpty:!0,cwd:mn}).pipe(fn.if("dev"===dn,fn.watch([e+"/**/*","!/"+e+"/app.json"],{cwd:mn},(function(e){wn("处理"+e.relative+"......")})))).pipe(fn.filter((function(r){if("unlink"===r.event){try{let a=r.path;const s=RegExp(r.extname+"$","i");p.has(r.extname)&&(a=a.replace(s,"."+Pn.css)),i.has(r.extname)&&(a=a.replace(s,"."+Pn.html)),t.sync([a.replace(n.resolve(mn,e),n.resolve(mn,hn))],{force:!0})}catch(e){console.log(e)}return!1}return!0}))).pipe(o).pipe(fn.replace(/[\s\S]*/,(function(e){return kn(e)+e}),{skipBinary:!1})).pipe(o.restore).pipe(c).pipe(fn.rename((function(e){e.extname="."+Pn.html}))).pipe(c.restore).pipe(l).pipe(fn.rename((function(e){e.extname="."+Pn.css}))).pipe(l.restore).pipe(u).pipe(fn.replace(/[\s\S]*/,jn(n.resolve(mn,hn)),{skipBinary:!1})).pipe(u.restore).pipe(r.dest(hn,{cwd:mn}))}));const{cwd:xn,env:$n,targetPath:Sn,subModePath:_n,projectToSubPackageConfig:En,program:On,currentNamespace:An}=_,{tryAgain:Nn}=A;async function Tn(e){let t=n.resolve(xn,En[An.mainMpPath],"app.js");await c.exists(t)||await c.outputFile(t,"App({});"),e()}r.task("mpWxSubMode",r.series((function(e){console.log("小程序解耦构建开启，此过程如果出现权限问题，请使用管理员权限运行"),e()}),"clean:previewDist",(async function e(t){if(On.plugin||On.native)t();else{try{let e={packPath:(En.subPackagePath?"/":"")+En.subPackagePath,appMode:En.appMode};await c.outputFile(_n+"/pack.config.js","module.exports="+JSON.stringify(e,null,4))}catch(r){return void await Nn(async()=>{await e(t)})}t()}}),function(){let e=[Tn,"subMode:createUniSubPackage","subMode:copyWxResource",...On.plugin?["watch:pluginJson"]:["watch:baseAppJson","watch:pagesJson",...En.mergePack?["watch:mainWeixinMpPackPath"]:[],..._n===Sn?["watch:topMode-mainAppJsAndAppWxss"]:[]],"watch:mainAppJson","watch:mainWeixinMp","watch:projectConfigJson"];return On.native&&(e=[Tn,"watch:mainAppJson","watch:native"]),"build"===$n?r.series.apply(this,e):r.parallel.apply(this,e)}(),(function(e){e(),"build"===$n&&process.exit()})));const{cwd:Rn,basePath:Cn,base:Mn,program:Ln}=_;r.task("startToPackServe",r.series((async function(e){Ln.native||await c.exists(Cn)||await c.mkdirs(Cn),e()}),"clean:base",(function(e){Ln.native?e():r.watch(Mn+"/app.json",{events:["all"],cwd:Rn},(function(){e()}))}),"mpWxSubMode")),process.on("unhandledRejection",()=>{});
