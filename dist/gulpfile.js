"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t=e(require("del")),a=e(require("gulp")),n=e(require("path")),r=e(require("commander")),i=e(require("single-line-log")),s=e(require("gulp-load-plugins")),o=e(require("fs-extra")),p=e(require("strip-json-comments")),c=e(require("parse5")),u=e(require("gulp-strip-comments"));const{program:l}=r;l.option("--scope <type>","运行目录",process.cwd()).option("--plugin","插件模式").option("--type <type>","解耦包类型(哪种小程序)","weixin"),l.parse(process.argv);const g={weixin:{html:"wxml",css:"wxss",globalObject:"wx",mainMpPath:"mainWeixinMpPath"},baidu:{html:"swan",css:"css",globalObject:"swan",mainMpPath:"mainBaiduMpPath"},toutiao:{html:"ttml",css:"ttss",globalObject:"tt",mainMpPath:"mainToutiaoMpPath"}}[l.type];if(!g)throw Error("小程序类型错");process.env.PACK_TYPE=l.type;const f=l.scope,h=function(){return require.apply(null,arguments)}(n.resolve(f,"./projectToSubPackageConfig")),d=h.wxResourcePath||`src/${g.globalObject}resource`,m=h.wxResourceAlias||"@wxResource",b=RegExp(m+"\\/","g"),w=h.uniRequireApiName||"__uniRequireWx",P=RegExp(w+"\\(([a-zA-Z.\\/\"'@\\d]+)\\)","g"),y=h.uniImportWxssApiName||"__uniWxss",v=RegExp(`(}|^|\\s|;)${y}\\s*{([^{}]+)}`,"g");let k="dev";"production"===process.env.NODE_ENV&&(k="build");const j="dist/"+k+"/mp-"+l.type;let x="dist/"+k+`/mp-${l.type}-pack`;l.plugin&&(x="dist/"+k+`/mp-${l.type}-pack-plugin`);var _={currentNamespace:g,program:l,cwd:f,projectToSubPackageConfig:h,wxResourcePath:d,wxResourceAlias:m,regExpWxResources:b,uniRequireApiName:w,regExpUniRequire:P,uniImportWxssApiName:y,regExpUniImportWxss:v,configWxResourceKey:h.configWxResourceKey||"wxResource",env:k,base:j,target:x,basePath:n.resolve(f,j),subModePath:n.resolve(f,x,h.subPackagePath),targetPath:n.resolve(f,x),packIsSubpackage:{mode:!1}};let S;const $=i.stdout;var O={tryAgain:async function(e){return new Promise(async t=>{setTimeout(async()=>{t(await e())},100)})},getLevelPath:function(e){return Array(e).fill("../").join("")},getLevel:function(e){return e.split(/[\\/]/).length-1},writeLastLine:function(e){$(e),clearTimeout(S),S=setTimeout(()=>{$("解耦构建，正在监听中......(此过程如果出现权限问题，请使用管理员权限运行)")},300)}};const{basePath:N}=_,{tryAgain:E}=O;a.task("clean:base",(async function e(a){try{await t([N+"/**/*"],{force:!0})}catch(t){return void await E(async()=>{await e(a)})}a()}));const{subModePath:A}=_,{tryAgain:L}=O;a.task("clean:subModePath",(async function e(a){try{await t([A+"/**/*"],{force:!0})}catch(t){return void await L(async()=>{await e(a)})}a()}));const{targetPath:R}=_,{tryAgain:C}=O;a.task("clean:previewDist",(async function e(a){try{await t([R+"/**/*"],{force:!0})}catch(t){return void await C(async()=>{await e(a)})}a()}));const M=s(),{cwd:J,projectToSubPackageConfig:q,target:W,env:B}=_,{writeLastLine:I}=O;a.task("watch:pluginJson",(function(){return a.src("src/plugin.json",{allowEmpty:!0,cwd:J}).pipe(M.if("dev"===B,M.watch("src/plugin.json",{cwd:J},(function(e){I("处理"+e.relative+"......")})))).pipe(a.dest(W+"/"+q.subPackagePath,{cwd:J}))}));const U=s(),{cwd:T,target:F,env:D}=_,{writeLastLine:H}=O;a.task("watch:projectConfigJson",(function(){return a.src("project.config.json",{allowEmpty:!0,cwd:T}).pipe(U.if("dev"===D,U.watch("project.config.json",{cwd:T},(function(e){H("处理"+e.relative+"......")})))).pipe(a.dest(F,{cwd:T}))}));const{program:K,cwd:z,projectToSubPackageConfig:V,basePath:Y,subModePath:Z,targetPath:G,packIsSubpackage:Q,currentNamespace:X}=_;var ee=function(){if(K.plugin)return;const e=n.resolve(z,V[X.mainMpPath]+"/app.js");if(o.existsSync(e)){const t=o.readFileSync(e,"utf8");let a=`require('${`./${V.subPackagePath}/`}app.js');\n`;if(Z===G){a=o.readFileSync(Y+"/app.js","utf8")+";\n"}(Q.mode||K.plugin)&&(a=""),o.outputFileSync(G+"/app.js",a+t)}};const te=s(),{program:ae,cwd:ne,projectToSubPackageConfig:re,configWxResourceKey:ie,base:se,packIsSubpackage:oe,currentNamespace:pe}=_,{writeLastLine:ce}=O;var ue=function(e){return ce("处理app.json......"),te.replace(/[\s\S]+/,(function(t){if(ae.plugin&&"mainAppJson"===e)return t;oe.mode=!1;let a,r,i,s={};({pagesJson(){try{a=JSON.parse(p(t))}catch(e){a={}}},baseAppJson(){try{r=JSON.parse(t)}catch(e){r={}}},mainAppJson(){try{i=JSON.parse(t)}catch(e){i={}}}})[e]();try{a||(a=JSON.parse(p(o.readFileSync(n.resolve(ne,"src/pages.json"),"utf8"))))}catch(e){a={}}try{r||(r=JSON.parse(o.readFileSync(n.resolve(ne,se+"/app.json"),"utf8")))}catch(e){r={}}try{i||(i=JSON.parse(o.readFileSync(n.resolve(ne,re[pe.mainMpPath]+"/app.json"),"utf8")))}catch(e){i={}}function c(e){return re.subPackagePath+(re.subPackagePath?"/":"")+e}if(i.subPackages){let e=i.subPackages.find(e=>e.root===re.subPackagePath);if(e){oe.mode=!0;let t=[...a[ie]&&a[ie].pages||[],...r.pages||[]];return r.subPackages&&r.subPackages.forEach(e=>{t=[...t,...(e.pages||[]).map(t=>e.root+(e.root?"/":"")+t)]}),a[ie]&&a[ie].subPackages&&a[ie].subPackages.forEach(e=>{t=[...t,...(e.pages||[]).map(t=>e.root+(e.root?"/":"")+t)]}),e.pages=t,ee(),delete r.pages,delete r.subPackages,JSON.stringify({...r,...i},null,2)}}r.pages&&r.pages.forEach((e,t)=>{r.pages[t]=c(e)}),r.subPackages&&r.subPackages.forEach(e=>{e.root=c(e.root)}),a[ie]&&(a[ie].pages&&a[ie].pages.forEach((e,t)=>{a[ie].pages[t]=c(e)}),a[ie].subPackages&&a[ie].subPackages.forEach(e=>{e.root=c(e.root)})),r.tabBar&&r.tabBar.list&&r.tabBar.list.forEach(({pagePath:e,iconPath:t,selectedIconPath:a,...n},i)=>{r.tabBar.list[i]={pagePath:e?c(e):"",iconPath:t?c(t):"",selectedIconPath:a?c(a):"",...n}}),s={...r,...i},s.pages=Array.from(new Set([...a.indexPage?[c(a.indexPage)]:[],...i.pages||[],...r.pages||[],...a[ie]&&a[ie].pages||[]]));let u=[],l={};function g(e){e.forEach(e=>{l[e.root]=l[e.root]?Array.from(new Set([...l[e.root],...e.pages])):e.pages})}g(a[ie]&&a[ie].subPackages||[]),g(r.subPackages||[]),g(i.subPackages||[]);for(let e in l)u.push({root:e,pages:l[e]});if(s.subPackages=[...u],r.usingComponents){for(let e in r.usingComponents)r.usingComponents[e]="/"+re.subPackagePath+r.usingComponents[e];s.usingComponents={...s.usingComponents||{},...r.usingComponents}}return ee(),"toutiao"===ae.type&&s.subPackages&&(s.subPackages.forEach(e=>{e.pages.forEach(t=>{s.pages.push(e.root+"/"+t)})}),delete s.subPackages),JSON.stringify(s,null,2)}),{skipBinary:!1})};const le=s(),{cwd:ge,target:fe,env:he}=_,{writeLastLine:de}=O;a.task("watch:pagesJson",(function(){return a.src("src/pages.json",{allowEmpty:!0,cwd:ge}).pipe(le.if("dev"===he,le.watch("src/pages.json",{cwd:ge},(function(e){de("处理"+e.relative+"......")})))).pipe(ue("pagesJson")).pipe(le.rename("app.json")).pipe(a.dest(fe,{cwd:ge}))}));const me=s(),{cwd:be,target:we,env:Pe,base:ye}=_,{writeLastLine:ve}=O;a.task("watch:baseAppJson",(function(){return a.src(ye+"/app.json",{allowEmpty:!0,cwd:be}).pipe(me.if("dev"===Pe,me.watch(ye+"/app.json",{cwd:be},(function(e){ve("处理"+e.relative+"......")})))).pipe(ue("baseAppJson")).pipe(a.dest(we,{cwd:be}))}));const ke=s(),{cwd:je,target:xe,env:_e,projectToSubPackageConfig:Se,program:$e,currentNamespace:Oe}=_,{writeLastLine:Ne}=O;a.task("watch:mainAppJson",(function(){let e=Se[Oe.mainMpPath];return a.src(e+"/app.json",{allowEmpty:!0,cwd:je}).pipe(ke.if("dev"===_e,ke.watch(e+"/app.json",{cwd:je},(function(e){Ne("处理"+e.relative+"......")})))).pipe(ue("mainAppJson")).pipe(a.dest(xe+($e.plugin?"/miniprogram":""),{cwd:je}))}));const Ee=s(),{cwd:Ae,target:Le,env:Re,projectToSubPackageConfig:Ce,program:Me,basePath:Je,currentNamespace:qe}=_,{writeLastLine:We}=O;a.task("watch:topMode-mainAppJsAndAppWxss",(function(){let e=Ce[qe.mainMpPath];const t=Ee.filter([`${e}/app.${qe.css}`],{restore:!0}),n=Ee.filter([e+"/app.js"],{restore:!0});return a.src([e+"/app.js",`${e}/app.${qe.css}`],{allowEmpty:!0,cwd:Ae}).pipe(Ee.if("dev"===Re,Ee.watch([e+"/app.js",`${e}/app.${qe.css}`],{cwd:Ae},(function(e){We("处理"+e.relative+"......")})))).pipe(n).pipe(Ee.replace(/^/,(function(e){return o.readFileSync(Je+"/app.js","utf8")+";\n"}),{skipBinary:!1})).pipe(n.restore).pipe(t).pipe(Ee.replace(/^/,(function(e){return o.readFileSync(`${Je}/app.${qe.css}`,"utf8")+"\n"}),{skipBinary:!1})).pipe(t.restore).pipe(a.dest(Le+(Me.plugin?"/miniprogram":""),{cwd:Ae}))}));const Be=s(),{cwd:Ie,target:Ue,env:Te,projectToSubPackageConfig:Fe,base:De,wxResourcePath:He,currentNamespace:Ke}=_,{writeLastLine:ze}=O;a.task("watch:mainWeixinMpPackPath",(function(){const e=Fe[Ke.mainMpPath],r=e+"/"+Fe.subPackagePath,i=Ue+"/"+Fe.subPackagePath;return a.src([r,r+"/**/*","!"+r+"/pack.config.js"],{allowEmpty:!0,cwd:Ie}).pipe(Be.if("dev"===Te,Be.watch([r,r+"/**/*","!/"+r+"/pack.config.js"],{cwd:Ie},(function(e){ze("处理"+e.relative+"......")})))).pipe(Be.filter((function(a){if(!function(e){const t=Fe[Ke.mainMpPath]+"/"+Fe.subPackagePath;return!o.existsSync(e.path.replace(n.resolve(Ie,t),n.resolve(Ie,De)))&&!o.existsSync(e.path.replace(n.resolve(Ie,t),n.resolve(Ie,He)))}(a))return!1;if("unlink"===a.event){try{t.sync([a.path.replace(n.resolve(Ie,e),n.resolve(Ie,Ue))],{force:!0})}catch(e){}return!1}return!0}))).pipe(a.dest(i,{cwd:Ie}))}));const Ve=s(),{cwd:Ye,target:Ze,env:Ge,projectToSubPackageConfig:Qe,basePath:Xe,subModePath:et,targetPath:tt,program:at,packIsSubpackage:nt,currentNamespace:rt}=_,{writeLastLine:it}=O;a.task("watch:mainWeixinMp",(function(){let e=Qe[rt.mainMpPath],r=e+"/"+Qe.subPackagePath,i=Ve.filter([e+"/app.js"],{restore:!0});return a.src([e+"/**/*","!"+e+"/app.json","!"+e+"/**/*.json___jb_tmp___","!"+e+`/**/*.${rt.html}___jb_tmp___`,"!"+e+`/**/*.${rt.css}___jb_tmp___`,"!"+e+"/**/*.js___jb_tmp___","!"+r+"/**/*"],{base:n.resolve(Ye,e),allowEmpty:!0,cwd:Ye}).pipe(Ve.if("dev"===Ge,Ve.watch([e+"/**/*","!/"+e+"/app.json","!/"+r+"/**/*"],{cwd:Ye},(function(e){it("处理"+e.relative+"......")})))).pipe(Ve.filter((function(a){if("unlink"===a.event){try{t.sync([a.path.replace(n.resolve(Ye,e),n.resolve(Ye,Ze))],{force:!0})}catch(e){}return!1}return!0}))).pipe(i).pipe(Ve.replace(/^/,(function(e){if(nt.mode||at.plugin)return"";let t=`./${Qe.subPackagePath}/`;if(et===tt){return fs.readFileSync(Xe+"/app.js","utf8")+";\n"}return`require('${t}app.js');\n`}),{skipBinary:!1})).pipe(i.restore).pipe(a.dest(Ze+(at.plugin?"/miniprogram":""),{cwd:Ye}))}));var st={fakeUniBootstrap:function(e,t,a){globalObject.__uniapp2wxpack||(globalObject.__uniapp2wxpack={});var n=globalObject.__uniapp2wxpack[t.replace("/","")]={__packInit:{}};if(e)for(var r in e)"function"!=typeof e[r]?n.__packInit[r]=e[r]:function(t){n.__packInit[t]=function(){return e[t].apply(e,arguments)}}(r);else e={};if("none"!==a){var i=Page,s=Component,o="",p=1,c=1;"function"==typeof e.onError&&globalObject.onError&&globalObject.onError((function(){return e.onError.apply(e,arguments)})),"function"==typeof e.onPageNotFound&&globalObject.onPageNotFound&&globalObject.onPageNotFound((function(){return e.onPageNotFound.apply(e,arguments)})),"function"==typeof e.onUnhandledRejection&&globalObject.onUnhandledRejection&&globalObject.onUnhandledRejection((function(){return e.onUnhandledRejection.apply(e,arguments)})),globalObject.onAppRoute((function(n){"top"!==a&&0!==("/"+n.path).indexOf(t+"/")&&(p=1,e.onHide.call(e,globalObject.getLaunchOptionsSync())),o=n.path})),globalObject.onAppHide((function(){if("top"===a)return e.onHide.call(e,globalObject.getLaunchOptionsSync());var n=getCurrentPages();return 0===("/"+(null==n[n.length-1].route?n[n.length-1].__route__:n[n.length-1].route)).indexOf(t+"/")?(p=1,o="",e.onHide.call(e,globalObject.getLaunchOptionsSync())):void 0})),globalObject.onAppShow((function(){"top"===a&&"function"==typeof e.onShow&&e.onShow.call(e,globalObject.getLaunchOptionsSync()),c&&getApp()&&(getApp().globalData||(getApp().globalData={}),Object.assign(getApp().globalData,e.globalData||{})),c=0})),"top"===a&&c&&"function"==typeof e.onLaunch&&e.onLaunch.call(e,globalObject.getLaunchOptionsSync()),Page=function(e){return u(e),i.call(this,e)},Component=function(e){return u(e.methods||{}),s.call(this,e)}}function u(n){if("top"!==a){var r=n.onShow;"function"!=typeof e.onShow&&"function"!=typeof e.onLaunch||(n.onShow=function(){var a=getCurrentPages(),n=null==a[a.length-1].route?a[a.length-1].__route__:a[a.length-1].route;if(o&&0===("/"+o).indexOf(t+"/")||0!==("/"+n).indexOf(t+"/")||(p&&(p=0,e.onLaunch.call(e,globalObject.getLaunchOptionsSync())),e.onShow.call(e,globalObject.getLaunchOptionsSync())),"function"==typeof r)return r.apply(this,arguments)})}}},fakeUniBootstrapName:"fakeUniBootstrap"};const ot=s(),{regExpWxResources:pt,regExpUniRequire:ct}=_,{getLevelPath:ut,getLevel:lt}=O;var gt={uniRequireWxResource:function(){return ot.replace(ct,(function(e,t){const a=lt(this.file.relative);return console.log(`\n编译${e}--\x3erequire(${t.replace(pt,ut(a))})`),`require(${t.replace(pt,ut(a))})`}),{skipBinary:!1})}};const ft=s(),{fakeUniBootstrapName:ht,fakeUniBootstrap:dt}=st,{cwd:mt,env:bt,program:wt,basePath:Pt,targetPath:yt,subModePath:vt,base:kt,regExpUniRequire:jt,regExpWxResources:xt,regExpUniImportWxss:_t,wxResourceAlias:St,currentNamespace:$t}=_,{writeLastLine:Ot,getLevel:Nt,getLevelPath:Et}=O,{uniRequireWxResource:At}=gt;a.task("subMode:createUniSubPackage",(function(){o.mkdirsSync(Pt);const e=ft.filter(kt+"/**/*.js",{restore:!0}),r=ft.filter([kt+"/common/vendor.js"],{restore:!0}),i=ft.filter([kt+"/common/main.js"],{restore:!0}),s=ft.filter([kt+"/**/*.js","!"+kt+"/app.js","!"+kt+"/common/vendor.js","!"+kt+"/common/main.js","!"+kt+"/common/runtime.js"],{restore:!0}),p=ft.filter([`${kt}/**/*.${$t.css}`,`!${kt}/app.${$t.css}`,`!${kt}/common/main.${$t.css}`],{restore:!0}),l=ft.filter([`${kt}/**/*.${$t.css}`,`!${kt}/app.${$t.css}`],{restore:!0}),g=ft.filter([kt+"/**/*.json"],{restore:!0}),f=ft.filter([`${kt}/**/*.${$t.html}`],{restore:!0});return a.src([kt+"/**","!"+kt+"/*.*",kt+"/app.js",`${kt}/app.${$t.css}`],{allowEmpty:!0,cwd:mt}).pipe(ft.if("dev"===bt,ft.watch([kt+"/**/*","!/"+kt+"/*.json"],{cwd:mt},(function(e){Ot("处理"+e.relative+"......")})))).pipe(ft.filter((function(e){if(function(e){const t=n.resolve(yt,"app.js"),a=n.resolve(yt,"app."+$t.css),r=e.path.replace(Pt,vt);return t===r||a===r}(e))return!1;if("unlink"===e.event){try{t.sync([e.path.replace(Pt,n.resolve(mt,vt))],{force:!0})}catch(e){}return!1}return!0}))).pipe(f).pipe(ft.replace(/[\s\S]*/,(function(e){const t=c.parse(e);let a=0;const n=t.childNodes[0].childNodes[1];return function e(t,a){a&&(a(t),t.childNodes&&t.childNodes.forEach(t=>{e(t,a)}))}(t,e=>{if("img"===e.nodeName&&(e.nodeName="image",e.tagName="image"),"#text"===e.nodeName&&"wxs"===e.parentNode.nodeName){e.value.replace(jt,(t,n,r,i)=>{const s=Nt(this.file.relative),o=n.replace(xt,Et(s)).replace(/['"]/g,"");e.parentNode.attrs.push({name:"src",value:o}),e.parentNode.childNodes=[],a=1,console.log(`\n编译${t}--\x3erequire(${o})`)})}}),a?c.serialize(n):e}),{skipBinary:!1})).pipe(f.restore).pipe(r).pipe(ft.replace(/^/,(function(e){return wt.plugin?`var App=function(packInit){};${$t.globalObject}.canIUse=function(){return false};`:`var __packConfig=require('../pack.config.js');var App=function(packInit){var ${ht}=${(""+dt).replace(/globalObject/g,$t.globalObject)};${ht}(packInit,__packConfig.packPath,__packConfig.appMode);};`}),{skipBinary:!1})).pipe(r.restore).pipe(e).pipe(u()).pipe(At()).pipe(e.restore).pipe(i).pipe(ft.replace(/^/,(function(e){return"var __uniPluginExports={};\n"}),{skipBinary:!1})).pipe(ft.replace(/$/,(function(e){return"\nmodule.exports=__uniPluginExports;"}),{skipBinary:!1})).pipe(i.restore).pipe(s).pipe(ft.replace(/^/,(function(e){if(o.existsSync(n.resolve(mt,"src",this.file.relative)))return e;return`require('${Et(Nt(this.file.relative))}app.js');\n`}),{skipBinary:!1})).pipe(s.restore).pipe(g).pipe(ft.replace(/[\s\S]*/,(function(e){if(!o.existsSync(n.resolve(mt,"src",this.file.relative.replace(/json$/,"vue")))&&!o.existsSync(n.resolve(mt,"src",this.file.relative.replace(/json$/,"nvue"))))return e;let t=JSON.parse(""+this.file.contents);for(let e in t.usingComponents)0===t.usingComponents[e].indexOf("/")&&(t.usingComponents[e]=Et(Nt(this.file.relative))+t.usingComponents[e].replace(/^\//,""));return JSON.stringify(t)}),{skipBinary:!1})).pipe(g.restore).pipe(l).pipe(ft.stripCssComments()).pipe(ft.replace(_t,(function(e,t,a){let n="",r=Nt(this.file.relative);return(a+=";").replace(/\s*import\s*:\s*(('[^\s';]*')|("[^\s";]*"))/g,(function(e,t){n+=`@import ${t.replace(xt,Et(r))};\n`})),t+n}),{skipBinary:!1})).pipe(l.restore).pipe(p).pipe(ft.stripCssComments()).pipe(ft.replace(/^[\s\S]*$/,(function(e){if(vt===yt)return e;let t=Nt(this.file.relative);return"@import "+`"${St}/app.${$t.css}";`.replace(xt,Et(t))+("\n"+e)}),{skipBinary:!1})).pipe(p.restore).pipe(a.dest(vt,{cwd:mt}))}));const Lt=s(),{cwd:Rt,env:Ct,targetPath:Mt,subModePath:Jt,regExpWxResources:qt,regExpUniImportWxss:Wt,wxResourceAlias:Bt,wxResourcePath:It,currentNamespace:Ut}=_,{writeLastLine:Tt,getLevel:Ft,getLevelPath:Dt}=O,{uniRequireWxResource:Ht}=gt;a.task("subMode:copyWxResource",(function(){const e=Lt.filter([It+"/**/*.js"],{restore:!0}),r=Lt.filter([`${It}/**/*.${Ut.css}`],{restore:!0});return a.src([It+"/**",It],{allowEmpty:!0,cwd:Rt}).pipe(Lt.if("dev"===Ct,Lt.watch([It+"/**",It,`!/${It}/**/*.*___jb_tmp___`],{cwd:Rt},(function(e){Tt("处理"+e.relative+"......")})))).pipe(e).pipe(Lt.replace(/^/,(function(e){return`require('${Dt(Ft(this.file.relative))}app.js');\n`}),{skipBinary:!1})).pipe(u()).pipe(Ht()).pipe(e.restore).pipe(r).pipe(Lt.stripCssComments()).pipe(Lt.replace(Wt,(function(e,t,a){let n="";Ft(this.file.relative);return t+n}),{skipBinary:!1})).pipe(Lt.replace(/^[\s\S]*$/,(function(e){if(Jt===Mt)return e;let t=Ft(this.file.relative);return"@import "+`"${Bt}/app.${Ut.css}";`.replace(qt,Dt(t))+("\n"+e)}),{skipBinary:!1})).pipe(r.restore).pipe(Lt.filter((function(e){if("unlink"===e.event){try{t.sync([e.path.replace(n.resolve(Rt,It),n.resolve(Rt,Jt))],{force:!0})}catch(e){}return!1}return!0}))).pipe(a.dest(Jt,{cwd:Rt}))}));const{cwd:Kt,env:zt,targetPath:Vt,subModePath:Yt,projectToSubPackageConfig:Zt,program:Gt,currentNamespace:Qt}=_,{tryAgain:Xt}=O;a.task("mpWxSubMode",a.series((function(e){console.log("对uni-app进行解耦构建，解除uni-app对原生小程序方法的改写，此过程如果出现权限问题，请使用管理员权限运行"),e()}),"clean:previewDist",(async function e(t){if(Gt.plugin)t();else{try{let e={packPath:(Zt.subPackagePath?"/":"")+Zt.subPackagePath,appMode:Zt.appMode};await o.outputFile(Yt+"/pack.config.js","module.exports="+JSON.stringify(e,null,4))}catch(a){return void await Xt(async()=>{await e(t)})}t()}}),function(){let e=[async function(e){let t=n.resolve(Kt,Zt[Qt.mainMpPath],"app.js");await o.exists(t)||await o.outputFile(t,"App({});"),e()},"subMode:createUniSubPackage","subMode:copyWxResource",...Gt.plugin?["watch:pluginJson"]:["watch:baseAppJson","watch:pagesJson",...Zt.mergePack?["watch:mainWeixinMpPackPath"]:[],...Yt===Vt?["watch:topMode-mainAppJsAndAppWxss"]:[]],"watch:mainAppJson","watch:mainWeixinMp","watch:projectConfigJson"];return"build"===zt?a.series.apply(this,e):a.parallel.apply(this,e)}(),(function(e){e(),"build"===zt&&process.exit()})));const{cwd:ea,basePath:ta,base:aa}=_;a.task("startToPackServe",a.series((async function(e){await o.exists(ta)||await o.mkdirs(ta),e()}),"clean:base",(function(e){a.watch(aa+"/app.json",{events:["all"],cwd:ea},(function(){e()}))}),"mpWxSubMode")),process.on("unhandledRejection",()=>{});
