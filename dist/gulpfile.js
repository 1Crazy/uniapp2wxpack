!function(){const e=require("gulp"),n=require("del"),t=require("gulp-load-plugins")(),r=require("path"),i=require("fs-extra"),p=require("strip-json-comments"),a=require("gulp-strip-comments"),s=require("single-line-log").stdout,{program:o}=require("commander");o.option("--scope <type>","运行目录",process.cwd()).option("--plugin","插件模式"),o.parse(process.argv);const c=o.scope,u=require(r.resolve(c,"./projectToSubPackageConfig"));process.on("unhandledRejection",(e,n)=>{});let l="dev";"production"===process.env.NODE_ENV&&(l="build");const f="dist/"+l+"/mp-weixin";let w="dist/"+l+"/mp-weixin-pack";o.plugin&&(w="dist/"+l+"/mp-weixin-pack-plugin");const g=r.resolve(c,f),h=r.resolve(c,w,u.subPackagePath),d=r.resolve(c,w);let m,x;function y(e,n,t){wx.__uniapp2wxpack||(wx.__uniapp2wxpack={});var r=wx.__uniapp2wxpack[n.replace("/","")]={__packInit:{}};if(e)for(var i in e)"function"!=typeof e[i]?r.__packInit[i]=e[i]:function(n){r.__packInit[n]=function(){return e[n].apply(e,arguments)}}(i);else e={};if("none"!==t){var p=Page,a=Component,s="",o=1,c=1;"function"==typeof e.onError&&wx.onError((function(){return e.onError.apply(e,arguments)})),"function"==typeof e.onPageNotFound&&wx.onPageNotFound((function(){return e.onPageNotFound.apply(e,arguments)})),"function"==typeof e.onUnhandledRejection&&wx.onUnhandledRejection((function(){return e.onUnhandledRejection.apply(e,arguments)})),wx.onAppRoute((function(r){"top"!==t&&0!==("/"+r.path).indexOf(n+"/")&&(o=1,e.onHide.call(e,wx.getLaunchOptionsSync())),s=r.path})),wx.onAppHide((function(){if("top"===t)return e.onHide.call(e,wx.getLaunchOptionsSync());var r=getCurrentPages();return 0===("/"+r[r.length-1].route).indexOf(n+"/")?(o=1,s="",e.onHide.call(e,wx.getLaunchOptionsSync())):void 0})),wx.onAppShow((function(){"top"===t&&"function"==typeof e.onShow&&e.onShow.call(e,wx.getLaunchOptionsSync()),c&&getApp()&&(getApp().globalData||(getApp().globalData={}),Object.assign(getApp().globalData,e.globalData||{})),c=0})),"top"===t&&c&&"function"==typeof e.onLaunch&&e.onLaunch.call(e,wx.getLaunchOptionsSync()),Page=function(e){return u(e),p.call(this,e)},Component=function(e){return u(e.methods||{}),a.call(this,e)}}function u(r){if("top"!==t){var i=r.onShow;"function"!=typeof e.onShow&&"function"!=typeof e.onLaunch||(r.onShow=function(){var t=getCurrentPages();if(s&&0===("/"+s).indexOf(n+"/")||0!==("/"+t[t.length-1].route).indexOf(n+"/")||(o&&(o=0,e.onLaunch.call(e,wx.getLaunchOptionsSync())),e.onShow.call(e,wx.getLaunchOptionsSync())),"function"==typeof i)return i.apply(this,arguments)})}}}function k(e){s(e),clearTimeout(m),m=setTimeout(()=>{s("解耦构建，正在监听中......(此过程如果出现权限问题，请使用管理员权限运行)")},300)}async function v(e){return new Promise(async n=>{setTimeout(async()=>{n(await e())},100)})}function P(e){return Array(e).fill("../").join("")}function j(e){return e.split(/[\\/]/).length-1}function _(){return t.replace(/__uniRequireWx\(([a-zA-Z.\/"'@\d]+)\)/g,(function(e,n,t,r){let i=j(this.file.relative);return console.log(`\n编译${e}--\x3erequire(${n.replace(/@wxResource\//g,P(i))})`),`require(${n.replace(/@wxResource\//g,P(i))})`}),{skipBinary:!1})}function b(){if(o.plugin)return;const e=r.resolve(c,u.mainWeixinMpPath+"/app.js");if(i.existsSync(e)){const n=i.readFileSync(e,"utf8");let t=`require('${`./${u.subPackagePath}/`}app.js');\n`;if(h===d){t=`${i.readFileSync(g+"/app.js","utf8")};\n`}(x||o.plugin)&&(t=""),i.outputFileSync(d+"/app.js",t+n)}}function S(e){return k("处理app.json......"),t.replace(/[\s\S]+/,(function(n){if(o.plugin&&"mainAppJson"===e)return n;x=!1;let t,a,s,l={};({pagesJson(){try{t=JSON.parse(p(n))}catch(e){t={}}},baseAppJson(){try{a=JSON.parse(n)}catch(e){a={}}},mainAppJson(){try{s=JSON.parse(n)}catch(e){s={}}}})[e]();try{t||(t=JSON.parse(p(i.readFileSync(r.resolve(c,"src/pages.json"),"utf8"))))}catch(e){t={}}try{a||(a=JSON.parse(i.readFileSync(r.resolve(c,f+"/app.json"),"utf8")))}catch(e){a={}}try{s||(s=JSON.parse(i.readFileSync(r.resolve(c,u.mainWeixinMpPath+"/app.json"),"utf8")))}catch(e){s={}}function w(e){return u.subPackagePath+(u.subPackagePath?"/":"")+e}if(s.subPackages){let e=s.subPackages.find(e=>e.root===u.subPackagePath);if(e){x=!0;let n=[...t.wxResource&&t.wxResource.pages||[],...a.pages||[]];return a.subPackages&&a.subPackages.forEach(e=>{n=[...n,...(e.pages||[]).map(n=>e.root+(e.root?"/":"")+n)]}),t.wxResource&&t.wxResource.subPackages&&t.wxResource.subPackages.forEach(e=>{n=[...n,...(e.pages||[]).map(n=>e.root+(e.root?"/":"")+n)]}),e.pages=n,b(),delete a.pages,delete a.subPackages,JSON.stringify({...a,...s},null,2)}}a.pages&&a.pages.forEach((e,n)=>{a.pages[n]=w(e)}),a.subPackages&&a.subPackages.forEach(e=>{e.root=w(e.root)}),t.wxResource&&(t.wxResource.pages&&t.wxResource.pages.forEach((e,n)=>{t.wxResource.pages[n]=w(e)}),t.wxResource.subPackages&&t.wxResource.subPackages.forEach(e=>{e.root=w(e.root)})),a.tabBar&&a.tabBar.list&&a.tabBar.list.forEach(({pagePath:e,iconPath:n,selectedIconPath:t,...r},i)=>{a.tabBar.list[i]={pagePath:e?w(e):"",iconPath:n?w(n):"",selectedIconPath:t?w(t):"",...r}}),l={...a,...s},l.pages=Array.from(new Set([...t.indexPage?[w(t.indexPage)]:[],...s.pages||[],...a.pages||[],...t.wxResource&&t.wxResource.pages||[]]));let g=[],h={};function d(e){e.forEach(e=>{h[e.root]?h[e.root]=Array.from(new Set([...h[e.root],...e.pages])):h[e.root]=e.pages})}d(t.wxResource&&t.wxResource.subPackages||[]),d(a.subPackages||[]),d(s.subPackages||[]);for(let e in h)g.push({root:e,pages:h[e]});if(l.subPackages=[...g],a.usingComponents){for(let e in a.usingComponents)a.usingComponents[e]="/"+u.subPackagePath+a.usingComponents[e];l.usingComponents={...l.usingComponents||{},...a.usingComponents}}return b(),JSON.stringify(l,null,2)}),{skipBinary:!1})}function R(e){const n=u.mainWeixinMpPath+"/"+u.subPackagePath;return!i.existsSync(e.path.replace(r.resolve(c,n),r.resolve(c,f)))&&!i.existsSync(e.path.replace(r.resolve(c,n),r.resolve(c,"src/wxresource")))}y.name="fakeUniBootstrap",e.task("clean:base",(async function e(t){try{await n([g+"/**/*"],{force:!0})}catch(n){return void await v(async()=>{await e(t)})}t()})),e.task("clean:subModePath",(async function e(t){try{await n([h+"/**/*"],{force:!0})}catch(n){return void await v(async()=>{await e(t)})}t()})),e.task("clean:previewDist",(async function e(t){try{await n([d+"/**/*"],{force:!0})}catch(n){return void await v(async()=>{await e(t)})}t()})),e.task("watch:pluginJson",(function(){return e.src("src/plugin.json",{allowEmpty:!0,cwd:c}).pipe(t.if("dev"===l,t.watch("src/plugin.json",{cwd:c},(function(e){k("处理"+e.relative+"......")})))).pipe(e.dest(w+`/${u.subPackagePath}`,{cwd:c}))})),e.task("watch:projectConfigJson",(function(){return e.src("project.config.json",{allowEmpty:!0,cwd:c}).pipe(t.if("dev"===l,t.watch("project.config.json",{cwd:c},(function(e){k("处理"+e.relative+"......")})))).pipe(e.dest(w,{cwd:c}))})),e.task("watch:pagesJson",(function(){return e.src("src/pages.json",{allowEmpty:!0,cwd:c}).pipe(t.if("dev"===l,t.watch("src/pages.json",{cwd:c},(function(e){k("处理"+e.relative+"......")})))).pipe(S("pagesJson")).pipe(t.rename("app.json")).pipe(e.dest(w,{cwd:c}))})),e.task("watch:baseAppJson",(function(){return e.src(f+"/app.json",{allowEmpty:!0,cwd:c}).pipe(t.if("dev"===l,t.watch(f+"/app.json",{cwd:c},(function(e){k("处理"+e.relative+"......")})))).pipe(S("baseAppJson")).pipe(e.dest(w,{cwd:c}))})),e.task("watch:mainAppJson",(function(){let n=u.mainWeixinMpPath;return e.src(n+"/app.json",{allowEmpty:!0,cwd:c}).pipe(t.if("dev"===l,t.watch(n+"/app.json",{cwd:c},(function(e){k("处理"+e.relative+"......")})))).pipe(S("mainAppJson")).pipe(e.dest(w+(o.plugin?"/miniprogram":""),{cwd:c}))})),e.task("watch:topMode-mainAppJsAndAppWxss",(function(){let n=u.mainWeixinMpPath;const r=t.filter([n+"/app.wxss"],{restore:!0}),p=t.filter([n+"/app.js"],{restore:!0});return e.src([n+"/app.js",n+"/app.wxss"],{allowEmpty:!0,cwd:c}).pipe(t.if("dev"===l,t.watch([n+"/app.js",n+"/app.wxss"],{cwd:c},(function(e){k("处理"+e.relative+"......")})))).pipe(p).pipe(t.replace(/^/,(function(e){return`${i.readFileSync(g+"/app.js","utf8")};\n`}),{skipBinary:!1})).pipe(p.restore).pipe(r).pipe(t.replace(/^/,(function(e){return`${i.readFileSync(g+"/app.wxss","utf8")}\n`}),{skipBinary:!1})).pipe(r.restore).pipe(e.dest(w+(o.plugin?"/miniprogram":""),{cwd:c}))})),e.task("watch:mainWeixinMpPackPath",(function(){const i=u.mainWeixinMpPath,p=i+"/"+u.subPackagePath,a=w+"/"+u.subPackagePath;return e.src([p,p+"/**/*","!"+p+"/pack.config.js"],{allowEmpty:!0,cwd:c}).pipe(t.if("dev"===l,t.watch([p,p+"/**/*","!/"+p+"/pack.config.js"],{cwd:c},(function(e){k("处理"+e.relative+"......")})))).pipe(t.filter((function(e){if(!R(e))return!1;if("unlink"===e.event){try{n.sync([e.path.replace(r.resolve(c,i),r.resolve(c,w))],{force:!0})}catch(e){}return!1}return!0}))).pipe(e.dest(a,{cwd:c}))})),e.task("watch:mainWeixinMp",(function(){let p=u.mainWeixinMpPath,a=p+"/"+u.subPackagePath,s=t.filter([p+"/app.js"],{restore:!0});return e.src([p+"/**/*","!"+p+"/app.json","!"+p+"/**/*.json___jb_tmp___","!"+p+"/**/*.wxml___jb_tmp___","!"+p+"/**/*.wxss___jb_tmp___","!"+p+"/**/*.js___jb_tmp___","!"+a+"/**/*"],{base:r.resolve(c,p),allowEmpty:!0,cwd:c}).pipe(t.if("dev"===l,t.watch([p+"/**/*","!/"+p+"/app.json","!/"+a+"/**/*"],{cwd:c},(function(e){k("处理"+e.relative+"......")})))).pipe(t.filter((function(e){if("unlink"===e.event){try{n.sync([e.path.replace(r.resolve(c,p),r.resolve(c,w))],{force:!0})}catch(e){}return!1}return!0}))).pipe(s).pipe(t.replace(/^/,(function(e){if(x||o.plugin)return"";let n=`./${u.subPackagePath}/`;if(h===d){return`${i.readFileSync(g+"/app.js","utf8")};\n`}return`require('${n}app.js');\n`}),{skipBinary:!1})).pipe(s.restore).pipe(e.dest(w+(o.plugin?"/miniprogram":""),{cwd:c}))})),e.task("subMode:createUniSubPackage",(function(){i.mkdirsSync(g);let p=t.filter([f+"/common/vendor.js",f+"/common/main.js",f+"/common/runtime.js",f+"/pages/**/*.js"],{restore:!0}),s=t.filter([f+"/common/vendor.js"],{restore:!0}),u=t.filter([f+"/common/main.js"],{restore:!0}),w=t.filter([f+"/**/*.js","!"+f+"/app.js","!"+f+"/common/vendor.js","!"+f+"/common/main.js","!"+f+"/common/runtime.js"],{restore:!0}),m=t.filter([f+"/**/*.wxss","!"+f+"/app.wxss","!"+f+"/common/main.wxss"],{restore:!0}),x=t.filter([f+"/**/*.wxss","!"+f+"/app.wxss"],{restore:!0}),v=t.filter([f+"/**/*.json"],{restore:!0});return e.src([f+"/**","!"+f+"/*.*",f+"/app.js",f+"/app.wxss"],{allowEmpty:!0,cwd:c}).pipe(t.if("dev"===l,t.watch([f+"/**/*","!/"+f+"/*.json"],{cwd:c},(function(e){k("处理"+e.relative+"......")})))).pipe(t.filter((function(e){if(function(e){const n=r.resolve(d,"app.js"),t=r.resolve(d,"app.wxss"),i=e.path.replace(g,h);return n===i||t===i}(e))return!1;if("unlink"===e.event){try{n.sync([e.path.replace(g,r.resolve(c,h))],{force:!0})}catch(e){}return!1}return!0}))).pipe(s).pipe(t.replace(/^/,(function(e){return o.plugin?"var App=function(packInit){};wx.canIUse=function(){return false};":`var __packConfig=require('../pack.config.js');var App=function(packInit){${y.toString()};${y.name}(packInit,__packConfig.packPath,__packConfig.appMode);};`}),{skipBinary:!1})).pipe(s.restore).pipe(p).pipe(a()).pipe(_()).pipe(p.restore).pipe(u).pipe(t.replace(/^/,(function(e){return"var __uniPluginExports={};\n"}),{skipBinary:!1})).pipe(t.replace(/$/,(function(e){return"\nmodule.exports=__uniPluginExports;"}),{skipBinary:!1})).pipe(u.restore).pipe(w).pipe(t.replace(/^/,(function(e){if(i.existsSync(r.resolve(c,"src",this.file.relative)))return e;return`require('${P(j(this.file.relative))}app.js');\n`}),{skipBinary:!1})).pipe(w.restore).pipe(v).pipe(t.replace(/[\s\S]*/,(function(e){if(!i.existsSync(r.resolve(c,"src",this.file.relative.replace(/json$/,"vue")))&&!i.existsSync(r.resolve(c,"src",this.file.relative.replace(/json$/,"nvue"))))return e;let n=JSON.parse(this.file.contents.toString());for(let e in n.usingComponents)0===n.usingComponents[e].indexOf("/")&&(n.usingComponents[e]=P(j(this.file.relative))+n.usingComponents[e].replace(/^\//,""));return JSON.stringify(n)}),{skipBinary:!1})).pipe(v.restore).pipe(x).pipe(t.stripCssComments()).pipe(t.replace(/(}|^|\s|;)__uniWxss\s*{([^{}]+)}/g,(function(e,n,t){let r="",i=j(this.file.relative);return(t+";").replace(/\s*import\s*:\s*(('[^\s';]*')|("[^\s";]*"))/g,(function(e,n){r+=`@import ${n.replace(/@wxResource\//g,P(i))};\n`})),n+r}),{skipBinary:!1})).pipe(x.restore).pipe(m).pipe(t.stripCssComments()).pipe(t.replace(/^[\s\S]*$/,(function(e){if(h===d)return e;let n=j(this.file.relative);return`@import ${'"@wxResource/app.wxss";'.replace(/@wxResource\//g,P(n))}`+`\n${e}`}),{skipBinary:!1})).pipe(m.restore).pipe(e.dest(h,{cwd:c}))})),e.task("subMode:copyWxResource",(function(){let i=t.filter(["src/wxresource/**/*.js"],{restore:!0}),p=t.filter(["src/wxresource/**/*.wxss"],{restore:!0});return e.src(["src/wxresource/**","src/wxresource"],{allowEmpty:!0,cwd:c}).pipe(t.if("dev"===l,t.watch(["src/wxresource/**","src/wxresource","!/src/wxresource/**/*.*___jb_tmp___"],{cwd:c},(function(e){k("处理"+e.relative+"......")})))).pipe(i).pipe(t.replace(/^/,(function(e){return`require('${P(j(this.file.relative))}app.js');\n`}),{skipBinary:!1})).pipe(a()).pipe(_()).pipe(i.restore).pipe(p).pipe(t.stripCssComments()).pipe(t.replace(/(}|^|\s|;)__uniWxss\s*{([^{}]+)}/g,(function(e,n,t){let r="",i=j(this.file.relative);return(t+";").replace(/\s*import\s*:\s*(('[^\s']*')|("[^\s']*"))/g,(function(e,n){r+=`@import ${n.replace(/@wxResource\//g,P(i))};\n`})),n+r}),{skipBinary:!1})).pipe(t.replace(/^[\s\S]*$/,(function(e){if(h===d)return e;let n=j(this.file.relative);return`@import ${'"@wxResource/app.wxss";'.replace(/@wxResource\//g,P(n))}`+`\n${e}`}),{skipBinary:!1})).pipe(p.restore).pipe(t.filter((function(e){if("unlink"===e.event){try{n.sync([e.path.replace(r.resolve(c,"src/wxresource"),r.resolve(c,h))],{force:!0})}catch(e){}return!1}return!0}))).pipe(e.dest(h,{cwd:c}))})),e.task("mpWxSubMode",e.series((function(e){console.log("对uni-app进行解耦构建，解除uni-app对原生小程序方法的改写，此过程如果出现权限问题，请使用管理员权限运行"),e()}),"clean:previewDist",(async function e(n){if(o.plugin)n();else{try{let e={packPath:(u.subPackagePath?"/":"")+u.subPackagePath,appMode:u.appMode};await i.outputFile(h+"/pack.config.js",`module.exports=${JSON.stringify(e,null,4)}`)}catch(t){return void await v(async()=>{await e(n)})}n()}}),function(){let n=[async function(e){let n=r.resolve(c,u.mainWeixinMpPath,"app.js");await i.exists(n)||await i.outputFile(n,"App({});"),e()},"subMode:createUniSubPackage","subMode:copyWxResource",...o.plugin?["watch:pluginJson"]:["watch:baseAppJson","watch:pagesJson",...u.mergePack?["watch:mainWeixinMpPackPath"]:[],...h===d?["watch:topMode-mainAppJsAndAppWxss"]:[]],"watch:mainAppJson","watch:mainWeixinMp","watch:projectConfigJson"];return"build"===l?e.series.apply(this,n):e.parallel.apply(this,n)}(),(function(e){e(),"build"===l&&process.exit()}))),e.task("startToPackServe",e.series((async function(e){await i.exists(g)||await i.mkdirs(g),e()}),"clean:base",(function(n){e.watch(f+"/app.json",{events:["all"],cwd:c},(function(){n()}))}),"mpWxSubMode"))}();