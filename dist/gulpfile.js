!function(){const e=require("gulp"),n=require("del"),t=require("gulp-load-plugins")(),i=require("path"),p=require("fs-extra"),a=require("strip-json-comments"),r=require("gulp-strip-comments"),s=require("single-line-log").stdout,{program:o}=require("commander");o.option("--scope <type>","运行目录",process.cwd()).option("--plugin","插件模式"),o.parse(process.argv);const c=o.scope,u=require(i.resolve(c,"./projectToSubPackageConfig")),l=u.wxResourcePath||"src/wxresource",f=u.wxResourceAlias||"@wxResource",g=new RegExp(`${f}\\/`,"g"),w=u.uniRequireApiName||"__uniRequireWx",h=new RegExp(`${w}\\(([a-zA-Z.\\/"'@\\d]+)\\)`,"g"),d=u.uniImportWxssApiName||"__uniWxss",m=new RegExp(`(}|^|\\s|;)${d}\\s*{([^{}]+)}`,"g"),y=u.configWxResourceKey||"wxResource";process.on("unhandledRejection",(e,n)=>{});let k="dev";"production"===process.env.NODE_ENV&&(k="build");const x="dist/"+k+"/mp-weixin";let v="dist/"+k+"/mp-weixin-pack";o.plugin&&(v="dist/"+k+"/mp-weixin-pack-plugin");const P=i.resolve(c,x),j=i.resolve(c,v,u.subPackagePath),b=i.resolve(c,v);let _,S;function A(e,n,t){wx.__uniapp2wxpack||(wx.__uniapp2wxpack={});var i=wx.__uniapp2wxpack[n.replace("/","")]={__packInit:{}};if(e)for(var p in e)"function"!=typeof e[p]?i.__packInit[p]=e[p]:function(n){i.__packInit[n]=function(){return e[n].apply(e,arguments)}}(p);else e={};if("none"!==t){var a=Page,r=Component,s="",o=1,c=1;"function"==typeof e.onError&&wx.onError((function(){return e.onError.apply(e,arguments)})),"function"==typeof e.onPageNotFound&&wx.onPageNotFound((function(){return e.onPageNotFound.apply(e,arguments)})),"function"==typeof e.onUnhandledRejection&&wx.onUnhandledRejection((function(){return e.onUnhandledRejection.apply(e,arguments)})),wx.onAppRoute((function(i){"top"!==t&&0!==("/"+i.path).indexOf(n+"/")&&(o=1,e.onHide.call(e,wx.getLaunchOptionsSync())),s=i.path})),wx.onAppHide((function(){if("top"===t)return e.onHide.call(e,wx.getLaunchOptionsSync());var i=getCurrentPages();return 0===("/"+i[i.length-1].route).indexOf(n+"/")?(o=1,s="",e.onHide.call(e,wx.getLaunchOptionsSync())):void 0})),wx.onAppShow((function(){"top"===t&&"function"==typeof e.onShow&&e.onShow.call(e,wx.getLaunchOptionsSync()),c&&getApp()&&(getApp().globalData||(getApp().globalData={}),Object.assign(getApp().globalData,e.globalData||{})),c=0})),"top"===t&&c&&"function"==typeof e.onLaunch&&e.onLaunch.call(e,wx.getLaunchOptionsSync()),Page=function(e){return u(e),a.call(this,e)},Component=function(e){return u(e.methods||{}),r.call(this,e)}}function u(i){if("top"!==t){var p=i.onShow;"function"!=typeof e.onShow&&"function"!=typeof e.onLaunch||(i.onShow=function(){var t=getCurrentPages();if(s&&0===("/"+s).indexOf(n+"/")||0!==("/"+t[t.length-1].route).indexOf(n+"/")||(o&&(o=0,e.onLaunch.call(e,wx.getLaunchOptionsSync())),e.onShow.call(e,wx.getLaunchOptionsSync())),"function"==typeof p)return p.apply(this,arguments)})}}}function $(e){s(e),clearTimeout(_),_=setTimeout(()=>{s("解耦构建，正在监听中......(此过程如果出现权限问题，请使用管理员权限运行)")},300)}async function J(e){return new Promise(async n=>{setTimeout(async()=>{n(await e())},100)})}function E(e){return Array(e).fill("../").join("")}function C(e){return e.split(/[\\/]/).length-1}function O(){return t.replace(h,(function(e,n,t,i){let p=C(this.file.relative);return console.log(`\n编译${e}--\x3erequire(${n.replace(g,E(p))})`),`require(${n.replace(g,E(p))})`}),{skipBinary:!1})}function M(){if(o.plugin)return;const e=i.resolve(c,u.mainWeixinMpPath+"/app.js");if(p.existsSync(e)){const n=p.readFileSync(e,"utf8");let t=`require('${`./${u.subPackagePath}/`}app.js');\n`;if(j===b){t=`${p.readFileSync(P+"/app.js","utf8")};\n`}(S||o.plugin)&&(t=""),p.outputFileSync(b+"/app.js",t+n)}}function W(e){return $("处理app.json......"),t.replace(/[\s\S]+/,(function(n){if(o.plugin&&"mainAppJson"===e)return n;S=!1;let t,r,s,l={};({pagesJson(){try{t=JSON.parse(a(n))}catch(e){t={}}},baseAppJson(){try{r=JSON.parse(n)}catch(e){r={}}},mainAppJson(){try{s=JSON.parse(n)}catch(e){s={}}}})[e]();try{t||(t=JSON.parse(a(p.readFileSync(i.resolve(c,"src/pages.json"),"utf8"))))}catch(e){t={}}try{r||(r=JSON.parse(p.readFileSync(i.resolve(c,x+"/app.json"),"utf8")))}catch(e){r={}}try{s||(s=JSON.parse(p.readFileSync(i.resolve(c,u.mainWeixinMpPath+"/app.json"),"utf8")))}catch(e){s={}}function f(e){return u.subPackagePath+(u.subPackagePath?"/":"")+e}if(s.subPackages){let e=s.subPackages.find(e=>e.root===u.subPackagePath);if(e){S=!0;let n=[...t[y]&&t[y].pages||[],...r.pages||[]];return r.subPackages&&r.subPackages.forEach(e=>{n=[...n,...(e.pages||[]).map(n=>e.root+(e.root?"/":"")+n)]}),t[y]&&t[y].subPackages&&t[y].subPackages.forEach(e=>{n=[...n,...(e.pages||[]).map(n=>e.root+(e.root?"/":"")+n)]}),e.pages=n,M(),delete r.pages,delete r.subPackages,JSON.stringify({...r,...s},null,2)}}r.pages&&r.pages.forEach((e,n)=>{r.pages[n]=f(e)}),r.subPackages&&r.subPackages.forEach(e=>{e.root=f(e.root)}),t[y]&&(t[y].pages&&t[y].pages.forEach((e,n)=>{t[y].pages[n]=f(e)}),t[y].subPackages&&t[y].subPackages.forEach(e=>{e.root=f(e.root)})),r.tabBar&&r.tabBar.list&&r.tabBar.list.forEach(({pagePath:e,iconPath:n,selectedIconPath:t,...i},p)=>{r.tabBar.list[p]={pagePath:e?f(e):"",iconPath:n?f(n):"",selectedIconPath:t?f(t):"",...i}}),l={...r,...s},l.pages=Array.from(new Set([...t.indexPage?[f(t.indexPage)]:[],...s.pages||[],...r.pages||[],...t[y]&&t[y].pages||[]]));let g=[],w={};function h(e){e.forEach(e=>{w[e.root]?w[e.root]=Array.from(new Set([...w[e.root],...e.pages])):w[e.root]=e.pages})}h(t[y]&&t[y].subPackages||[]),h(r.subPackages||[]),h(s.subPackages||[]);for(let e in w)g.push({root:e,pages:w[e]});if(l.subPackages=[...g],r.usingComponents){for(let e in r.usingComponents)r.usingComponents[e]="/"+u.subPackagePath+r.usingComponents[e];l.usingComponents={...l.usingComponents||{},...r.usingComponents}}return M(),JSON.stringify(l,null,2)}),{skipBinary:!1})}function B(e){const n=n,t=u.mainWeixinMpPath+"/"+u.subPackagePath;return!p.existsSync(e.path.replace(i.resolve(c,t),i.resolve(c,x)))&&!p.existsSync(e.path.replace(i.resolve(c,t),i.resolve(c,n)))}A.name="fakeUniBootstrap",e.task("clean:base",(async function e(t){try{await n([P+"/**/*"],{force:!0})}catch(n){return void await J(async()=>{await e(t)})}t()})),e.task("clean:subModePath",(async function e(t){try{await n([j+"/**/*"],{force:!0})}catch(n){return void await J(async()=>{await e(t)})}t()})),e.task("clean:previewDist",(async function e(t){try{await n([b+"/**/*"],{force:!0})}catch(n){return void await J(async()=>{await e(t)})}t()})),e.task("watch:pluginJson",(function(){return e.src("src/plugin.json",{allowEmpty:!0,cwd:c}).pipe(t.if("dev"===k,t.watch("src/plugin.json",{cwd:c},(function(e){$("处理"+e.relative+"......")})))).pipe(e.dest(v+`/${u.subPackagePath}`,{cwd:c}))})),e.task("watch:projectConfigJson",(function(){return e.src("project.config.json",{allowEmpty:!0,cwd:c}).pipe(t.if("dev"===k,t.watch("project.config.json",{cwd:c},(function(e){$("处理"+e.relative+"......")})))).pipe(e.dest(v,{cwd:c}))})),e.task("watch:pagesJson",(function(){return e.src("src/pages.json",{allowEmpty:!0,cwd:c}).pipe(t.if("dev"===k,t.watch("src/pages.json",{cwd:c},(function(e){$("处理"+e.relative+"......")})))).pipe(W("pagesJson")).pipe(t.rename("app.json")).pipe(e.dest(v,{cwd:c}))})),e.task("watch:baseAppJson",(function(){return e.src(x+"/app.json",{allowEmpty:!0,cwd:c}).pipe(t.if("dev"===k,t.watch(x+"/app.json",{cwd:c},(function(e){$("处理"+e.relative+"......")})))).pipe(W("baseAppJson")).pipe(e.dest(v,{cwd:c}))})),e.task("watch:mainAppJson",(function(){let n=u.mainWeixinMpPath;return e.src(n+"/app.json",{allowEmpty:!0,cwd:c}).pipe(t.if("dev"===k,t.watch(n+"/app.json",{cwd:c},(function(e){$("处理"+e.relative+"......")})))).pipe(W("mainAppJson")).pipe(e.dest(v+(o.plugin?"/miniprogram":""),{cwd:c}))})),e.task("watch:topMode-mainAppJsAndAppWxss",(function(){let n=u.mainWeixinMpPath;const i=t.filter([n+"/app.wxss"],{restore:!0}),a=t.filter([n+"/app.js"],{restore:!0});return e.src([n+"/app.js",n+"/app.wxss"],{allowEmpty:!0,cwd:c}).pipe(t.if("dev"===k,t.watch([n+"/app.js",n+"/app.wxss"],{cwd:c},(function(e){$("处理"+e.relative+"......")})))).pipe(a).pipe(t.replace(/^/,(function(e){return`${p.readFileSync(P+"/app.js","utf8")};\n`}),{skipBinary:!1})).pipe(a.restore).pipe(i).pipe(t.replace(/^/,(function(e){return`${p.readFileSync(P+"/app.wxss","utf8")}\n`}),{skipBinary:!1})).pipe(i.restore).pipe(e.dest(v+(o.plugin?"/miniprogram":""),{cwd:c}))})),e.task("watch:mainWeixinMpPackPath",(function(){const p=u.mainWeixinMpPath,a=p+"/"+u.subPackagePath,r=v+"/"+u.subPackagePath;return e.src([a,a+"/**/*","!"+a+"/pack.config.js"],{allowEmpty:!0,cwd:c}).pipe(t.if("dev"===k,t.watch([a,a+"/**/*","!/"+a+"/pack.config.js"],{cwd:c},(function(e){$("处理"+e.relative+"......")})))).pipe(t.filter((function(e){if(!B(e))return!1;if("unlink"===e.event){try{n.sync([e.path.replace(i.resolve(c,p),i.resolve(c,v))],{force:!0})}catch(e){}return!1}return!0}))).pipe(e.dest(r,{cwd:c}))})),e.task("watch:mainWeixinMp",(function(){let a=u.mainWeixinMpPath,r=a+"/"+u.subPackagePath,s=t.filter([a+"/app.js"],{restore:!0});return e.src([a+"/**/*","!"+a+"/app.json","!"+a+"/**/*.json___jb_tmp___","!"+a+"/**/*.wxml___jb_tmp___","!"+a+"/**/*.wxss___jb_tmp___","!"+a+"/**/*.js___jb_tmp___","!"+r+"/**/*"],{base:i.resolve(c,a),allowEmpty:!0,cwd:c}).pipe(t.if("dev"===k,t.watch([a+"/**/*","!/"+a+"/app.json","!/"+r+"/**/*"],{cwd:c},(function(e){$("处理"+e.relative+"......")})))).pipe(t.filter((function(e){if("unlink"===e.event){try{n.sync([e.path.replace(i.resolve(c,a),i.resolve(c,v))],{force:!0})}catch(e){}return!1}return!0}))).pipe(s).pipe(t.replace(/^/,(function(e){if(S||o.plugin)return"";let n=`./${u.subPackagePath}/`;if(j===b){return`${p.readFileSync(P+"/app.js","utf8")};\n`}return`require('${n}app.js');\n`}),{skipBinary:!1})).pipe(s.restore).pipe(e.dest(v+(o.plugin?"/miniprogram":""),{cwd:c}))})),e.task("subMode:createUniSubPackage",(function(){p.mkdirsSync(P);let a=t.filter([x+"/common/vendor.js",x+"/common/main.js",x+"/common/runtime.js",x+"/pages/**/*.js"],{restore:!0}),s=t.filter([x+"/common/vendor.js"],{restore:!0}),u=t.filter([x+"/common/main.js"],{restore:!0}),l=t.filter([x+"/**/*.js","!"+x+"/app.js","!"+x+"/common/vendor.js","!"+x+"/common/main.js","!"+x+"/common/runtime.js"],{restore:!0}),w=t.filter([x+"/**/*.wxss","!"+x+"/app.wxss","!"+x+"/common/main.wxss"],{restore:!0}),h=t.filter([x+"/**/*.wxss","!"+x+"/app.wxss"],{restore:!0}),d=t.filter([x+"/**/*.json"],{restore:!0});return e.src([x+"/**","!"+x+"/*.*",x+"/app.js",x+"/app.wxss"],{allowEmpty:!0,cwd:c}).pipe(t.if("dev"===k,t.watch([x+"/**/*","!/"+x+"/*.json"],{cwd:c},(function(e){$("处理"+e.relative+"......")})))).pipe(t.filter((function(e){if(function(e){const n=i.resolve(b,"app.js"),t=i.resolve(b,"app.wxss"),p=e.path.replace(P,j);return n===p||t===p}(e))return!1;if("unlink"===e.event){try{n.sync([e.path.replace(P,i.resolve(c,j))],{force:!0})}catch(e){}return!1}return!0}))).pipe(s).pipe(t.replace(/^/,(function(e){return o.plugin?"var App=function(packInit){};wx.canIUse=function(){return false};":`var __packConfig=require('../pack.config.js');var App=function(packInit){${A.toString()};${A.name}(packInit,__packConfig.packPath,__packConfig.appMode);};`}),{skipBinary:!1})).pipe(s.restore).pipe(a).pipe(r()).pipe(O()).pipe(a.restore).pipe(u).pipe(t.replace(/^/,(function(e){return"var __uniPluginExports={};\n"}),{skipBinary:!1})).pipe(t.replace(/$/,(function(e){return"\nmodule.exports=__uniPluginExports;"}),{skipBinary:!1})).pipe(u.restore).pipe(l).pipe(t.replace(/^/,(function(e){if(p.existsSync(i.resolve(c,"src",this.file.relative)))return e;return`require('${E(C(this.file.relative))}app.js');\n`}),{skipBinary:!1})).pipe(l.restore).pipe(d).pipe(t.replace(/[\s\S]*/,(function(e){if(!p.existsSync(i.resolve(c,"src",this.file.relative.replace(/json$/,"vue")))&&!p.existsSync(i.resolve(c,"src",this.file.relative.replace(/json$/,"nvue"))))return e;let n=JSON.parse(this.file.contents.toString());for(let e in n.usingComponents)0===n.usingComponents[e].indexOf("/")&&(n.usingComponents[e]=E(C(this.file.relative))+n.usingComponents[e].replace(/^\//,""));return JSON.stringify(n)}),{skipBinary:!1})).pipe(d.restore).pipe(h).pipe(t.stripCssComments()).pipe(t.replace(m,(function(e,n,t){let i="",p=C(this.file.relative);return(t+";").replace(/\s*import\s*:\s*(('[^\s';]*')|("[^\s";]*"))/g,(function(e,n){i+=`@import ${n.replace(g,E(p))};\n`})),n+i}),{skipBinary:!1})).pipe(h.restore).pipe(w).pipe(t.stripCssComments()).pipe(t.replace(/^[\s\S]*$/,(function(e){if(j===b)return e;let n=C(this.file.relative);return`@import ${('"'+f+'/app.wxss";').replace(g,E(n))}`+`\n${e}`}),{skipBinary:!1})).pipe(w.restore).pipe(e.dest(j,{cwd:c}))})),e.task("subMode:copyWxResource",(function(){let p=t.filter([l+"/**/*.js"],{restore:!0}),a=t.filter([l+"/**/*.wxss"],{restore:!0});return e.src([l+"/**",l],{allowEmpty:!0,cwd:c}).pipe(t.if("dev"===k,t.watch([l+"/**",l,`!/${l}/**/*.*___jb_tmp___`],{cwd:c},(function(e){$("处理"+e.relative+"......")})))).pipe(p).pipe(t.replace(/^/,(function(e){return`require('${E(C(this.file.relative))}app.js');\n`}),{skipBinary:!1})).pipe(r()).pipe(O()).pipe(p.restore).pipe(a).pipe(t.stripCssComments()).pipe(t.replace(m,(function(e,n,t){let i="",p=C(this.file.relative);return(t+";").replace(/\s*import\s*:\s*(('[^\s']*')|("[^\s']*"))/g,(function(e,n){i+=`@import ${n.replace(g,E(p))};\n`})),n+i}),{skipBinary:!1})).pipe(t.replace(/^[\s\S]*$/,(function(e){if(j===b)return e;let n=C(this.file.relative);return`@import ${('"'+f+'/app.wxss";').replace(g,E(n))}`+`\n${e}`}),{skipBinary:!1})).pipe(a.restore).pipe(t.filter((function(e){if("unlink"===e.event){try{n.sync([e.path.replace(i.resolve(c,l),i.resolve(c,j))],{force:!0})}catch(e){}return!1}return!0}))).pipe(e.dest(j,{cwd:c}))})),e.task("mpWxSubMode",e.series((function(e){console.log("对uni-app进行解耦构建，解除uni-app对原生小程序方法的改写，此过程如果出现权限问题，请使用管理员权限运行"),e()}),"clean:previewDist",(async function e(n){if(o.plugin)n();else{try{let e={packPath:(u.subPackagePath?"/":"")+u.subPackagePath,appMode:u.appMode};await p.outputFile(j+"/pack.config.js",`module.exports=${JSON.stringify(e,null,4)}`)}catch(t){return void await J(async()=>{await e(n)})}n()}}),function(){let n=[async function(e){let n=i.resolve(c,u.mainWeixinMpPath,"app.js");await p.exists(n)||await p.outputFile(n,"App({});"),e()},"subMode:createUniSubPackage","subMode:copyWxResource",...o.plugin?["watch:pluginJson"]:["watch:baseAppJson","watch:pagesJson",...u.mergePack?["watch:mainWeixinMpPackPath"]:[],...j===b?["watch:topMode-mainAppJsAndAppWxss"]:[]],"watch:mainAppJson","watch:mainWeixinMp","watch:projectConfigJson"];return"build"===k?e.series.apply(this,n):e.parallel.apply(this,n)}(),(function(e){e(),"build"===k&&process.exit()}))),e.task("startToPackServe",e.series((async function(e){await p.exists(P)||await p.mkdirs(P),e()}),"clean:base",(function(n){e.watch(x+"/app.json",{events:["all"],cwd:c},(function(){n()}))}),"mpWxSubMode"))}();