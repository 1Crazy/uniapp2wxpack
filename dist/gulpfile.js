"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t=e(require("del")),n=e(require("gulp")),r=e(require("path")),a=e(require("commander")),s=e(require("single-line-log")),i=e(require("gulp-load-plugins")),p=e(require("vue-template-compiler")),c=e(require("preprocess")),o=e(require("fs-extra")),l=e(require("strip-json-comments")),u=e(require("gulp-strip-comments"));const{program:g}=a;g.option("--scope <type>","运行目录",process.cwd()).option("--plugin","插件模式").option("--type <type>","解耦包类型(哪种小程序)","weixin").option("--native","原生模式"),g.parse(process.argv);const f={weixin:{html:"wxml",css:"wxss",globalObject:"wx",mainMpPath:"mainWeixinMpPath",directivePrefix:"wx:"},baidu:{html:"swan",css:"css",globalObject:"swan",mainMpPath:"mainBaiduMpPath",directivePrefix:"s-"},toutiao:{html:"ttml",css:"ttss",globalObject:"tt",mainMpPath:"mainToutiaoMpPath",directivePrefix:"tt:"}},h=f[g.type];if(!h)throw Error("小程序类型错");process.env.PACK_TYPE=g.type;const m=g.scope,d=function(){return require.apply(null,arguments)}(r.resolve(m,"./projectToSubPackageConfig")),y=d.wxResourcePath||`src/${h.globalObject}resource`,v=d.wxResourceAlias||"@wxResource",b=RegExp(v+"\\/","g"),P=d.uniRequireApiName||"__uniRequireWx",w=RegExp(P+"\\(([a-zA-Z.\\/\"'@\\d]+)\\)","g"),k=d.uniImportWxssApiName||"__uniWxss",j=RegExp(`(}|^|\\s|;)${k}\\s*{([^{}]+)}`,"g");let x="dev";"production"===process.env.NODE_ENV&&(x="build");const $="dist/"+x+"/mp-"+g.type;let S="dist/"+x+`/mp-${g.type}-pack`;g.plugin&&(S="dist/"+x+`/mp-${g.type}-pack-plugin`);var _={currentNamespace:h,program:g,cwd:m,projectToSubPackageConfig:d,wxResourcePath:y,wxResourceAlias:v,regExpWxResources:b,uniRequireApiName:P,regExpUniRequire:w,uniImportWxssApiName:k,regExpUniImportWxss:j,configWxResourceKey:d.configWxResourceKey||"wxResource",env:x,base:$,target:S,basePath:r.resolve(m,$),subModePath:r.resolve(m,S,d.subPackagePath),targetPath:r.resolve(m,S),packIsSubpackage:{mode:!1},mpTypeNamespace:f};let E;const O=s.stdout;var N={tryAgain:async function(e){return new Promise(async t=>{setTimeout(async()=>{t(await e())},100)})},getLevelPath:function(e){return Array(e).fill("../").join("")},getLevel:function(e){return e.split(/[\\/]/).length-1},writeLastLine:function(e){O(e),clearTimeout(E),E=setTimeout(()=>{O("解耦构建，正在监听中......(此过程如果出现权限问题，请使用管理员权限运行)")},300)},deepFind:function e(t,n,r,a){n&&(n(t,r,a),t.childNodes?t.childNodes.forEach((t,r,a)=>{e(t,n,r,a)}):t.children&&t.children.forEach((t,r,a)=>{e(t,n,r,a)}))}};const{basePath:A}=_,{tryAgain:R}=N;n.task("clean:base",(async function e(n){try{await t([A+"/**/*"],{force:!0})}catch(t){return void await R(async()=>{await e(n)})}n()}));const{subModePath:C}=_,{tryAgain:M}=N;n.task("clean:subModePath",(async function e(n){try{await t([C+"/**/*"],{force:!0})}catch(t){return void await M(async()=>{await e(n)})}n()}));const{targetPath:L}=_,{tryAgain:B}=N;n.task("clean:previewDist",(async function e(n){try{await t([L+"/**/*"],{force:!0})}catch(t){return void await B(async()=>{await e(n)})}n()}));const{compile:T}=p;var J=class{constructor(e){this.topNode={children:[]},this.init(e)}init(e){this.topNode=T(`<div>${e}</div>`).ast}getAttr(e,t){return e.attrsMap&&e.attrsMap[t]||""}setAttr(e,t,n){if(!e.attrsMap)return"";e.attrsMap[t]=n}render(e=this.topNode.children,t=""){return e.reduce((e,t)=>{if(t.removed)return e;if(1===t.type&&!t.tag)return e;if(3===t.type||2===t.type)return e+=this.writeText(t);const{tag:n,attrsMap:r,children:a=[]}=t;return e+=this.writeOpenTag(n,r),e+=this.render(a),e+=this.writeCloseTag(n)},t)}writeOpenTag(e,t){if(t){const n=Object.keys(t).map(e=>t[e].indexOf('"')>-1&&0>t[e].indexOf("'")?`${e}='${t[e]}'`:`${e}="${t[e]}"`);return`<${e}${n.length>0?" "+n.join(" "):""}>`}return`<${e}>`}writeText(e){return e.text}writeCloseTag(e){return`</${e}>`}};const{currentNamespace:q,mpTypeNamespace:W}=_,{deepFind:F}=N,I=Object.keys(W).map(e=>W[e].directivePrefix),U=Object.keys(W).map(e=>W[e].html),K=RegExp(`^(${I.join("|")})`),D=RegExp(`\\.(${U.join("|")})$`,"i");var Y=function(e,t){if(t.relative.match(D)){const t=new J(e);return F(t.topNode,e=>{if(!e.tag||3===e.type)return;const n=t.getAttr(e,"class");"toutiao"===process.env.PACK_TYPE&&n&&!n.match(/(^\s|(\s$))/)&&t.setAttr(e,"class",n+" ");const r=t.getAttr(e,"catchTap");"toutiao"===process.env.PACK_TYPE&&r&&!t.getAttr(e,"bindTap")&&t.setAttr(e,"bindTap",r);const a=t.getAttr(e,"src");e.tag.match(/^(include|import)$/)&&a&&t.setAttr(e,"src",a.replace(D,"."+q.html)),e.attrsMap&&Object.keys(e.attrsMap).forEach(t=>{if(t.match(K)){const n=t.replace(K,q.directivePrefix);e.attrsMap[n]=e.attrsMap[t],n!==t&&delete e.attrsMap[t]}})}),t.render()}return e};const{currentNamespace:H,mpTypeNamespace:z}=_,V=Object.keys(z).map(e=>z[e].css),Z=RegExp(`\\.(${V.join("|")})$`,"i");var G=function(e,{relative:t}){return t.match(Z)&&(e=e.replace(/@import\s*['"](\S+)['"]/g,(function(e,t){return`@import '${t.replace(Z,"."+H.css)}'`}))),e};var Q=function(e,{relative:t}){return"toutiao"===process.env.PACK_TYPE&&t.match(/^\/app.js$/i)?"\nif (!Promise.prototype.finally) {\n    Promise.prototype.finally = function (callback) {\n        let P = this.constructor;\n        return this.then(\n            value  => P.resolve(callback()).then(() => value),\n            reason => P.resolve(callback()).then(() => { throw reason })\n        );\n    };\n}\n;\n"+e:e};const{preprocess:X}=c;var ee=function(e,{relative:t}){if(t.match(/.js$/i))try{return X(e,process.env,{type:"js"})}catch(t){return console.log("js条件编译出错"),console.log(t),e}return e};const{currentNamespace:te}=_,{preprocess:ne}=c;var re=function(e,{relative:t}){if(t.match(RegExp(`.${te.css}$`,"i")))try{return ne(e,process.env,{type:"css"})}catch(t){return console.log(te.css+"条件编译出错"),console.log(t),e}return e};const{currentNamespace:ae}=_,{preprocess:se}=c;var ie={htmlMixinPlugin:Y,cssMixinPlugin:G,polyfillPlugin:Q,jsPreProcessPlugin:ee,cssPreProcessPlugin:re,htmlPreProcessPlugin:function(e,{relative:t}){if(t.match(RegExp(`.${ae.html}$`,"i")))try{return se(e,process.env,{type:"html"})}catch(t){return console.log(ae.html+"条件编译出错"),console.log(t),e}return e}};const{projectToSubPackageConfig:pe,targetPath:ce}=_;(!pe.plugins||!pe.plugins instanceof Array)&&(pe.plugins=[]);var oe={runPlugins:function(e){return function(t){const{plugins:n}=pe;if(!n||!n instanceof Array)return;const a=r.resolve(e,this.file.relative),s={relative:a.replace(RegExp("^"+ce.replace(/\\/g,"\\\\")),"").replace(/\\/g,"/"),absolute:a};return n.reduce((e,t)=>{if("string"==typeof t&&(t=ie[t]),"function"!=typeof t)return e;const n=t(e,s,ie);return null==n?e:n},t)}}};const le=i(),{cwd:ue,projectToSubPackageConfig:ge,target:fe,env:he}=_,{writeLastLine:me}=N,{runPlugins:de}=oe;n.task("watch:pluginJson",(function(){return n.src("src/plugin.json",{allowEmpty:!0,cwd:ue}).pipe(le.if("dev"===he,le.watch("src/plugin.json",{cwd:ue},(function(e){me("处理"+e.relative+"......")})))).pipe(le.replace(/[\s\S]*/,de(r.resolve(ue,fe+"/"+ge.subPackagePath)),{skipBinary:!1})).pipe(n.dest(fe+"/"+ge.subPackagePath,{cwd:ue}))}));const ye=i(),{cwd:ve,target:be,env:Pe,targetPath:we}=_,{writeLastLine:ke}=N,{runPlugins:je}=oe;n.task("watch:projectConfigJson",(function(){return n.src("project.config.json",{allowEmpty:!0,cwd:ve}).pipe(ye.if("dev"===Pe,ye.watch("project.config.json",{cwd:ve},(function(e){ke("处理"+e.relative+"......")})))).pipe(ye.replace(/[\s\S]*/,je(we),{skipBinary:!1})).pipe(n.dest(be,{cwd:ve}))}));const{program:xe,cwd:$e,projectToSubPackageConfig:Se,basePath:_e,subModePath:Ee,targetPath:Oe,packIsSubpackage:Ne,currentNamespace:Ae}=_;var Re=function(){if(xe.plugin)return;const e=r.resolve($e,Se[Ae.mainMpPath]+"/app.js");if(o.existsSync(e)){const t=o.readFileSync(e,"utf8");let n=`require('${`./${Se.subPackagePath}/`}app.js');\n`;if(Ee===Oe){n=o.readFileSync(_e+"/app.js","utf8")+";\n"}(Ne.mode||xe.plugin)&&(n=""),o.outputFileSync(Oe+"/app.js",n+t)}};const Ce=i(),{program:Me,cwd:Le,projectToSubPackageConfig:Be,configWxResourceKey:Te,base:Je,packIsSubpackage:qe,currentNamespace:We}=_,{writeLastLine:Fe}=N;var Ie=function(e){return Fe("处理app.json......"),Ce.replace(/[\s\S]+/,(function(t){if(Me.plugin&&"mainAppJson"===e)return t;qe.mode=!1;let n,a,s,i={};({pagesJson(){try{n=JSON.parse(l(t))}catch(e){n={}}},baseAppJson(){try{a=JSON.parse(t)}catch(e){a={}}},mainAppJson(){try{s=JSON.parse(t)}catch(e){s={}}}})[e]();try{n||(n=JSON.parse(l(o.readFileSync(r.resolve(Le,"src/pages.json"),"utf8"))))}catch(e){n={}}try{a||(a=JSON.parse(o.readFileSync(r.resolve(Le,Je+"/app.json"),"utf8")))}catch(e){a={}}try{s||(s=JSON.parse(o.readFileSync(r.resolve(Le,Be[We.mainMpPath]+"/app.json"),"utf8")))}catch(e){s={}}function p(e){return Be.subPackagePath+(Be.subPackagePath?"/":"")+e}if(s.subPackages){let e=s.subPackages.find(e=>e.root===Be.subPackagePath);if(e){qe.mode=!0;let t=[...n[Te]&&n[Te].pages||[],...a.pages||[]];return a.subPackages&&a.subPackages.forEach(e=>{t=[...t,...(e.pages||[]).map(t=>e.root+(e.root?"/":"")+t)]}),n[Te]&&n[Te].subPackages&&n[Te].subPackages.forEach(e=>{t=[...t,...(e.pages||[]).map(t=>e.root+(e.root?"/":"")+t)]}),e.pages=t,Re(),delete a.pages,delete a.subPackages,JSON.stringify({...a,...s},null,2)}}a.pages&&a.pages.forEach((e,t)=>{a.pages[t]=p(e)}),a.subPackages&&a.subPackages.forEach(e=>{e.root=p(e.root)}),n[Te]&&(n[Te].pages&&n[Te].pages.forEach((e,t)=>{n[Te].pages[t]=p(e)}),n[Te].subPackages&&n[Te].subPackages.forEach(e=>{e.root=p(e.root)})),a.tabBar&&a.tabBar.list&&a.tabBar.list.forEach(({pagePath:e,iconPath:t,selectedIconPath:n,...r},s)=>{a.tabBar.list[s]={pagePath:e?p(e):"",iconPath:t?p(t):"",selectedIconPath:n?p(n):"",...r}}),i={...a,...s},i.pages=Array.from(new Set([...n.indexPage?[p(n.indexPage)]:[],...s.pages||[],...a.pages||[],...n[Te]&&n[Te].pages||[]]));let c=[],u={};function g(e){e.forEach(e=>{u[e.root]=u[e.root]?Array.from(new Set([...u[e.root],...e.pages])):e.pages})}g(n[Te]&&n[Te].subPackages||[]),g(a.subPackages||[]),g(s.subPackages||[]);for(let e in u)c.push({root:e,pages:u[e]});if(i.subPackages=[...c],a.usingComponents){for(let e in a.usingComponents)a.usingComponents[e]="/"+Be.subPackagePath+a.usingComponents[e];i.usingComponents={...i.usingComponents||{},...a.usingComponents}}return Re(),"toutiao"===Me.type&&i.subPackages&&(i.subPackages.forEach(e=>{e.pages.forEach(t=>{i.pages.push((e.root+"/"+t).replace(/\/\//g,"/"))})}),delete i.subPackages),JSON.stringify(i,null,2)}),{skipBinary:!1})};const Ue=i(),{cwd:Ke,target:De,env:Ye,targetPath:He}=_,{writeLastLine:ze}=N,{runPlugins:Ve}=oe;n.task("watch:pagesJson",(function(){return n.src("src/pages.json",{allowEmpty:!0,cwd:Ke}).pipe(Ue.if("dev"===Ye,Ue.watch("src/pages.json",{cwd:Ke},(function(e){ze("处理"+e.relative+"......")})))).pipe(Ie("pagesJson")).pipe(Ue.rename("app.json")).pipe(Ue.replace(/[\s\S]*/,Ve(He),{skipBinary:!1})).pipe(n.dest(De,{cwd:Ke}))}));const Ze=i(),{cwd:Ge,target:Qe,env:Xe,base:et,targetPath:tt}=_,{writeLastLine:nt}=N,{runPlugins:rt}=oe;n.task("watch:baseAppJson",(function(){return n.src(et+"/app.json",{allowEmpty:!0,cwd:Ge}).pipe(Ze.if("dev"===Xe,Ze.watch(et+"/app.json",{cwd:Ge},(function(e){nt("处理"+e.relative+"......")})))).pipe(Ie("baseAppJson")).pipe(Ze.replace(/[\s\S]*/,rt(tt),{skipBinary:!1})).pipe(n.dest(Qe,{cwd:Ge}))}));const at=i(),{cwd:st,target:it,env:pt,projectToSubPackageConfig:ct,program:ot,currentNamespace:lt}=_,{writeLastLine:ut}=N,{runPlugins:gt}=oe;n.task("watch:mainAppJson",(function(){let e=ct[lt.mainMpPath];return n.src(e+"/app.json",{allowEmpty:!0,cwd:st}).pipe(at.if("dev"===pt,at.watch(e+"/app.json",{cwd:st},(function(e){ut("处理"+e.relative+"......")})))).pipe(Ie("mainAppJson")).pipe(at.replace(/[\s\S]*/,gt(r.resolve(st,it+(ot.plugin?"/miniprogram":""))),{skipBinary:!1})).pipe(n.dest(it+(ot.plugin?"/miniprogram":""),{cwd:st}))}));const ft=i(),{cwd:ht,target:mt,env:dt,projectToSubPackageConfig:yt,program:vt,basePath:bt,currentNamespace:Pt,mpTypeNamespace:wt}=_,{writeLastLine:kt}=N,{runPlugins:jt}=oe;n.task("watch:topMode-mainAppJsAndAppWxss",(function(){let e=yt[Pt.mainMpPath];const t=Object.keys(wt).map(t=>`${e}/app.${wt[t].css}`),a=ft.filter([...t],{restore:!0}),s=ft.filter([e+"/app.js"],{restore:!0});return n.src([e+"/app.js",...t],{allowEmpty:!0,cwd:ht}).pipe(ft.if("dev"===dt,ft.watch([e+"/app.js",`${e}/app.${Pt.css}`],{cwd:ht},(function(e){kt("处理"+e.relative+"......")})))).pipe(s).pipe(ft.replace(/^/,(function(e){return o.readFileSync(bt+"/app.js","utf8")+";\n"}),{skipBinary:!1})).pipe(s.restore).pipe(a).pipe(ft.replace(/^/,(function(e){return o.readFileSync(`${bt}/app.${Pt.css}`,"utf8")+"\n"}),{skipBinary:!1})).pipe(ft.rename((function(e){e.extname="."+Pt.css}))).pipe(a.restore).pipe(ft.replace(/[\s\S]*/,jt(r.resolve(ht,mt+(vt.plugin?"/miniprogram":""))),{skipBinary:!1})).pipe(n.dest(mt+(vt.plugin?"/miniprogram":""),{cwd:ht}))}));const{mpTypeNamespace:xt,currentNamespace:$t}=_,St=(process,new Set(Object.keys(xt).map(e=>xt[e].globalObject)));var _t={mixinsEnvCode:function(e){let t="";return St.forEach(e=>{$t.globalObject!==e&&(t+=`var ${e} = ${$t.globalObject};\n`)}),t}};const Et=i(),{cwd:Ot,target:Nt,env:At,projectToSubPackageConfig:Rt,base:Ct,wxResourcePath:Mt,currentNamespace:Lt,mpTypeNamespace:Bt}=_,{writeLastLine:Tt}=N,{mixinsEnvCode:Jt}=_t,{runPlugins:qt}=oe;n.task("watch:mainWeixinMpPackPath",(function(){const e=Rt[Lt.mainMpPath],a=e+"/"+Rt.subPackagePath,s=Nt+"/"+Rt.subPackagePath,i=[],p=[],c=new Set,l=new Set;Object.keys(Bt).forEach(e=>{i.push(`${a}/**/*.${Bt[e].css}`),p.push(`${a}/**/*.${Bt[e].html}`),c.add("."+Bt[e].css),l.add("."+Bt[e].html)});const u=Et.filter([...p],{restore:!0}),g=Et.filter([...i],{restore:!0}),f=Et.filter([a+"/**/*.js"],{restore:!0});return n.src([a,a+"/**/*","!"+a+"/pack.config.js"],{allowEmpty:!0,cwd:Ot}).pipe(Et.if("dev"===At,Et.watch([a,a+"/**/*","!/"+a+"/pack.config.js"],{cwd:Ot},(function(e){Tt("处理"+e.relative+"......")})))).pipe(Et.filter((function(n){if(!function(e){const t=Rt[Lt.mainMpPath]+"/"+Rt.subPackagePath;return!o.existsSync(e.path.replace(r.resolve(Ot,t),r.resolve(Ot,Ct)))&&!o.existsSync(e.path.replace(r.resolve(Ot,t),r.resolve(Ot,Mt)))}(n))return!1;if("unlink"===n.event){try{let a=n.path;const s=RegExp(n.extname+"$","i");c.has(n.extname)&&(a=a.replace(s,"."+Lt.css)),l.has(n.extname)&&(a=a.replace(s,"."+Lt.html)),t.sync([a.replace(r.resolve(Ot,e),r.resolve(Ot,Nt))],{force:!0})}catch(e){}return!1}return!0}))).pipe(u).pipe(Et.rename((function(e){e.extname="."+Lt.html}))).pipe(u.restore).pipe(g).pipe(Et.rename((function(e){e.extname="."+Lt.css}))).pipe(g.restore).pipe(f).pipe(Et.replace(/[\s\S]*/,(function(e){return Jt(e)+e}),{skipBinary:!1})).pipe(f.restore).pipe(Et.replace(/[\s\S]*/,qt(r.resolve(Ot,s)),{skipBinary:!1})).pipe(n.dest(s,{cwd:Ot}))}));const Wt=i(),{cwd:Ft,target:It,env:Ut,projectToSubPackageConfig:Kt,basePath:Dt,subModePath:Yt,targetPath:Ht,program:zt,packIsSubpackage:Vt,currentNamespace:Zt,mpTypeNamespace:Gt}=_,{writeLastLine:Qt}=N,{mixinsEnvCode:Xt}=_t,{runPlugins:en}=oe;n.task("watch:mainWeixinMp",(function(){const e=Kt[Zt.mainMpPath],a=e+"/"+Kt.subPackagePath,s=[],i=[],p=new Set,c=new Set;Object.keys(Gt).forEach(t=>{s.push(`${e}/**/*.${Gt[t].css}`),i.push(`${e}/**/*.${Gt[t].html}`),p.add("."+Gt[t].css),c.add("."+Gt[t].html)});const o=Wt.filter([e+"/app.js"],{restore:!0}),l=Wt.filter([e+"/**/*.js"],{restore:!0}),u=Wt.filter([...i],{restore:!0}),g=Wt.filter([...s],{restore:!0});return n.src([e+"/**/*","!"+e+"/app.json","!"+e+"/**/*.json___jb_tmp___","!"+e+`/**/*.${Zt.html}___jb_tmp___`,"!"+e+`/**/*.${Zt.css}___jb_tmp___`,"!"+e+"/**/*.js___jb_tmp___","!"+a+"/**/*"],{base:r.resolve(Ft,e),allowEmpty:!0,cwd:Ft}).pipe(Wt.if("dev"===Ut,Wt.watch([e+"/**/*","!/"+e+"/app.json","!/"+a+"/**/*"],{cwd:Ft},(function(e){Qt("处理"+e.relative+"......")})))).pipe(Wt.filter((function(n){if("unlink"===n.event){try{let a=n.path;const s=RegExp(n.extname+"$","i");p.has(n.extname)&&(a=a.replace(s,"."+Zt.css)),c.has(n.extname)&&(a=a.replace(s,"."+Zt.html)),t.sync([a.replace(r.resolve(Ft,e),r.resolve(Ft,It))],{force:!0})}catch(e){}return!1}return!0}))).pipe(l).pipe(Wt.replace(/[\s\S]*/,(function(e){return Xt(e)+e}),{skipBinary:!1})).pipe(l.restore).pipe(o).pipe(Wt.replace(/^/,(function(e){if(Vt.mode||zt.plugin)return"";let t=`./${Kt.subPackagePath}/`;if(Yt===Ht){return fs.readFileSync(Dt+"/app.js","utf8")+";\n"}return`require('${t}app.js');\n`}),{skipBinary:!1})).pipe(o.restore).pipe(u).pipe(Wt.rename((function(e){e.extname="."+Zt.html}))).pipe(u.restore).pipe(g).pipe(Wt.rename((function(e){e.extname="."+Zt.css}))).pipe(g.restore).pipe(Wt.replace(/[\s\S]*/,en(r.resolve(Ft,It+(zt.plugin?"/miniprogram":""))),{skipBinary:!1})).pipe(n.dest(It+(zt.plugin?"/miniprogram":""),{cwd:Ft}))}));var tn={fakeUniBootstrap:function(e,t,n,r){globalObject.__uniapp2wxpack||(globalObject.__uniapp2wxpack={platform:r});var a=globalObject.__uniapp2wxpack[t.replace("/","")]={__packInit:{}};if(e)for(var s in e)"function"!=typeof e[s]?a.__packInit[s]=e[s]:function(t){a.__packInit[t]=function(){return e[t].apply(e,arguments)}}(s);else e={};if("none"!==n){var i=Page,p=Component,c="",o=1,l=1;"function"==typeof e.onError&&globalObject.onError&&globalObject.onError((function(){return e.onError.apply(e,arguments)})),"function"==typeof e.onPageNotFound&&globalObject.onPageNotFound&&globalObject.onPageNotFound((function(){return e.onPageNotFound.apply(e,arguments)})),"function"==typeof e.onUnhandledRejection&&globalObject.onUnhandledRejection&&globalObject.onUnhandledRejection((function(){return e.onUnhandledRejection.apply(e,arguments)})),globalObject.onAppRoute((function(r){"top"!==n&&0!==("/"+r.path).indexOf(t+"/")&&(o=1,e.onHide.call(e,globalObject.getLaunchOptionsSync())),c=r.path})),globalObject.onAppHide((function(){if("top"===n)return e.onHide.call(e,globalObject.getLaunchOptionsSync());var r=getCurrentPages();return 0===("/"+(null==r[r.length-1].route?r[r.length-1].__route__:r[r.length-1].route)).indexOf(t+"/")?(o=1,c="",e.onHide.call(e,globalObject.getLaunchOptionsSync())):void 0})),globalObject.onAppShow((function(){"top"===n&&"function"==typeof e.onShow&&e.onShow.call(e,globalObject.getLaunchOptionsSync()),l&&getApp()&&(getApp().globalData||(getApp().globalData={}),Object.assign(getApp().globalData,e.globalData||{})),l=0})),"top"===n&&l&&"function"==typeof e.onLaunch&&e.onLaunch.call(e,globalObject.getLaunchOptionsSync()),Page=function(e){return u(e),i.call(this,e)},Component=function(e){return u(e.methods||{}),p.call(this,e)}}function u(r){if("top"!==n){var a=r.onShow;"function"!=typeof e.onShow&&"function"!=typeof e.onLaunch||(r.onShow=function(){var n=getCurrentPages(),r=null==n[n.length-1].route?n[n.length-1].__route__:n[n.length-1].route;if(c&&0===("/"+c).indexOf(t+"/")||0!==("/"+r).indexOf(t+"/")||(o&&(o=0,e.onLaunch.call(e,globalObject.getLaunchOptionsSync())),e.onShow.call(e,globalObject.getLaunchOptionsSync())),"function"==typeof a)return a.apply(this,arguments)})}}},fakeUniBootstrapName:"fakeUniBootstrap"};const nn=i(),{regExpWxResources:rn,regExpUniRequire:an}=_,{getLevelPath:sn,getLevel:pn}=N;var cn={uniRequireWxResource:function(){return nn.replace(an,(function(e,t){const n=pn(this.file.relative);return console.log(`\n编译${e}--\x3erequire(${t.replace(rn,sn(n))})`),`require(${t.replace(rn,sn(n))})`}),{skipBinary:!1})}};const on=i(),{fakeUniBootstrapName:ln,fakeUniBootstrap:un}=tn,{cwd:gn,env:fn,program:hn,basePath:mn,targetPath:dn,subModePath:yn,base:vn,regExpUniRequire:bn,regExpWxResources:Pn,regExpUniImportWxss:wn,wxResourceAlias:kn,currentNamespace:jn,mpTypeNamespace:xn}=_,$n=process.env.PACK_TYPE,{writeLastLine:Sn,getLevel:_n,getLevelPath:En,deepFind:On}=N,{mixinsEnvCode:Nn}=_t,{uniRequireWxResource:An}=cn,{runPlugins:Rn}=oe,Cn=Object.keys(xn).map(e=>xn[e].css),Mn=new Set(Cn);n.task("subMode:createUniSubPackage",(function(){o.mkdirsSync(mn);const e=on.filter(vn+"/**/*.js",{restore:!0}),a=on.filter([vn+"/common/vendor.js"],{restore:!0}),s=on.filter([vn+"/common/main.js"],{restore:!0}),i=on.filter([vn+"/**/*.js","!"+vn+"/app.js","!"+vn+"/common/vendor.js","!"+vn+"/common/main.js","!"+vn+"/common/runtime.js"],{restore:!0}),p=on.filter([`${vn}/**/*.${jn.css}`,`!${vn}/app.${jn.css}`,`!${vn}/common/main.${jn.css}`],{restore:!0}),c=on.filter([`${vn}/**/*.${jn.css}`,`!${vn}/app.${jn.css}`],{restore:!0}),l=on.filter([vn+"/**/*.json"],{restore:!0}),g=on.filter([`${vn}/**/*.${jn.html}`],{restore:!0});return n.src([vn+"/**","!"+vn+"/*.*",vn+"/app.js",`${vn}/app.${jn.css}`],{allowEmpty:!0,cwd:gn}).pipe(on.if("dev"===fn,on.watch([vn+"/**/*","!/"+vn+"/*.json"],{cwd:gn},(function(e){Sn("处理"+e.relative+"......")})))).pipe(on.filter((function(e){if(function(e){const t=r.resolve(dn,"app.js"),n=r.resolve(dn,"app."+jn.css),a=e.path.replace(mn,yn);return t===a||n===a}(e))return!1;if("unlink"===e.event){try{let n=e.path;const a=RegExp(e.extname+"$","i");Mn.has(e.extname.substr(1))&&(n=n.replace(a,"."+jn.css)),t.sync([n.replace(mn,r.resolve(gn,yn))],{force:!0})}catch(e){}return!1}return!0}))).pipe(g).pipe(on.replace(/[\s\S]*/,(function(e){const t=new J(e);let n=0;return On(t.topNode,e=>{if("#text"===e.nodeName&&"wxs"===e.parentNode.nodeName){e.value.replace(bn,(t,r,a,s)=>{const i=_n(this.file.relative),p=r.replace(Pn,En(i)).replace(/['"]/g,"");e.parentNode.attrs.src=p,e.parentNode.childNodes=[],n=1,console.log(`\n编译${t}--\x3erequire(${p})`)})}}),n?t.render():e}),{skipBinary:!1})).pipe(g.restore).pipe(a).pipe(on.replace(/^/,(function(e){return hn.plugin?`var App=function(packInit){};${jn.globalObject}.canIUse=function(){return false};`:`var __packConfig=require('../pack.config.js');var App=function(packInit){var ${ln}=${(""+un).replace(/globalObject/g,jn.globalObject)};${ln}(packInit,__packConfig.packPath,__packConfig.appMode,'${$n}');};`}),{skipBinary:!1})).pipe(a.restore).pipe(e).pipe(u()).pipe(An()).pipe(on.replace(/[\s\S]*/,(function(e){return Nn(e)+e}),{skipBinary:!1})).pipe(e.restore).pipe(s).pipe(on.replace(/^/,(function(e){return"var __uniPluginExports={};\n"}),{skipBinary:!1})).pipe(on.replace(/$/,(function(e){return"\nmodule.exports=__uniPluginExports;"}),{skipBinary:!1})).pipe(s.restore).pipe(i).pipe(on.replace(/^/,(function(e){if(o.existsSync(r.resolve(gn,"src",this.file.relative)))return e;return`require('${En(_n(this.file.relative))}app.js');\n`}),{skipBinary:!1})).pipe(i.restore).pipe(l).pipe(on.replace(/[\s\S]*/,(function(e){if(!o.existsSync(r.resolve(gn,"src",this.file.relative.replace(/json$/,"vue")))&&!o.existsSync(r.resolve(gn,"src",this.file.relative.replace(/json$/,"nvue"))))return e;let t=JSON.parse(""+this.file.contents);for(let e in t.usingComponents)0===t.usingComponents[e].indexOf("/")&&(t.usingComponents[e]=En(_n(this.file.relative))+t.usingComponents[e].replace(/^\//,""));return JSON.stringify(t)}),{skipBinary:!1})).pipe(l.restore).pipe(c).pipe(on.stripCssComments()).pipe(on.replace(wn,(function(e,t,n){let r="",a=_n(this.file.relative);return(n+=";").replace(/\s*import\s*:\s*(('[^\s';]*')|("[^\s";]*"))/g,(function(e,t){const n=RegExp(`(${Cn.join("|")})(['"])$`);t=t.replace(n,jn.css+"$2"),r+=`@import ${t.replace(Pn,En(a))};\n`})),t+r}),{skipBinary:!1})).pipe(c.restore).pipe(p).pipe(on.stripCssComments()).pipe(on.replace(/^[\s\S]*$/,(function(e){if(yn===dn)return e;let t=_n(this.file.relative);return"@import "+`"${kn}/app.${jn.css}";`.replace(Pn,En(t))+("\n"+e)}),{skipBinary:!1})).pipe(p.restore).pipe(on.replace(/[\s\S]*/,Rn(yn),{skipBinary:!1})).pipe(n.dest(yn,{cwd:gn}))}));const Ln=i(),{cwd:Bn,env:Tn,targetPath:Jn,subModePath:qn,regExpWxResources:Wn,regExpUniImportWxss:Fn,wxResourceAlias:In,wxResourcePath:Un,currentNamespace:Kn,mpTypeNamespace:Dn}=_,{writeLastLine:Yn,getLevel:Hn,getLevelPath:zn}=N,{mixinsEnvCode:Vn}=_t,{uniRequireWxResource:Zn}=cn,{runPlugins:Gn}=oe,Qn=[],Xn=[],er=[],tr=new Set,nr=new Set;Object.keys(Dn).forEach(e=>{Qn.push(Dn[e].css),Xn.push(`${Un}/**/*.${Dn[e].css}`),er.push(`${Un}/**/*.${Dn[e].html}`),tr.add("."+Dn[e].css),nr.add("."+Dn[e].html)}),n.task("subMode:copyWxResource",(function(){const e=Ln.filter([Un+"/**/*.js"],{restore:!0}),a=Ln.filter([...Xn],{restore:!0}),s=Ln.filter([...er],{restore:!0});return n.src([Un+"/**",Un],{allowEmpty:!0,cwd:Bn}).pipe(Ln.if("dev"===Tn,Ln.watch([Un+"/**",Un,`!/${Un}/**/*.*___jb_tmp___`],{cwd:Bn},(function(e){Yn("处理"+e.relative+"......")})))).pipe(e).pipe(Ln.replace(/[\s\S]*/,(function(e){return Vn(e)+e}),{skipBinary:!1})).pipe(Ln.replace(/^/,(function(e){return`require('${zn(Hn(this.file.relative))}app.js');\n`}),{skipBinary:!1})).pipe(u()).pipe(Zn()).pipe(e.restore).pipe(a).pipe(Ln.stripCssComments()).pipe(Ln.replace(Fn,(function(e,t,n){let r="";Hn(this.file.relative);return t+r}),{skipBinary:!1})).pipe(Ln.replace(/^[\s\S]*$/,(function(e){if(qn===Jn)return e;let t=Hn(this.file.relative);return"@import "+`"${In}/app.${Kn.css}";`.replace(Wn,zn(t))+("\n"+e)}),{skipBinary:!1})).pipe(Ln.rename((function(e){e.extname="."+Kn.css}))).pipe(a.restore).pipe(s).pipe(Ln.rename((function(e){e.extname="."+Kn.html}))).pipe(s.restore).pipe(Ln.filter((function(e){if("unlink"===e.event){try{let n=e.path;const a=RegExp(e.extname+"$","i");tr.has(e.extname)&&(n=n.replace(a,"."+Kn.css)),nr.has(e.extname)&&(n=n.replace(a,"."+Kn.html)),t.sync([n.replace(r.resolve(Bn,Un),r.resolve(Bn,qn))],{force:!0})}catch(e){}return!1}return!0}))).pipe(Ln.replace(/[\s\S]*/,Gn(qn),{skipBinary:!1})).pipe(n.dest(qn,{cwd:Bn}))}));const rr=i(),{cwd:ar,target:sr,env:ir,projectToSubPackageConfig:pr,currentNamespace:cr,mpTypeNamespace:or}=_,{writeLastLine:lr}=N,{mixinsEnvCode:ur}=_t,{runPlugins:gr}=oe;n.task("watch:native",(function(){const e=pr[cr.mainMpPath],a=[],s=[],i=new Set,p=new Set;Object.keys(or).forEach(t=>{a.push(`${e}/**/*.${or[t].css}`),s.push(`${e}/**/*.${or[t].html}`),i.add("."+or[t].css),p.add("."+or[t].html)});const c=rr.filter([e+"/**/*.js"],{restore:!0}),o=rr.filter([...s],{restore:!0}),l=rr.filter([...a],{restore:!0});return n.src([e+"/**/*","!"+e+"/app.json"],{base:r.resolve(ar,e),allowEmpty:!0,cwd:ar}).pipe(rr.if("dev"===ir,rr.watch([e+"/**/*","!/"+e+"/app.json"],{cwd:ar},(function(e){lr("处理"+e.relative+"......")})))).pipe(rr.filter((function(n){if("unlink"===n.event){try{let a=n.path;const s=RegExp(n.extname+"$","i");i.has(n.extname)&&(a=a.replace(s,"."+cr.css)),p.has(n.extname)&&(a=a.replace(s,"."+cr.html)),t.sync([a.replace(r.resolve(ar,e),r.resolve(ar,sr))],{force:!0})}catch(e){console.log(e)}return!1}return!0}))).pipe(c).pipe(rr.replace(/[\s\S]*/,(function(e){return ur(e)+e}),{skipBinary:!1})).pipe(c.restore).pipe(o).pipe(rr.rename((function(e){e.extname="."+cr.html}))).pipe(o.restore).pipe(l).pipe(rr.rename((function(e){e.extname="."+cr.css}))).pipe(l.restore).pipe(rr.replace(/[\s\S]*/,gr(r.resolve(ar,sr)),{skipBinary:!1})).pipe(n.dest(sr,{cwd:ar}))}));const{cwd:fr,env:hr,targetPath:mr,subModePath:dr,projectToSubPackageConfig:yr,program:vr,currentNamespace:br}=_,{tryAgain:Pr}=N;async function wr(e){let t=r.resolve(fr,yr[br.mainMpPath],"app.js");await o.exists(t)||await o.outputFile(t,"App({});"),e()}n.task("mpWxSubMode",n.series((function(e){console.log("小程序解耦构建开启，此过程如果出现权限问题，请使用管理员权限运行"),e()}),"clean:previewDist",(async function e(t){if(vr.plugin||vr.native)t();else{try{let e={packPath:(yr.subPackagePath?"/":"")+yr.subPackagePath,appMode:yr.appMode};await o.outputFile(dr+"/pack.config.js","module.exports="+JSON.stringify(e,null,4))}catch(n){return void await Pr(async()=>{await e(t)})}t()}}),function(){let e=[wr,"subMode:createUniSubPackage","subMode:copyWxResource",...vr.plugin?["watch:pluginJson"]:["watch:baseAppJson","watch:pagesJson",...yr.mergePack?["watch:mainWeixinMpPackPath"]:[],...dr===mr?["watch:topMode-mainAppJsAndAppWxss"]:[]],"watch:mainAppJson","watch:mainWeixinMp","watch:projectConfigJson"];return vr.native&&(e=[wr,"watch:mainAppJson","watch:native"]),"build"===hr?n.series.apply(this,e):n.parallel.apply(this,e)}(),(function(e){e(),"build"===hr&&process.exit()})));const{cwd:kr,basePath:jr,base:xr,program:$r}=_;n.task("startToPackServe",n.series((async function(e){$r.native||await o.exists(jr)||await o.mkdirs(jr),e()}),"clean:base",(function(e){$r.native?e():n.watch(xr+"/app.json",{events:["all"],cwd:kr},(function(){e()}))}),"mpWxSubMode")),process.on("unhandledRejection",()=>{});
