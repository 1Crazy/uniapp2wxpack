!function(){const e=require("gulp"),s=require("del"),r=require("gulp-load-plugins")(),t=require("path"),a=require("fs-extra"),n=require("strip-json-comments"),i=require("gulp-strip-comments"),o=require("single-line-log").stdout,{program:c}=require("commander");c.option("--scope <type>","运行目录",process.cwd()),c.parse(process.argv);const p=c.scope,u=require(t.resolve(p,"./projectToSubPackageConfig"));process.on("unhandledRejection",(e,s)=>{});let l="dev";"production"===process.env.NODE_ENV&&(l="build");const f="dist/"+l+"/mp-weixin",m="dist/"+l+"/mp-weixin-pack",w=t.resolve(p,f),g=t.resolve(p,m,u.subPackagePath),d=t.resolve(p,m);let h;function y(e){o(e),clearTimeout(h),h=setTimeout(()=>{o("解耦构建，正在监听中......(此过程如果出现权限问题，请使用管理员权限运行)")},300)}async function v(e){return new Promise(async s=>{setTimeout(async()=>{s(await e())},100)})}function x(e){return Array(e).fill("../").join("")}function k(e){return e.split(/[\\/]/).length-1}function b(){return r.replace(/__uniRequireWx\(([a-zA-Z.\/"'@\d]+)\)/g,(function(e,s,r,t){let a=k(this.file.relative);return console.log(`\n编译${e}--\x3erequire(${s.replace(/@wxResource\//g,x(a))})`),`require(${s.replace(/@wxResource\//g,x(a))})`}),{skipBinary:!1})}function P(e){return y("处理app.json......"),r.replace(/[\s\S]+/,(function(s){let r,i,o,c={};({pagesJson(){try{r=JSON.parse(n(s))}catch(e){r={}}},baseAppJson(){try{i=JSON.parse(s)}catch(e){i={}}},mainAppJson(){try{o=JSON.parse(s)}catch(e){o={}}}})[e]();try{r||(r=JSON.parse(n(a.readFileSync(t.resolve(p,"src/pages.json"),"utf8"))))}catch(e){r={}}try{i||(i=JSON.parse(a.readFileSync(t.resolve(p,f+"/app.json"),"utf8")))}catch(e){i={}}try{o||(o=JSON.parse(a.readFileSync(t.resolve(p,u.mainWeixinMpPath+"/app.json"),"utf8")))}catch(e){o={}}function l(e){return u.subPackagePath+"/"+e}if(o.subPackages){let e=o.subPackages.find(e=>e.root===u.subPackagePath);if(e){let s=[...r.wxResource&&r.wxResource.pages||[],...i.pages||[]];return i.subPackages&&i.subPackages.forEach(e=>{s=[...s,...(e.pages||[]).map(s=>e.root+"/"+s)]}),r.wxResource&&r.wxResource.subPackages&&r.wxResource.subPackages.forEach(e=>{s=[...s,...(e.pages||[]).map(s=>e.root+"/"+s)]}),e.pages=s,delete i.pages,delete i.subPackages,JSON.stringify({...i,...o},null,2)}}if(i.pages&&i.pages.forEach((e,s)=>{i.pages[s]=l(e)}),i.subPackages&&i.subPackages.forEach(e=>{e.root=l(e.root)}),r.wxResource&&(r.wxResource.pages&&r.wxResource.pages.forEach((e,s)=>{r.wxResource.pages[s]=l(e)}),r.wxResource.subPackages&&r.wxResource.subPackages.forEach(e=>{e.root=l(e.root)})),i.tabBar&&i.tabBar.list&&i.tabBar.list.forEach(({pagePath:e,iconPath:s,selectedIconPath:r,...t},a)=>{i.tabBar.list[a]={pagePath:e?l(e):"",iconPath:s?l(s):"",selectedIconPath:r?l(r):"",...t}}),c={...i,...o},c.pages=Array.from(new Set([...r.indexPage?[l(r.indexPage)]:[],...o.pages||[],...i.pages||[],...r.wxResource&&r.wxResource.pages||[]])),c.subPackages=[...r.wxResource&&r.wxResource.subPackages||[],...i.subPackages||[],...o.subPackages||[]],i.usingComponents){for(let e in i.usingComponents)i.usingComponents[e]="/"+u.subPackagePath+i.usingComponents[e];c.usingComponents={...c.usingComponents||{},...i.usingComponents}}return JSON.stringify(c,null,2)}),{skipBinary:!1})}e.task("clean:base",(async function e(r){try{await s([w+"/**/*"],{force:!0})}catch(s){return void await v(async()=>{await e(r)})}r()})),e.task("clean:subModePath",(async function e(r){try{await s([g+"/**/*"],{force:!0})}catch(s){return void await v(async()=>{await e(r)})}r()})),e.task("clean:previewDist",(async function e(r){try{await s([d+"/**/*"],{force:!0})}catch(s){return void await v(async()=>{await e(r)})}r()})),e.task("watch:pagesJson",(function(){return e.src("src/pages.json",{allowEmpty:!0,cwd:p}).pipe(r.if("dev"===l,r.watch("src/pages.json",{cwd:p},(function(e){y("处理"+e.relative+"......")})))).pipe(P("pagesJson")).pipe(r.rename("app.json")).pipe(e.dest(m,{cwd:p}))})),e.task("watch:baseAppJson",(function(){return e.src(f+"/app.json",{allowEmpty:!0,cwd:p}).pipe(r.if("dev"===l,r.watch(f+"/app.json",{cwd:p},(function(e){y("处理"+e.relative+"......")})))).pipe(P("baseAppJson")).pipe(e.dest(m,{cwd:p}))})),e.task("watch:mainAppJson",(function(){let s=u.mainWeixinMpPath;return e.src(s+"/app.json",{allowEmpty:!0,cwd:p}).pipe(r.if("dev"===l,r.watch(s+"/app.json",{cwd:p},(function(e){y("处理"+e.relative+"......")})))).pipe(P("mainAppJson")).pipe(e.dest(m,{cwd:p}))})),e.task("watch:mainWeixinMp",(function(){let a=u.mainWeixinMpPath,n=a+"/"+u.subPackagePath,i=r.filter([a+"/app.js"],{restore:!0});return e.src([a+"/**/*","!"+a+"/app.json","!"+a+"/**/*.json___jb_tmp___","!"+a+"/**/*.wxml___jb_tmp___","!"+a+"/**/*.wxss___jb_tmp___","!"+a+"/**/*.js___jb_tmp___","!"+n+"/**/*"],{base:t.resolve(p,a),allowEmpty:!0,cwd:p}).pipe(r.if("dev"===l,r.watch([a+"/**/*","!/"+a+"/app.json","!/"+n+"/**/*"],{cwd:p},(function(e){y("处理"+e.relative+"......")})))).pipe(r.filter((async function(e){if("unlink"===e.event){try{await s([e.path.replace(t.resolve(p,a),t.resolve(p,m))],{force:!0})}catch(e){}return!1}return!0}))).pipe(i).pipe(r.replace(/^/,(function(e){let s=`./${u.subPackagePath}/`;return`require('${s}common/runtime.js');\nrequire('${s}common/vendor.js');\nrequire('${s}common/main.js');\n`}),{skipBinary:!1})).pipe(i.restore).pipe(e.dest(m,{cwd:p}))})),e.task("subMode:createUniSubPackage",(async function(n){await a.mkdirs(w);let o=r.filter([f+"/common/vendor.js",f+"/common/main.js",f+"/common/runtime.js",f+"/pages/**/*.js"],{restore:!0}),c=r.filter([f+"/common/vendor.js"],{restore:!0}),u=r.filter([f+"/**/*.js","!"+f+"/common/vendor.js","!"+f+"/common/main.js","!"+f+"/common/runtime.js"],{restore:!0}),m=r.filter([f+"/**/*.wxss"],{restore:!0}),d=r.filter([f+"/**/*.json"],{restore:!0});return e.src([f+"/**",f,"!"+f+"/*.*"],{allowEmpty:!0,cwd:p}).pipe(r.if("dev"===l,r.watch([f+"/**",f,"!/"+f+"/*.*"],{cwd:p},(function(e){y("处理"+e.relative+"......")})))).pipe(r.filter((async function(e){if("unlink"===e.event){try{await s([e.path.replace(w,t.resolve(p,g))],{force:!0})}catch(e){}return!1}return!0}))).pipe(c).pipe(r.replace(/^/,"let App=function(){};",{skipBinary:!1})).pipe(c.restore).pipe(o).pipe(i()).pipe(b()).pipe(o.restore).pipe(u).pipe(r.replace(/^/,(function(e){if(a.existsSync(t.resolve(p,"src",this.file.relative)))return e;let s=x(k(this.file.relative));return`require('${s}common/runtime.js');\nrequire('${s}common/vendor.js');\nrequire('${s}common/main.js');\n`}),{skipBinary:!1})).pipe(u.restore).pipe(d).pipe(r.replace(/[\s\S]*/,(function(e){if(!a.existsSync(t.resolve(p,"src",this.file.relative.replace(/json$/,"vue")))&&!a.existsSync(t.resolve(p,"src",this.file.relative.replace(/json$/,"nvue"))))return e;let s=JSON.parse(this.file.contents.toString());for(let e in s.usingComponents)0===s.usingComponents[e].indexOf("/")&&(s.usingComponents[e]=x(k(this.file.relative))+s.usingComponents[e].replace(/^\//,""));return JSON.stringify(s)}),{skipBinary:!1})).pipe(d.restore).pipe(m).pipe(r.replace(/(}|^|\s)__uniWxss\s*{([^{}]+)}/g,(function(e,s,r){let t="",a=k(this.file.relative);return(r+";").replace(/\s*import\s*:\s*([^\s]*;)/g,(function(e,s){t+=`@import ${s.replace(/@wxResource\//g,x(a))}`})),s+t}),{skipBinary:!1})).pipe(r.replace(/^[\s\S]*$/,(function(e){let s=k(this.file.relative),r=`@import ${'"@wxResource/common/main.wxss";'.replace(/@wxResource\//g,x(s))}`,t=`\n${e}`;return this.file.relative.match(/^common[\\/]+main.wxss/i)||(t=r+t),t}),{skipBinary:!1})).pipe(m.restore).pipe(e.dest(g,{cwd:p}))})),e.task("subMode:copyWxResource",(function(){let a=r.filter(["src/wxresource/**/*.js"],{restore:!0});return e.src(["src/wxresource/**","src/wxresource"],{allowEmpty:!0,cwd:p}).pipe(r.if("dev"===l,r.watch(["src/wxresource/**","src/wxresource","!src/wxresource/**/*.*___jb_tmp___"],{cwd:p},(function(e){y("处理"+e.relative+"......")})))).pipe(a).pipe(i()).pipe(b()).pipe(a.restore).pipe(r.filter((async function(e){if("unlink"===e.event){try{await s([e.path.replace(t.resolve(p,"src/wxresource"),t.resolve(p,g))],{force:!0})}catch(e){}return!1}return!0}))).pipe(e.dest(g,{cwd:p}))})),e.task("mpWxSubMode",e.series((function(e){console.log("对uni-app进行解耦构建，解除uni-app对原生小程序方法的改写，此过程如果出现权限问题，请使用管理员权限运行"),e()}),"clean:previewDist",(async function e(s){try{await a.outputFile(g+"/pack.config.js",`module.exports={packPath:'/${u.subPackagePath}'}`)}catch(r){return void await v(async()=>{await e(s)})}s()}),function(){let s=["subMode:createUniSubPackage","subMode:copyWxResource","watch:baseAppJson","watch:pagesJson","watch:mainAppJson","watch:mainWeixinMp"];return"build"===l?e.series.apply(this,s):e.parallel.apply(this,s)}(),(function(e){e(),"build"===l&&process.exit()}))),e.task("startToPackServe",e.series((async function(e){await a.exists(w)||await a.mkdirs(w),e()}),"clean:base",(function(s){e.watch(f+"/app.json",{events:["all"],cwd:p},(function(){s()}))}),"mpWxSubMode"))}();